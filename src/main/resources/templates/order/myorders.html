<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>ì£¼ë¬¸ ë‚´ì—­ | AuGold</title>
    <!-- SweetAlert2 CDN ì¶”ê°€ -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap');

        body {
          font-family: 'Nunito', sans-serif;
          background-color: #f9fafb;
          color: #333;
          margin: 0;
          padding: 20px;
        }

        header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding-bottom: 12px;
          border-bottom: 1px solid #ddd;
          margin-bottom: 30px;
        }

        header h1 a {
          text-decoration: none;
          color: #2c3e50;
          font-weight: 700;
          font-size: 1.8rem;
        }

        nav a {
          color: #4a4a4a;
          margin-left: 20px;
          font-weight: 600;
          text-decoration: none;
          transition: color 0.3s ease;
        }

        nav a:hover {
          color: #3498db;
        }

        .container {
          max-width: 1000px;
          margin: 0 auto;
        }

        .page-header {
          background: #fff;
          padding: 30px 40px;
          border-radius: 8px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          margin-bottom: 30px;
        }

        .page-header h2 {
          font-weight: 700;
          font-size: 2rem;
          margin: 0;
          color: #2c3e50;
        }

        .page-header p {
          margin: 8px 0 0 0;
          color: #666;
        }

        .order-list {
          display: flex;
          flex-direction: column;
          gap: 20px;
        }

        .order-card {
          background: #fff;
          border-radius: 8px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          overflow: hidden;
          transition: transform 0.2s ease;
        }

        .order-card:hover {
          transform: translateY(-2px);
        }

        .order-header {
          padding: 20px 30px;
          border-bottom: 1px solid #eee;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .order-number {
          font-weight: 700;
          color: #2c3e50;
          font-size: 1.1rem;
        }

        .order-date {
          color: #666;
          font-size: 0.9rem;
        }

        .order-status {
          padding: 4px 12px;
          border-radius: 12px;
          font-size: 0.8rem;
          font-weight: 600;
        }

        .status-paid { background: #d1fae5; color: #065f46; }
        .status-preparing { background: #dbeafe; color: #1e40af; }
        .status-shipped { background: #e0e7ff; color: #5b21b6; }
        .status-delivered { background: #dcfce7; color: #166534; }
        .status-cancelled { background: #fee2e2; color: #991b1b; }

        .order-content {
          padding: 20px 30px;
          display: flex;
          align-items: center;
          gap: 20px;
        }

        .product-image {
          width: 80px;
          height: 80px;
          border-radius: 8px;
          object-fit: cover;
          background: #f3f4f6;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 2rem;
        }

        .order-details {
          flex: 1;
        }

        .product-name {
          font-weight: 600;
          color: #2c3e50;
          margin-bottom: 4px;
        }

        .product-summary {
          color: #666;
          font-size: 0.9rem;
        }

        .order-price {
          text-align: right;
        }

        .price-amount {
          font-weight: 700;
          font-size: 1.3rem;
          color: #2c3e50;
        }

        .order-actions {
          padding: 20px 30px;
          border-top: 1px solid #eee;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .btn {
          padding: 8px 16px;
          border-radius: 5px;
          font-weight: 600;
          font-size: 0.9rem;
          text-decoration: none;
          border: none;
          cursor: pointer;
          transition: all 0.2s ease;
        }

        .btn-primary {
          background-color: #3498db;
          color: white;
        }

        .btn-primary:hover {
          background-color: #2980b9;
        }

        .btn-danger {
          background-color: #e74c3c;
          color: white;
        }

        .btn-danger:hover {
          background-color: #c0392b;
        }

        .btn-secondary {
          background-color: #95a5a6;
          color: white;
        }

        .empty-state {
          text-align: center;
          padding: 60px 20px;
          background: #fff;
          border-radius: 8px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .empty-state img {
          width: 120px;
          opacity: 0.6;
          margin-bottom: 20px;
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ - ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜ */
        .modal {
          display: none;
          position: fixed;
          z-index: 1000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0,0,0,0.5);
          opacity: 0;
          transition: opacity 0.3s ease;
        }

        .modal-content {
          background-color: #fff;
          margin: 5% auto;
          padding: 30px;
          border-radius: 8px;
          width: 90%;
          max-width: 800px;
          max-height: 80vh;
          overflow-y: auto;
          transform: translateY(-20px);
          transition: transform 0.3s ease;
        }

        .modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
          padding-bottom: 15px;
          border-bottom: 1px solid #eee;
        }

        .close {
          color: #aaa;
          font-size: 28px;
          font-weight: bold;
          cursor: pointer;
        }

        .close:hover {
          color: #000;
        }

        .detail-item {
          display: flex;
          align-items: center;
          padding: 15px 0;
          border-bottom: 1px solid #f0f0f0;
        }

        .detail-item:last-child {
          border-bottom: none;
        }

        .detail-image {
          width: 60px;
          height: 60px;
          border-radius: 6px;
          object-fit: cover;
          background: #f3f4f6;
          margin-right: 15px;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .detail-info {
          flex: 1;
        }

        .detail-price {
          text-align: right;
          font-weight: 600;
        }

        .total-price {
          font-size: 1.2rem;
          font-weight: 700;
          color: #2c3e50;
          text-align: right;
          padding-top: 15px;
          border-top: 2px solid #eee;
          margin-top: 15px;
        }
    </style>
</head>
<body>
<header>
    <h1><a href="/">AuGold</a></h1>
    <nav>
        <a href="/">ë©”ì¸</a>
        <a href="/mypage">ë§ˆì´í˜ì´ì§€</a>
        <a href="/cart">ì¥ë°”êµ¬ë‹ˆ</a>
        <a href="/logout">ë¡œê·¸ì•„ì›ƒ</a>
    </nav>
</header>

<div class="container">
    <div class="page-header">
        <h2>ì£¼ë¬¸ ë‚´ì—­</h2>
        <p th:text="${customerName} + 'ë‹˜ì˜ ì£¼ë¬¸ ë‚´ì—­ì…ë‹ˆë‹¤'">ê³ ê°ë‹˜ì˜ ì£¼ë¬¸ ë‚´ì—­ì…ë‹ˆë‹¤</p>
    </div>

    <!-- ì£¼ë¬¸ì´ ì—†ëŠ” ê²½ìš° -->
    <div th:if="${#lists.isEmpty(orders)}" class="empty-state">
        <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ“¦</div>
        <h3>ì•„ì§ ì£¼ë¬¸í•œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</h3>
        <p>AuGoldì˜ í”„ë¦¬ë¯¸ì—„ ê³¨ë“œ ì œí’ˆì„ ë‘˜ëŸ¬ë³´ì„¸ìš”!</p>
        <a href="/product/list" class="btn btn-primary" style="margin-top: 20px;">ìƒí’ˆ ë‘˜ëŸ¬ë³´ê¸°</a>
    </div>

    <!-- ì£¼ë¬¸ ëª©ë¡ -->
    <div th:if="${!#lists.isEmpty(orders)}" class="order-list">
        <div th:each="order, iterStat : ${orders}" class="order-card">
            <!-- ì£¼ë¬¸ í—¤ë” -->
            <div class="order-header">
                <div>
                    <div class="order-date" th:text="${#temporals.format(order.orderDate, 'yyyy.MM.dd HH:mm')}">2025.01.22 15:30</div>
                </div>
                <div th:switch="${order.orderStatus.name()}">
                    <span th:case="'PAID'" class="order-status status-paid" th:text="${order.orderStatus.description}">ê²°ì œì™„ë£Œ</span>
                    <span th:case="'PREPARING'" class="order-status status-preparing" th:text="${order.orderStatus.description}">ìƒí’ˆì¤€ë¹„ì¤‘</span>
                    <span th:case="'SHIPPED'" class="order-status status-shipped" th:text="${order.orderStatus.description}">ë°°ì†¡ì¤‘</span>
                    <span th:case="'DELIVERED'" class="order-status status-delivered" th:text="${order.orderStatus.description}">ë°°ì†¡ì™„ë£Œ</span>
                    <span th:case="'CANCELLED'" class="order-status status-cancelled" th:text="${order.orderStatus.description}">ì·¨ì†Œ</span>
                    <span th:case="'REFUNDED'" class="order-status status-cancelled" th:text="${order.orderStatus.description}">í™˜ë¶ˆì™„ë£Œ</span>
                    <span th:case="*" class="order-status" th:text="${order.orderStatus.description}">ê¸°íƒ€</span>
                </div>
            </div>

            <!-- ì£¼ë¬¸ ë‚´ìš© -->
            <div class="order-content">
                <!-- ì´ë¯¸ì§€ í‘œì‹œ -->
                <div class="product-image">
        <span th:if="${order.orderItems != null and !#lists.isEmpty(order.orderItems) and order.orderItems[0].imageUrl != null}">
            <img th:src="${order.orderItems[0].imageUrl}"
                 th:alt="${order.orderItems[0].productName}"
                 style="width: 100%; height: 100%; object-fit: cover;">
        </span>
                    <span th:unless="${order.orderItems != null and !#lists.isEmpty(order.orderItems) and order.orderItems[0].imageUrl != null}">ğŸ’</span>
                </div>

                <div class="order-details">
                    <!-- ìƒí’ˆëª… í‘œì‹œ (ìƒí’ˆID ëŒ€ì‹ ) -->
                    <div class="product-name" th:if="${order.orderItems != null and #lists.size(order.orderItems) == 1}"
                         th:text="${order.orderItems[0].productName}">18K ê³¨ë“œ ë°˜ì§€</div>
                    <div class="product-name" th:if="${order.orderItems != null and #lists.size(order.orderItems) > 1}"
                         th:text="${order.orderItems[0].productName} + ' ì™¸ ' + (${#lists.size(order.orderItems)} - 1) + 'ì¢…'">18K ê³¨ë“œ ë°˜ì§€ ì™¸ 2ì¢…</div>
                    <div class="product-summary" th:text="'ì´ ' + ${order.totalItemCount} + 'ê°œ ìƒí’ˆ'">ì´ 3ê°œ ìƒí’ˆ</div>
                </div>

                <div class="order-price">
                    <div class="price-amount" th:text="'â‚©' + ${#numbers.formatInteger(order.finalAmount, 3, 'COMMA')}">â‚©1,250,000</div>
                </div>
            </div>

            <!-- ì£¼ë¬¸ ì•¡ì…˜ -->
            <div class="order-actions">
                <div>
                    <button class="btn btn-primary"
                            th:data-order-number="${order.orderNumber}"
                            onclick="showOrderDetail(this.dataset.orderNumber)">ìƒì„¸ë³´ê¸°</button>

                    <button th:if="${order.isCancellable()}"
                            class="btn btn-danger"
                            th:data-order-number="${order.orderNumber}"
                            onclick="cancelOrder(this.dataset.orderNumber)">ì£¼ë¬¸ ì·¨ì†Œ</button>
                </div>
                <div>
                    <span th:if="${order.orderStatus.name() == 'DELIVERED'}" class="btn btn-secondary">ë¦¬ë·° ì‘ì„±</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì£¼ë¬¸ ìƒì„¸ ëª¨ë‹¬ -->
<div id="orderDetailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ì£¼ë¬¸ ìƒì„¸ ì •ë³´</h2>
            <span class="close">&times;</span>
        </div>
        <div id="orderDetailContent">
            <!-- ìƒì„¸ ë‚´ìš©ì´ ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
        </div>
    </div>
</div>

<script>
    // í˜ì´ì§€ ë¡œë“œ ì‹œ URL íŒŒë¼ë¯¸í„° í™•ì¸í•˜ì—¬ ì„±ê³µ/ì‹¤íŒ¨ ë©”ì‹œì§€ í‘œì‹œ
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);

        // ì£¼ë¬¸ ì·¨ì†Œ ì„±ê³µ
        if (urlParams.get('cancelled') === 'true') {
            const orderNumber = urlParams.get('orderNumber');
            Swal.fire({
                title: 'ì£¼ë¬¸ ì·¨ì†Œ ì™„ë£Œ!',
                text: 'ì£¼ë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.',
                icon: 'success',
                confirmButtonText: 'í™•ì¸',
                confirmButtonColor: '#3498db',
                timer: 3000,
                timerProgressBar: true
            });
        }

        // ì£¼ë¬¸ ì·¨ì†Œ ì‹¤íŒ¨
        if (urlParams.get('error') === 'cancel') {
            const message = urlParams.get('message') || 'ì£¼ë¬¸ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            Swal.fire({
                title: 'ì£¼ë¬¸ ì·¨ì†Œ ì‹¤íŒ¨',
                text: decodeURIComponent(message),
                icon: 'error',
                confirmButtonText: 'í™•ì¸',
                confirmButtonColor: '#e74c3c'
            });
        }

        // ì‹œìŠ¤í…œ ì˜¤ë¥˜
        if (urlParams.get('error') === 'system') {
            Swal.fire({
                title: 'ì‹œìŠ¤í…œ ì˜¤ë¥˜',
                text: 'ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
                icon: 'error',
                confirmButtonText: 'í™•ì¸',
                confirmButtonColor: '#e74c3c'
            });
        }
    });

    // ì£¼ë¬¸ ìƒì„¸ë³´ê¸° - ë¶€ë“œëŸ¬ìš´ ëª¨ë‹¬
    function showOrderDetail(orderNumber) {
        // JSON API í˜¸ì¶œ (ë¡œë”© ìŠ¤í”¼ë„ˆ ì—†ì´)
        fetch(`/order/api/${orderNumber}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ì‹¤ì œ ì£¼ë¬¸ ë°ì´í„°ë¡œ ëª¨ë‹¬ ë‚´ìš© ìƒì„±
                    const order = data.order;
                    let orderItemsHtml = '';

                    // ì£¼ë¬¸ ìƒí’ˆë“¤ HTML ìƒì„±
                    if (order.orderItems && order.orderItems.length > 0) {
                        order.orderItems.forEach(item => {
                            // ì‹¤ì œ ìƒí’ˆ ì´ë¯¸ì§€ ì²˜ë¦¬
                            let imageHtml;
                            if (item.imageUrl) {
                                imageHtml = `<img src="${item.imageUrl}" alt="${item.productName}" style="width: 100%; height: 100%; object-fit: cover;">`;
                            } else {
                                imageHtml = 'ğŸ’'; // ì´ë¯¸ì§€ê°€ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ ì´ëª¨ì§€
                            }

                            orderItemsHtml += `
                                <div class="detail-item">
                                    <div class="detail-image">${imageHtml}</div>
                                    <div class="detail-info">
                                        <div><strong>${item.productName || 'ìƒí’ˆëª… ì—†ìŒ'}</strong></div>
                                        <div>ìˆ˜ëŸ‰: ${item.quantity}ê°œ</div>
                                        <div>ë‹¨ê°€: â‚©${item.unitPrice.toLocaleString()}</div>
                                    </div>
                                    <div class="detail-price">â‚©${item.finalAmount.toLocaleString()}</div>
                                </div>
                            `;
                        });
                    } else {
                        orderItemsHtml = '<div class="detail-item">ì£¼ë¬¸ ìƒí’ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                    }

                    // ëª¨ë‹¬ ë‚´ìš© ì„¤ì •
                    document.getElementById('orderDetailContent').innerHTML = `
                        <div style="padding: 20px;">
                            <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                                <h3>ì£¼ë¬¸ë²ˆí˜¸: ${order.orderNumber}</h3>
                                <p>ì£¼ë¬¸ì¼ì‹œ: ${new Date(order.orderDate).toLocaleString('ko-KR')}</p>
                                <p>ì£¼ë¬¸ìƒíƒœ: <span class="order-status">${order.orderStatus.description}</span></p>
                                <p>ë°°ì†¡ì£¼ì†Œ: ${order.deliveryAddr}</p>
                                <p>ë°°ì†¡ì—°ë½ì²˜: ${order.deliveryPhone}</p>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <h4>ì£¼ë¬¸ ìƒí’ˆ</h4>
                                ${orderItemsHtml}
                            </div>

                            <div class="total-price">
                                <div>ì´ ì£¼ë¬¸ê¸ˆì•¡: â‚©${order.totalAmount.toLocaleString()}</div>
                                <div style="font-size: 1.2rem; margin-top: 5px;">
                                    <strong>ìµœì¢… ê²°ì œê¸ˆì•¡: â‚©${order.finalAmount.toLocaleString()}</strong>
                                </div>
                            </div>
                        </div>
                    `;

                    // ëª¨ë‹¬ ë¶€ë“œëŸ½ê²Œ í‘œì‹œ
                    const modal = document.getElementById('orderDetailModal');
                    const modalContent = modal.querySelector('.modal-content');

                    modal.style.display = 'block';
                    modal.style.opacity = '0';
                    modalContent.style.transform = 'translateY(-20px)';

                    // ì•½ê°„ì˜ ì§€ì—° í›„ í˜ì´ë“œì¸
                    setTimeout(() => {
                        modal.style.opacity = '1';
                        modalContent.style.transform = 'translateY(0)';
                    }, 10);

                } else {
                    // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                    Swal.fire({
                        title: 'ì£¼ë¬¸ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨',
                        text: data.message || 'ì£¼ë¬¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
                        icon: 'error',
                        confirmButtonText: 'í™•ì¸',
                        confirmButtonColor: '#e74c3c'
                    });
                }
            })
            .catch(error => {
                console.error('ì£¼ë¬¸ ìƒì„¸ ì¡°íšŒ ì˜¤ë¥˜:', error);

                Swal.fire({
                    title: 'ì˜¤ë¥˜ ë°œìƒ',
                    text: 'ì£¼ë¬¸ ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
                    icon: 'error',
                    confirmButtonText: 'í™•ì¸',
                    confirmButtonColor: '#e74c3c'
                });
            });
    }

    // ì£¼ë¬¸ ì·¨ì†Œ - SweetAlert2 ì ìš©
    function cancelOrder(orderNumber) {
        Swal.fire({
            title: 'ì£¼ë¬¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
            text: 'ì·¨ì†Œëœ ì£¼ë¬¸ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#e74c3c',
            cancelButtonColor: '#95a5a6',
            confirmButtonText: 'ì·¨ì†Œí•˜ê¸°',
            cancelButtonText: 'ì•„ë‹ˆìš”',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                // ì·¨ì†Œ ì²˜ë¦¬ ì¤‘ ë¡œë”© í‘œì‹œ
                Swal.fire({
                    title: 'ì£¼ë¬¸ ì·¨ì†Œ ì¤‘...',
                    text: 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showConfirmButton: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // í¼ ìƒì„± ë° ì „ì†¡
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/order/${orderNumber}/cancel`;

                const reasonInput = document.createElement('input');
                reasonInput.type = 'hidden';
                reasonInput.name = 'cancelReason';
                reasonInput.value = 'ê³ ê° ìš”ì²­';
                form.appendChild(reasonInput);

                document.body.appendChild(form);
                form.submit();
            }
        });
    }

    // ëª¨ë‹¬ ë¶€ë“œëŸ½ê²Œ ë‹«ê¸°
    function closeModal() {
        const modal = document.getElementById('orderDetailModal');
        const modalContent = modal.querySelector('.modal-content');

        modal.style.opacity = '0';
        modalContent.style.transform = 'translateY(-20px)';

        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }

    // ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸
    document.getElementsByClassName('close')[0].onclick = closeModal;

    window.onclick = function(event) {
        const modal = document.getElementById('orderDetailModal');
        if (event.target == modal) {
            closeModal();
        }
    }

    // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const modal = document.getElementById('orderDetailModal');
            if (modal.style.display === 'block') {
                closeModal();
            }
        }
    });
</script>
</body>
</html>