<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>주문 내역 | AuGold</title>
    <!-- SweetAlert2 CDN 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap');

        body {
          font-family: 'Nunito', sans-serif;
          background-color: #f9fafb;
          color: #333;
          margin: 0;
          padding: 20px;
        }

        header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding-bottom: 12px;
          border-bottom: 1px solid #ddd;
          margin-bottom: 30px;
        }

        header h1 a {
          text-decoration: none;
          color: #2c3e50;
          font-weight: 700;
          font-size: 1.8rem;
        }

        nav a {
          color: #4a4a4a;
          margin-left: 20px;
          font-weight: 600;
          text-decoration: none;
          transition: color 0.3s ease;
        }

        nav a:hover {
          color: #3498db;
        }

        .container {
          max-width: 1000px;
          margin: 0 auto;
        }

        .page-header {
          background: #fff;
          padding: 30px 40px;
          border-radius: 8px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          margin-bottom: 30px;
        }

        .page-header h2 {
          font-weight: 700;
          font-size: 2rem;
          margin: 0;
          color: #2c3e50;
        }

        .page-header p {
          margin: 8px 0 0 0;
          color: #666;
        }

        .order-list {
          display: flex;
          flex-direction: column;
          gap: 20px;
        }

        .order-card {
          background: #fff;
          border-radius: 8px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          overflow: hidden;
          transition: transform 0.2s ease;
        }

        .order-card:hover {
          transform: translateY(-2px);
        }

        .order-header {
          padding: 20px 30px;
          border-bottom: 1px solid #eee;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .order-number {
          font-weight: 700;
          color: #2c3e50;
          font-size: 1.1rem;
        }

        .order-date {
          color: #666;
          font-size: 0.9rem;
        }

        .order-status {
          padding: 4px 12px;
          border-radius: 12px;
          font-size: 0.8rem;
          font-weight: 600;
        }

        .status-paid { background: #d1fae5; color: #065f46; }
        .status-preparing { background: #dbeafe; color: #1e40af; }
        .status-shipped { background: #e0e7ff; color: #5b21b6; }
        .status-delivered { background: #dcfce7; color: #166534; }
        .status-cancelled { background: #fee2e2; color: #991b1b; }

        .order-content {
          padding: 20px 30px;
          display: flex;
          align-items: center;
          gap: 20px;
        }

        .product-image {
          width: 80px;
          height: 80px;
          border-radius: 8px;
          object-fit: cover;
          background: #f3f4f6;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 2rem;
        }

        .order-details {
          flex: 1;
        }

        .product-name {
          font-weight: 600;
          color: #2c3e50;
          margin-bottom: 4px;
        }

        .product-summary {
          color: #666;
          font-size: 0.9rem;
        }

        .order-price {
          text-align: right;
        }

        .price-amount {
          font-weight: 700;
          font-size: 1.3rem;
          color: #2c3e50;
        }

        .order-actions {
          padding: 20px 30px;
          border-top: 1px solid #eee;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .btn {
          padding: 8px 16px;
          border-radius: 5px;
          font-weight: 600;
          font-size: 0.9rem;
          text-decoration: none;
          border: none;
          cursor: pointer;
          transition: all 0.2s ease;
        }

        .btn-primary {
          background-color: #3498db;
          color: white;
        }

        .btn-primary:hover {
          background-color: #2980b9;
        }

        .btn-danger {
          background-color: #e74c3c;
          color: white;
        }

        .btn-danger:hover {
          background-color: #c0392b;
        }

        .btn-secondary {
          background-color: #95a5a6;
          color: white;
        }

        .empty-state {
          text-align: center;
          padding: 60px 20px;
          background: #fff;
          border-radius: 8px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .empty-state img {
          width: 120px;
          opacity: 0.6;
          margin-bottom: 20px;
        }

        /* 모달 스타일 - 부드러운 애니메이션 */
        .modal {
          display: none;
          position: fixed;
          z-index: 1000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0,0,0,0.5);
          opacity: 0;
          transition: opacity 0.3s ease;
        }

        .modal-content {
          background-color: #fff;
          margin: 5% auto;
          padding: 30px;
          border-radius: 8px;
          width: 90%;
          max-width: 800px;
          max-height: 80vh;
          overflow-y: auto;
          transform: translateY(-20px);
          transition: transform 0.3s ease;
        }

        .modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
          padding-bottom: 15px;
          border-bottom: 1px solid #eee;
        }

        .close {
          color: #aaa;
          font-size: 28px;
          font-weight: bold;
          cursor: pointer;
        }

        .close:hover {
          color: #000;
        }

        .detail-item {
          display: flex;
          align-items: center;
          padding: 15px 0;
          border-bottom: 1px solid #f0f0f0;
        }

        .detail-item:last-child {
          border-bottom: none;
        }

        .detail-image {
          width: 60px;
          height: 60px;
          border-radius: 6px;
          object-fit: cover;
          background: #f3f4f6;
          margin-right: 15px;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .detail-info {
          flex: 1;
        }

        .detail-price {
          text-align: right;
          font-weight: 600;
        }

        .total-price {
          font-size: 1.2rem;
          font-weight: 700;
          color: #2c3e50;
          text-align: right;
          padding-top: 15px;
          border-top: 2px solid #eee;
          margin-top: 15px;
        }
    </style>
</head>
<body>
<header>
    <h1><a href="/">AuGold</a></h1>
    <nav>
        <a href="/">메인</a>
        <a href="/mypage">마이페이지</a>
        <a href="/cart">장바구니</a>
        <a href="/logout">로그아웃</a>
    </nav>
</header>

<div class="container">
    <div class="page-header">
        <h2>주문 내역</h2>
        <p th:text="${customerName} + '님의 주문 내역입니다'">고객님의 주문 내역입니다</p>
    </div>

    <!-- 주문이 없는 경우 -->
    <div th:if="${#lists.isEmpty(orders)}" class="empty-state">
        <div style="font-size: 4rem; margin-bottom: 20px;">📦</div>
        <h3>아직 주문한 상품이 없습니다</h3>
        <p>AuGold의 프리미엄 골드 제품을 둘러보세요!</p>
        <a href="/product/list" class="btn btn-primary" style="margin-top: 20px;">상품 둘러보기</a>
    </div>

    <!-- 주문 목록 -->
    <div th:if="${!#lists.isEmpty(orders)}" class="order-list">
        <div th:each="order, iterStat : ${orders}" class="order-card">
            <!-- 주문 헤더 -->
            <div class="order-header">
                <div>
                    <div class="order-date" th:text="${#temporals.format(order.orderDate, 'yyyy.MM.dd HH:mm')}">2025.01.22 15:30</div>
                </div>
                <div th:switch="${order.orderStatus.name()}">
                    <span th:case="'PAID'" class="order-status status-paid" th:text="${order.orderStatus.description}">결제완료</span>
                    <span th:case="'PREPARING'" class="order-status status-preparing" th:text="${order.orderStatus.description}">상품준비중</span>
                    <span th:case="'SHIPPED'" class="order-status status-shipped" th:text="${order.orderStatus.description}">배송중</span>
                    <span th:case="'DELIVERED'" class="order-status status-delivered" th:text="${order.orderStatus.description}">배송완료</span>
                    <span th:case="'CANCELLED'" class="order-status status-cancelled" th:text="${order.orderStatus.description}">취소</span>
                    <span th:case="'REFUNDED'" class="order-status status-cancelled" th:text="${order.orderStatus.description}">환불완료</span>
                    <span th:case="*" class="order-status" th:text="${order.orderStatus.description}">기타</span>
                </div>
            </div>

            <!-- 주문 내용 -->
            <div class="order-content">
                <!-- 이미지 표시 -->
                <div class="product-image">
        <span th:if="${order.orderItems != null and !#lists.isEmpty(order.orderItems) and order.orderItems[0].imageUrl != null}">
            <img th:src="${order.orderItems[0].imageUrl}"
                 th:alt="${order.orderItems[0].productName}"
                 style="width: 100%; height: 100%; object-fit: cover;">
        </span>
                    <span th:unless="${order.orderItems != null and !#lists.isEmpty(order.orderItems) and order.orderItems[0].imageUrl != null}">💎</span>
                </div>

                <div class="order-details">
                    <!-- 상품명 표시 (상품ID 대신) -->
                    <div class="product-name" th:if="${order.orderItems != null and #lists.size(order.orderItems) == 1}"
                         th:text="${order.orderItems[0].productName}">18K 골드 반지</div>
                    <div class="product-name" th:if="${order.orderItems != null and #lists.size(order.orderItems) > 1}"
                         th:text="${order.orderItems[0].productName} + ' 외 ' + (${#lists.size(order.orderItems)} - 1) + '종'">18K 골드 반지 외 2종</div>
                    <div class="product-summary" th:text="'총 ' + ${order.totalItemCount} + '개 상품'">총 3개 상품</div>
                </div>

                <div class="order-price">
                    <div class="price-amount" th:text="'₩' + ${#numbers.formatInteger(order.finalAmount, 3, 'COMMA')}">₩1,250,000</div>
                </div>
            </div>

            <!-- 주문 액션 -->
            <div class="order-actions">
                <div>
                    <button class="btn btn-primary"
                            th:data-order-number="${order.orderNumber}"
                            onclick="showOrderDetail(this.dataset.orderNumber)">상세보기</button>

                    <button th:if="${order.isCancellable()}"
                            class="btn btn-danger"
                            th:data-order-number="${order.orderNumber}"
                            onclick="cancelOrder(this.dataset.orderNumber)">주문 취소</button>
                </div>
                <div>
                    <span th:if="${order.orderStatus.name() == 'DELIVERED'}" class="btn btn-secondary">리뷰 작성</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 주문 상세 모달 -->
<div id="orderDetailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>주문 상세 정보</h2>
            <span class="close">&times;</span>
        </div>
        <div id="orderDetailContent">
            <!-- 상세 내용이 동적으로 로드됩니다 -->
        </div>
    </div>
</div>

<script>
    // 페이지 로드 시 URL 파라미터 확인하여 성공/실패 메시지 표시
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);

        // 주문 취소 성공
        if (urlParams.get('cancelled') === 'true') {
            const orderNumber = urlParams.get('orderNumber');
            Swal.fire({
                title: '주문 취소 완료!',
                text: '주문이 성공적으로 취소되었습니다.',
                icon: 'success',
                confirmButtonText: '확인',
                confirmButtonColor: '#3498db',
                timer: 3000,
                timerProgressBar: true
            });
        }

        // 주문 취소 실패
        if (urlParams.get('error') === 'cancel') {
            const message = urlParams.get('message') || '주문 취소 중 오류가 발생했습니다.';
            Swal.fire({
                title: '주문 취소 실패',
                text: decodeURIComponent(message),
                icon: 'error',
                confirmButtonText: '확인',
                confirmButtonColor: '#e74c3c'
            });
        }

        // 시스템 오류
        if (urlParams.get('error') === 'system') {
            Swal.fire({
                title: '시스템 오류',
                text: '일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요.',
                icon: 'error',
                confirmButtonText: '확인',
                confirmButtonColor: '#e74c3c'
            });
        }
    });

    // 주문 상세보기 - 부드러운 모달
    function showOrderDetail(orderNumber) {
        // JSON API 호출 (로딩 스피너 없이)
        fetch(`/order/api/${orderNumber}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 실제 주문 데이터로 모달 내용 생성
                    const order = data.order;
                    let orderItemsHtml = '';

                    // 주문 상품들 HTML 생성
                    if (order.orderItems && order.orderItems.length > 0) {
                        order.orderItems.forEach(item => {
                            // 실제 상품 이미지 처리
                            let imageHtml;
                            if (item.imageUrl) {
                                imageHtml = `<img src="${item.imageUrl}" alt="${item.productName}" style="width: 100%; height: 100%; object-fit: cover;">`;
                            } else {
                                imageHtml = '💎'; // 이미지가 없는 경우 기본 이모지
                            }

                            orderItemsHtml += `
                                <div class="detail-item">
                                    <div class="detail-image">${imageHtml}</div>
                                    <div class="detail-info">
                                        <div><strong>${item.productName || '상품명 없음'}</strong></div>
                                        <div>수량: ${item.quantity}개</div>
                                        <div>단가: ₩${item.unitPrice.toLocaleString()}</div>
                                    </div>
                                    <div class="detail-price">₩${item.finalAmount.toLocaleString()}</div>
                                </div>
                            `;
                        });
                    } else {
                        orderItemsHtml = '<div class="detail-item">주문 상품 정보를 찾을 수 없습니다.</div>';
                    }

                    // 모달 내용 설정
                    document.getElementById('orderDetailContent').innerHTML = `
                        <div style="padding: 20px;">
                            <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                                <h3>주문번호: ${order.orderNumber}</h3>
                                <p>주문일시: ${new Date(order.orderDate).toLocaleString('ko-KR')}</p>
                                <p>주문상태: <span class="order-status">${order.orderStatus.description}</span></p>
                                <p>배송주소: ${order.deliveryAddr}</p>
                                <p>배송연락처: ${order.deliveryPhone}</p>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <h4>주문 상품</h4>
                                ${orderItemsHtml}
                            </div>

                            <div class="total-price">
                                <div>총 주문금액: ₩${order.totalAmount.toLocaleString()}</div>
                                <div style="font-size: 1.2rem; margin-top: 5px;">
                                    <strong>최종 결제금액: ₩${order.finalAmount.toLocaleString()}</strong>
                                </div>
                            </div>
                        </div>
                    `;

                    // 모달 부드럽게 표시
                    const modal = document.getElementById('orderDetailModal');
                    const modalContent = modal.querySelector('.modal-content');

                    modal.style.display = 'block';
                    modal.style.opacity = '0';
                    modalContent.style.transform = 'translateY(-20px)';

                    // 약간의 지연 후 페이드인
                    setTimeout(() => {
                        modal.style.opacity = '1';
                        modalContent.style.transform = 'translateY(0)';
                    }, 10);

                } else {
                    // 에러 메시지 표시
                    Swal.fire({
                        title: '주문 정보 조회 실패',
                        text: data.message || '주문 정보를 불러올 수 없습니다.',
                        icon: 'error',
                        confirmButtonText: '확인',
                        confirmButtonColor: '#e74c3c'
                    });
                }
            })
            .catch(error => {
                console.error('주문 상세 조회 오류:', error);

                Swal.fire({
                    title: '오류 발생',
                    text: '주문 상세 정보를 불러오는 중 오류가 발생했습니다.',
                    icon: 'error',
                    confirmButtonText: '확인',
                    confirmButtonColor: '#e74c3c'
                });
            });
    }

    // 주문 취소 - SweetAlert2 적용
    function cancelOrder(orderNumber) {
        Swal.fire({
            title: '주문을 취소하시겠습니까?',
            text: '취소된 주문은 되돌릴 수 없습니다.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#e74c3c',
            cancelButtonColor: '#95a5a6',
            confirmButtonText: '취소하기',
            cancelButtonText: '아니요',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                // 취소 처리 중 로딩 표시
                Swal.fire({
                    title: '주문 취소 중...',
                    text: '잠시만 기다려주세요.',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showConfirmButton: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // 폼 생성 및 전송
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/order/${orderNumber}/cancel`;

                const reasonInput = document.createElement('input');
                reasonInput.type = 'hidden';
                reasonInput.name = 'cancelReason';
                reasonInput.value = '고객 요청';
                form.appendChild(reasonInput);

                document.body.appendChild(form);
                form.submit();
            }
        });
    }

    // 모달 부드럽게 닫기
    function closeModal() {
        const modal = document.getElementById('orderDetailModal');
        const modalContent = modal.querySelector('.modal-content');

        modal.style.opacity = '0';
        modalContent.style.transform = 'translateY(-20px)';

        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }

    // 모달 닫기 이벤트
    document.getElementsByClassName('close')[0].onclick = closeModal;

    window.onclick = function(event) {
        const modal = document.getElementById('orderDetailModal');
        if (event.target == modal) {
            closeModal();
        }
    }

    // ESC 키로 모달 닫기
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const modal = document.getElementById('orderDetailModal');
            if (modal.style.display === 'block') {
                closeModal();
            }
        }
    });
</script>
</body>
</html>