<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>AuGold ê´€ë¦¬ì í˜ì´ì§€</title>
  <style>
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #f5f8fa; }
    header {
        background-color: #2a3f54;
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    /* ì¹´ë“œí˜• ëŒ€ì‹œë³´ë“œ ìŠ¤íƒ€ì¼ */
    .dashboard-cards {
        display: flex;
        gap: 24px;
        margin: 32px 0 24px 0;
        justify-content: space-between;
        padding: 0 24px;
    }
    .dashboard-card {
        flex: 1;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        padding: 32px 0 24px 0;
        text-align: center;
        color: #2a3f54;
        cursor: pointer;
        font-size: 1.1em;
        font-weight: 500;
        transition: box-shadow 0.2s, background 0.2s;
        border: 2px solid transparent;
    }
    .dashboard-card.active, .dashboard-card:hover {
        box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        background: #eaf3fb;
        border: 2px solid #1976d2;
        color: #1976d2;
    }
    .dashboard-card i {
        display: block;
        font-size: 2.2em;
        margin-bottom: 10px;
        color: #1976d2;
    }
    .content {
        padding: 30px 24px;
    }
    /* ê¸°ì¡´ íƒ­ë°” ìˆ¨ê¹€ */
    .tab-bar { display: none; }
    /* í•˜ë‹¨ ì¹´ë“œ/ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
    .tab-content {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        padding: 32px 24px;
        margin-bottom: 32px;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* í†µê³„ í•˜ìœ„ íƒ­ ìŠ¤íƒ€ì¼ */
    .stats-subtab-bar {
      display: flex;
      gap: 16px;
      padding: 0 24px;
      background: transparent;
      border-bottom: none;
      margin-bottom: 40px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .stats-subtab-bar button {
      background: #fff;
      color: #1976d2;
      border: 2px solid #e3eaf5;
      border-radius: 22px;
      box-shadow: 0 4px 16px rgba(25, 118, 210, 0.13);
      padding: 28px 48px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: box-shadow 0.18s, border 0.18s, color 0.18s, background 0.18s;
      margin-bottom: 10px;
      outline: none;
      letter-spacing: 0.5px;
    }
    .stats-subtab-bar button.active {
      border: 3px solid #1976d2;
      color: #1976d2;
      background: #f5faff;
      box-shadow: 0 8px 32px rgba(25, 118, 210, 0.18);
      z-index: 2;
    }
    .stats-subtab-bar button:hover:not(.active) {
      border: 2px solid #90caf9;
      background: #f5faff;
      color: #1976d2;
      box-shadow: 0 4px 24px rgba(25, 118, 210, 0.13);
    }

    .stats-subtab-content {
        display: none;
    }
    .stats-subtab-content.active {
        display: block;
    }

    table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 20px;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
    }
    th {
        background-color: #f2f2f2;
    }
    .form-container {
        margin-top: 30px;
        border: 1px solid #ccc;
        padding: 20px;
    }
    .form-container input, .form-container select {
        padding: 8px;
        margin: 5px 0;
        width: 100%;
    }
    .form-container button {
        margin-top: 10px;
        padding: 10px 20px;
        background-color: goldenrod;
        border: none;
        color: white;
        cursor: pointer;
    }
    .form-container .delete-btn {
        background-color: #dc3545;
        margin-left: 10px;
    }
    #productTable {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-collapse: collapse;
        margin-top: 24px;
        width: 100%;
        font-size: 14px;
    }
    #productTable thead tr {
        background: #e3f2fd;
        border-bottom: 2px solid #1976d2;
    }
    #productTable th {
        color: #1565c0;
        font-weight: 600;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 16px 12px;
        text-align: center;
        border-bottom: 2px solid #1976d2;
    }
    #productTable td {
        padding: 16px 12px;
        text-align: center;
        border-bottom: 1px solid #e0e0e0;
        vertical-align: middle;
    }
    #productTable tbody tr {
        transition: background 0.15s ease;
    }
    #productTable tbody tr:hover {
        background: #f5f5f5;
    }
    #productTable tbody tr:nth-child(even) {
        background: #fafafa;
    }
    #productTable tbody tr:nth-child(even):hover {
        background: #f0f0f0;
    }
    #productTable a {
        color: #1976d2;
        text-decoration: none;
        font-weight: 500;
    }
    #productTable a:hover {
        color: #1565c0;
        text-decoration: underline;
    }
    .tab-content button[onclick="toggleForm()"]:hover {
        background: #1565c0 !important;
    }
  </style>

  <!-- Plotly.js (ì›ë˜ ë²„ì „ ìœ ì§€) -->
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <!-- Chart.js ì¶”ê°€ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- FontAwesome ì•„ì´ì½˜ (ë””ìì¸ì— í•„ìš”í•˜ì—¬ ì¶”ê°€) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>

<body>

<header>
  <h2>ê´€ë¦¬ì í˜ì´ì§€</h2>
  <div style="display: flex; align-items: center; gap: 20px;">
    <a href="/" style="color: white; text-decoration: none; padding: 8px 16px; border: 1px solid white; border-radius: 4px; transition: all 0.2s;">í™ˆ</a>
    <a href="/logout" style="color: white; text-decoration: none; padding: 8px 16px; border: 1px solid white; border-radius: 4px; transition: all 0.2s;">ë¡œê·¸ì•„ì›ƒ</a>
    <div>AuGold Admin</div>
  </div>
</header>

<div class="dashboard-cards">
  <div class="dashboard-card tab-btn active" onclick="showTab('productTab', event)">
    <i class="fa fa-cube"></i>
    ìƒí’ˆ ê´€ë¦¬
  </div>
  <div class="dashboard-card tab-btn" onclick="showTab('statsTab', event)">
    <i class="fa fa-chart-bar"></i>
    í†µê³„
  </div>
  <div class="dashboard-card tab-btn" onclick="showTab('receiptTab', event)">
    <i class="fa fa-receipt"></i>
    ì˜ìˆ˜ì¦ ë“±ë¡
  </div>
  <div class="dashboard-card tab-btn" onclick="showTab('inquiryTab', event)">
    <i class="fa fa-question-circle"></i>
    ë¬¸ì˜ ë‹µë³€
  </div>
</div>

<div class="content">
  <!-- ìƒí’ˆ ê´€ë¦¬ -->
  <div id="productTab" class="tab-content active">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3 style="margin: 0; color: #1976d2; font-size: 24px; font-weight: 600;">ìƒí’ˆ ê´€ë¦¬</h3>
      <button onclick="toggleForm()" style="background: #1976d2; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 8px;">
        <i class="fa fa-plus" style="font-size: 14px;"></i>
        ìƒí’ˆ ë“±ë¡
      </button>
    </div>
    <div class="form-container" id="productForm" style="display:none;">
      <form onsubmit="submitProduct(event)" enctype="multipart/form-data">
        <label>ìƒí’ˆ ID: <input type="text" name="productId" readonly></label><br><br>
        <label>ìƒí’ˆëª…: <input type="text" name="productName" required></label><br><br>
        <label>ì¹´í…Œê³ ë¦¬:
          <select name="ctgrId" required><option value="">ì„ íƒ</option><option value="CTGR-00001">CTGR-00001 [ì£¼ì–¼ë¦¬]</option><option value="CTGR-00002">CTGR-00002 [ê³¨ë“œë°”]</option><option value="CTGR-00003">CTGR-00003 [ê¸°ë…í’ˆ]</option></select>
        </label><br><br>
        <label>ì„œë¸Œ ì¹´í…Œê³ ë¦¬:
          <select name="subCtgr" required><option value="">ì„ íƒ</option><option value="ê·€ê±¸ì´">ê·€ê±¸ì´</option><option value="ë°˜ì§€">ë°˜ì§€</option><option value="ëª©ê±¸ì´">ëª©ê±¸ì´</option><option value="ê³¨ë“œë°”">ê³¨ë“œë°”</option><option value="ê°ì‚¬íŒ¨">ê°ì‚¬íŒ¨</option><option value="ëŒë°˜ì§€">ëŒë°˜ì§€</option><option value="ì¹´ë„¤ì´ì…˜ ê¸°ë…í’ˆ">ì¹´ë„¤ì´ì…˜ ê¸°ë…í’ˆ</option></select>
        </label><br><br>
        <label>ê¸ˆ í•¨ëŸ‰:
          <select name="karatCode" required><option value="">ì„ íƒ</option><option value="14K">14K</option><option value="18K">18K</option><option value="24K">24K</option></select>
        </label><br><br>
        <label>ê¸ˆ ë¬´ê²Œ (g): <input type="number" name="goldWeight" step="0.01" required></label><br><br>
        <label>ì›ê°€: <input type="number" name="basePrice" step="0.01" required></label><br><br>
        <label>íŒë§¤ê°€: <input type="number" name="finalPrice" step="0.01" required></label><br><br>
        <label>ìƒí’ˆ ì„¤ëª…: <input type="text" name="description"></label><br><br>
        <label>ëŒ€í‘œ ì´ë¯¸ì§€: <input type="file" name="imageFile" accept="image/*" required></label><br><br>
        <label>ìƒì„¸ ì´ë¯¸ì§€ 1: <input type="file" name="detailImage1" accept="image/*"></label><br><br>
        <label>ìƒì„¸ ì´ë¯¸ì§€ 2: <input type="file" name="detailImage2" accept="image/*"></label><br><br>
        <label>ìƒì„¸ ì´ë¯¸ì§€ 3: <input type="file" name="detailImage3" accept="image/*"></label><br><br>
        <label>ìƒí’ˆ ì¬ê³  (Inventory): <input type="number" name="productInventory" required></label><br><br>
        <label>ì´ˆê¸° ì¬ê³ ëŸ‰ (Stock Quantity): <input type="number" name="stockQuantity" value="10" required></label><br><br>
        <button type="submit">ìƒí’ˆ ì €ì¥</button>
        <button type="button" class="delete-btn" onclick="deleteProduct()" style="display: none;">ìƒí’ˆ ì‚­ì œ</button>
      </form>
    </div>
    <table id="productTable">
      <thead><tr><th>ID</th><th>ì´ë¦„</th><th>ê¸ˆ í•¨ëŸ‰</th><th>ì¹´í…Œê³ ë¦¬</th><th>ê°€ê²©</th><th>ë¬´ê²Œ</th><th>ìµœì¢…ê°€</th><th>ì„œë¸Œ</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- í†µê³„ íƒ­ -->
  <div id="statsTab" class="tab-content">
    <div style="margin-left: 120px;">
      <h3 style="margin-bottom: 30px; color: #1976d2; font-size: 24px; font-weight: 600;">í†µê³„ ë¶„ì„</h3>
    </div>
    <div class="stats-subtab-bar">
      <button class="stats-subtab-btn" onclick="showStatsSubTab('salesAnalysis', event)">ë§¤ì¶œ ë¶„ì„ ë° ì˜ˆì¸¡</button>
      <button class="stats-subtab-btn" onclick="showStatsSubTab('profitAnalysis', event)">ìˆœì´ìµ ë¶„ì„ ë° ì˜ˆì¸¡</button>
      <button class="stats-subtab-btn active" onclick="showStatsSubTab('goldPrice', event)">ê¸ˆ ì‹œì„¸ ë¶„ì„ ë° ì˜ˆì¸¡</button>
      <button class="stats-subtab-btn" onclick="showStatsSubTab('demographics', event)">ì„±ë³„/ì—°ë ¹ëŒ€ë³„ ë§¤ì¶œ/êµ¬ë§¤íŒ¨í„´ ë¶„ì„</button>
      <button class="stats-subtab-btn" onclick="showStatsSubTab('orderTrends', event)">íŒë§¤ë‚ ì§œ ê¸°ë°˜ ì£¼ë¬¸ íŠ¸ë Œë“œ ë¶„ì„</button>
      <button class="stats-subtab-btn" onclick="showStatsSubTab('categoryProfit', event)">ì¹´í…Œê³ ë¦¬ë³„ ì´ìµë¥  ë¶„ì„/ì˜ˆì¸¡</button>
      <button class="stats-subtab-btn" onclick="showStatsSubTab('cartAbandonment', event)">ì¥ë°”êµ¬ë‹ˆ ì´íƒˆ ë¶„ì„</button>
    </div>

    <div id="salesAnalysis" class="stats-subtab-content">
      <h3>ë§¤ì¶œ ë¶„ì„ ë° ì˜ˆì¸¡</h3>
      <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 20px;">
        <div><label for="unit">ë¶„ì„ ë‹¨ìœ„:</label><select id="unit" onchange="loadSalesAnalysis()"><option value="day">ì¼</option><option value="week">ì£¼</option><option value="month" selected>ì›”</option><option value="year">ì—°</option></select></div>
        <div><label><input type="checkbox" id="toggleForecast" onchange="loadSalesAnalysis()" checked> ì˜ˆì¸¡ê°’ í‘œì‹œ</label></div>
      </div>
      <div id="salesAnalysisLoading" style="text-align: center; padding: 40px; font-size: 1.1em; display: none;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
      <div style="display: flex; gap: 20px; width: 100%;">
        <div id="salesTableContainer" style="flex: 1; max-height: 500px; overflow-y: auto; display: none;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead><tr style="background-color: #f2f2f2;"><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">ê¸°ê°„</th><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">ì‹¤ì œ ë§¤ì¶œ</th><th id="forecastHeader" style="padding: 8px; border: 1px solid #ddd; text-align: left;">ì˜ˆì¸¡ ë§¤ì¶œ</th></tr></thead>
            <tbody id="salesTableBody"></tbody>
          </table>
        </div>
        <div style="flex: 2; position: relative; height:500px;"><canvas id="salesChart"></canvas></div>
      </div>
    </div>

    <div id="profitAnalysis" class="stats-subtab-content">
      <h3>ìˆœì´ìµ ë¶„ì„ ë° ì˜ˆì¸¡</h3>
      <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 20px;">
        <div><label for="profit_unit">ë¶„ì„ ë‹¨ìœ„:</label><select id="profit_unit" onchange="loadProfitAnalysis()"><option value="day">ì¼</option><option value="week">ì£¼</option><option value="month" selected>ì›”</option><option value="year">ì—°</option></select></div>
        <div><label><input type="checkbox" id="profit_toggleForecast" onchange="loadProfitAnalysis()" checked> ì˜ˆì¸¡ê°’ í‘œì‹œ</label></div>
      </div>
      <div id="profitAnalysisLoading" style="text-align: center; padding: 40px; font-size: 1.1em; display: none;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
      <div style="display: flex; gap: 20px; width: 100%;">
        <div id="profitTableContainer" style="flex: 1; max-height: 500px; overflow-y: auto; display: none;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead><tr style="background-color: #f2f2f2;"><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">ê¸°ê°„</th><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">ì‹¤ì œ ìˆœì´ìµ</th><th id="profit_forecastHeader" style="padding: 8px; border: 1px solid #ddd; text-align: left;">ì˜ˆì¸¡ ìˆœì´ìµ</th></tr></thead>
            <tbody id="profitTableBody"></tbody>
          </table>
        </div>
        <div style="flex: 2; position: relative; height:500px;"><canvas id="profitChart"></canvas></div>
      </div>
    </div>

    <div id="orderTrends" class="stats-subtab-content">
      <h3>íŒë§¤ë‚ ì§œ ê¸°ë°˜ ì£¼ë¬¸ íŠ¸ë Œë“œ ë¶„ì„</h3>
      <p>ì£¼ë¬¸ ë‚ ì§œ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìš”ì¼ë³„, ì›”ë³„ ë§¤ì¶œ íŠ¸ë Œë“œë¥¼ ë¶„ì„í•œ ê²°ê³¼ì…ë‹ˆë‹¤.</p>
      <div id="orderTrendsLoading" style="text-align: center; padding: 40px; font-size: 1.1em;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
      <div style="display: flex; gap: 30px; justify-content: center; flex-wrap: nowrap;">
        <div id="salesWeeklyPlot" style="flex:1; min-width:400px; max-width:600px;"><canvas id="salesWeeklyCanvas"></canvas></div>
        <div id="yearlyChart" style="flex:1; min-width:400px; max-width:600px;"><canvas id="salesYearlyCanvas"></canvas></div>
      </div>
    </div>

    <div id="goldPrice" class="stats-subtab-content active">
      <div id="loadingMessage" style="text-align: center; padding: 50px; font-size: 1.2em;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
      <div id="forecastPlot" class="plot-container" style="width: 90%; max-width: 900px; margin: 20px auto; display: none;"></div>
      <div id="trendPlot" class="plot-container" style="width: 90%; max-width: 900px; margin: 20px auto; display: none;"></div>
      <div id="weeklyPlot" class="plot-container" style="width: 90%; max-width: 900px; margin: 20px auto; display: none;"></div>
    </div>

    <div id="demographics" class="stats-subtab-content">
      <div id="sexAgeLoading" style="text-align: center; padding: 40px; font-size: 1.1em;"></div>
      <div style="display: flex; gap: 30px; justify-content: center; flex-wrap: wrap;">
        <div id="genderAgeChartPlotMale" style="flex:1; min-width:350px; max-width:600px;"></div>
        <div id="genderAgeChartPlotFemale" style="flex:1; min-width:350px; max-width:600px;"></div>
      </div>
      <div style="display: flex; gap: 40px; justify-content: center; margin-top: 40px; flex-wrap: wrap;">
        <div id="topProductsChart" style="flex:1; min-width:500px; max-width:700px; height:520px;"></div>
        <div id="bottomProductsChart" style="flex:1; min-width:500px; max-width:700px; height:520px;"></div>
      </div>
    </div>

    <div id="categoryProfit" class="stats-subtab-content">
      <p>ì¹´í…Œê³ ë¦¬ë³„ ì´ìµë¥  ë¶„ì„ ë° ì˜ˆì¸¡ ë°ì´í„°ë¥¼ ë³´ì—¬ì£¼ëŠ” ì˜ì—­ì…ë‹ˆë‹¤.</p>
      <div id="categoryProfitLoading" style="text-align: center; padding: 50px; font-size: 1.2em;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
      <div id="categoryProfitPlot1" class="plot-container" style="width: 90%; max-width: 900px; margin: 20px auto; display: none;"><canvas id="categoryProfitChart1"></canvas></div>
      <div id="categoryProfitPlot2" class="plot-container" style="width: 90%; max-width: 900px; margin: 20px auto; display: none;"><canvas id="categoryProfitChart2"></canvas></div>
      <div id="categoryProfitPlot3" class="plot-container" style="width: 90%; max-width: 900px; margin: 20px auto; display: none;"><canvas id="categoryProfitChart3"></canvas></div>
    </div>

    <div id="cartAbandonment" class="stats-subtab-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
        <h3>ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ì´íƒˆ ë¶„ì„ (ì¸í„°ë™í‹°ë¸Œ)</h3>
        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
          <label>ì´íƒˆ ê¸°ì¤€: <select id="abandonmentThreshold"><option value="1" selected>1ì‹œê°„</option><option value="2">2ì‹œê°„</option><option value="6">6ì‹œê°„</option><option value="12">12ì‹œê°„</option><option value="24">24ì‹œê°„</option></select></label>
          <button id="executeAnalysisBtn" onclick="executeInteractiveCartAnalysis()" style="padding: 10px 20px; background-color: #4ECDC4; color: white; border: none; border-radius: 5px; cursor: pointer;">ğŸ“Š ë¶„ì„ ì‹¤í–‰</button>
          <button onclick="loadExistingAnalysis()" style="padding: 10px 15px; background-color: #17a2b8; color: white; border: none; border-radius: 5px; cursor: pointer;">ğŸ“‚ ê¸°ì¡´ ê²°ê³¼ ë¡œë“œ</button>
        </div>
      </div>
      <div id="interactiveAnalysisLoading" style="display: none; text-align: center; padding: 40px; border: 2px dashed #ddd; border-radius: 10px; margin-bottom: 20px;">
        <div style="font-size: 20px; margin-bottom: 10px;">ğŸ”„</div><div style="font-size: 16px; color: #666;">ì¥ë°”êµ¬ë‹ˆ ì´íƒˆ ë¶„ì„ ì‹¤í–‰ ì¤‘...</div><div style="font-size: 14px; color: #999; margin-top: 5px;">JSON ë°ì´í„° ìƒì„± ì¤‘ì…ë‹ˆë‹¤</div>
      </div>
      <div id="interactiveSummaryCards" style="display: none;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;"><div style="font-size: 24px; font-weight: bold;" id="iTotalItems">-</div><div style="font-size: 14px; opacity: 0.9;">ì´ ì•„ì´í…œ</div></div>
          <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;"><div style="font-size: 24px; font-weight: bold;" id="iAbandonedItems">-</div><div style="font-size: 14px; opacity: 0.9;">ì´íƒˆ ì•„ì´í…œ</div></div>
          <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;"><div style="font-size: 24px; font-weight: bold;" id="iActiveItems">-</div><div style="font-size: 14px; opacity: 0.9;">í™œì„± ì•„ì´í…œ</div></div>
          <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;"><div style="font-size: 24px; font-weight: bold;" id="iAbandonmentRate">-</div><div style="font-size: 14px; opacity: 0.9;">ì´íƒˆë¥ </div></div>
        </div>
      </div>
      <div id="interactiveCharts" style="display: none;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(45%, 1fr)); gap: 20px; margin-bottom: 30px;">
          <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"><div id="interactiveAbandonmentChart" style="height: 400px;"></div></div>
          <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"><div id="interactiveHourlyChart" style="height: 400px;"></div></div>
          <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"><div id="interactiveKaratChart" style="height: 400px;"></div></div>
          <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"><div id="interactiveTimeChart" style="height: 400px;"></div></div>
        </div>
      </div>
      <div id="thresholdComparison" style="display: none; margin-bottom: 30px;">
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"><h4 style="margin-bottom: 15px;">ğŸ“Š ë‹¤ì–‘í•œ ê¸°ì¤€ë³„ ì´íƒˆë¥  ë¹„êµ</h4><div id="thresholdComparisonChart" style="height: 400px;"></div></div>
      </div>
      <div id="interactiveInsights" style="display: none;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px;"><h4 style="margin-bottom: 15px;">ğŸ’¡ í•µì‹¬ ë°œê²¬ì‚¬í•­</h4><div id="keyFindings" style="line-height: 1.8; font-size: 14px;"></div></div>
          <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 8px;"><h4 style="margin-bottom: 15px;">ğŸ¯ ì¶”ì²œ ì•¡ì…˜</h4><div id="recommendations" style="line-height: 1.8; font-size: 14px;"></div></div>
        </div>
      </div>
      <div id="interactiveAnalysisError" style="display: none; padding: 20px; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; color: #721c24;"><h4>âŒ ë¶„ì„ ì˜¤ë¥˜</h4><div id="interactiveErrorContent"></div></div>
    </div>
  </div>

  <div id="receiptTab" class="tab-content">
    <h3>ì˜ìˆ˜ì¦ ë“±ë¡</h3>
    <div style="margin-top: 20px; border: 1px solid #ccc; padding: 20px; border-radius: 8px;">
      <h2>ì˜ìˆ˜ì¦ ë“±ë¡ RPA</h2>
      <button onclick="runRPA()" style="padding: 10px 20px; font-size: 16px;">RPA ì‹¤í–‰</button>
      <p id="rpaStatus" style="margin-top: 10px;"></p>
    </div>
  </div>

  <div id="inquiryTab" class="tab-content">
    <h3>ë¬¸ì˜ ë‹µë³€</h3>
    <table id="inquiryTable">
      <thead><tr><th>#</th><th>íšŒì›ë²ˆí˜¸</th><th>ì œëª©</th><th>ì²˜ë¦¬ìƒíƒœ</th><th>ë¬¸ì˜ì¼ì‹œ</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
  function runRPA() {
      const status = document.getElementById("rpaStatus");
      status.textContent = "ì‹¤í–‰ ìš”ì²­ ì¤‘...";

      fetch("http://localhost:5001/run-rpa")
          .then(res => res.text())
          .then(msg => {
              status.textContent = "âœ… " + msg;
              status.style.color = "green";
          })
          .catch(err => {
          });
  }


   <!--ë¬¸ì˜ ëª©ë¡ì„ ì„œë²„ì—ì„œ ê°€ì ¸ì™€ í‘œì— ì±„ìš´ë‹¤-->

  function fetchInquiries() {
    fetch('/api/inquiries')
      .then(res => {
        if (!res.ok) throw new Error("ë¬¸ì˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        return res.json();
      })
      .then(data => {
        const tbody = document.querySelector("#inquiryTable tbody");
        tbody.innerHTML = "";

        data.forEach((inq, index) => {
          const row = `
            <tr>
              <td>${index + 1}</td>
              <td>${inq.cstmNumber}</td>
              <td>
               <a href="/admin/inquiry/${inq.inqNumber}">${inq.inqTitle}</a>
              </td>
              <td>${inq.inqStatus}</td>
              <td>${new Date(inq.inqDate).toLocaleString()}</td>
            </tr>
          `;
          tbody.insertAdjacentHTML("beforeend", row);
        });
      })
      .catch(err => {
        console.error(err);
        alert(err.message);
      });
  }
</script>

<script>
  // ìƒí’ˆ ê´€ë¦¬ ê´€ë ¨ ë³€ìˆ˜ ë° í•¨ìˆ˜
  let editing = false;
  let editProductId = null;

  function toggleForm(show = null) {
      const form = document.getElementById('productForm');
      form.style.display = (show === true || (show === null && form.style.display === 'none')) ? 'block' : 'none';
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰ë  í•¨ìˆ˜ë“¤
  document.addEventListener('DOMContentLoaded', () => {
      // ìƒí’ˆ ê´€ë¦¬ ì´ˆê¸°í™”
      document.querySelector('select[name="subCtgr"]').addEventListener("change", function () {
          const subCtgr = this.value;
          if (!subCtgr || editing) return;

          fetch(`/api/products/next-id?subCtgr=${encodeURIComponent(subCtgr)}`)
              .then(res => res.text())
              .then(productId => {
                  document.querySelector('#productForm input[name="productId"]').value = productId;
              });
      });
      fetchProducts();

      // ë¬¸ì˜ ê´€ë¦¬ ì´ˆê¸°í™”
      fetchInquiries();
  });

  function fetchProducts() {
      fetch('/api/products')
          .then(res => res.json())
          .then(data => {
              const tbody = document.querySelector("#productTable tbody");
              tbody.innerHTML = "";
              data.forEach(p => {
                  const row = `<tr>
                      <td>${p.productId}</td>
                      <td><a href="#" onclick="editProduct('${p.productId}')">${p.productName}</a></td>
                      <td>${p.karatCode}</td>
                      <td>${p.ctgrId}</td>
                      <td>${p.basePrice}</td>
                      <td>${p.goldWeight}</td>
                      <td>${p.finalPrice}</td>
                      <td>${p.subCtgr}</td>
                  </tr>`;
                  tbody.insertAdjacentHTML("beforeend", row);
              });
          });
  }

  function editProduct(id) {
    fetch(`/api/products/${id}`)
        .then(res => res.json())
        .then(p => {
            const form = document.querySelector('#productForm form');
            form.productId.value = p.productId;
            form.productName.value = p.productName;
            form.ctgrId.value = p.ctgrId;
            form.subCtgr.value = p.subCtgr;
            form.karatCode.value = p.karatCode;
            form.goldWeight.value = p.goldWeight;
            form.basePrice.value = p.basePrice;
            form.finalPrice.value = p.finalPrice;
            form.description.value = p.description;

            editProductId = id;
            editing = true;
            toggleForm(true);
            form.querySelector("button[type='submit']").innerText = "ìƒí’ˆ ìˆ˜ì •";
            form.querySelector(".delete-btn").style.display = "inline-block";
        });
  }

 function submitProduct(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const url = '/api/products';

    fetch(url, { method: 'POST', body: formData })
        .then(res => {
            if (res.ok) {
                alert("ìƒí’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
                form.reset();
                toggleForm(false);
                fetchProducts();
            } else {
                res.text().then(text => alert("ì €ì¥ ì‹¤íŒ¨: " + text));
            }
        })
        .catch(err => {
            console.error("Fetch Error:", err);
            alert("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
  }

  function deleteProduct() {
      if (!editProductId) return;
      if (!confirm("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

      fetch(`/api/products/${editProductId}`, { method: 'DELETE' })
        .then(res => {
          if (res.ok) {
              alert("ì‚­ì œ ì™„ë£Œ!");
              const form = document.querySelector('#productForm form');
              form.reset();
              toggleForm(false);
              fetchProducts();
              editing = false;
              editProductId = null;
              form.querySelector("button[type='submit']").innerText = "ìƒí’ˆ ì €ì¥";
              form.querySelector(".delete-btn").style.display = "none";
          } else {
              alert("ì‚­ì œ ì‹¤íŒ¨");
          }
      });
  }

  // ë¬¸ì˜ ê´€ë¦¬ í•¨ìˆ˜
  function fetchInquiries() {
      fetch('/api/inquiries')
        .then(res => {
          if (!res.ok) throw new Error("ë¬¸ì˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
          return res.json();
        })
        .then(data => {
          const tbody = document.querySelector("#inquiryTable tbody");
          tbody.innerHTML = "";
          data.forEach((inq, index) => {
            const row = `
              <tr>
                <td>${index + 1}</td>
                <td>${inq.cstmNumber}</td>
                <td><a href="/admin/inquiry/${inq.inqNumber}">${inq.inqTitle}</a></td>
                <td>${inq.inqStatus}</td>
                <td>${new Date(inq.inqDate).toLocaleString()}</td>
              </tr>
            `;
            tbody.insertAdjacentHTML("beforeend", row);
          });
        })
        .catch(err => {
          console.error(err);
          alert(err.message);
        });
  }

  // ì˜ìˆ˜ì¦ ê´€ë¦¬ í•¨ìˆ˜
  function uploadReceipt(event) {
      event.preventDefault();
      const form = document.getElementById("receiptForm");
      const formData = new FormData(form);

      fetch('/api/receipt/upload', { method: 'POST', body: formData })
      .then(res => res.json())
      .then(data => {
          document.getElementById("ocrResult").innerText = "ğŸ“„ OCR ê²°ê³¼:\n" + data.text;
      })
      .catch(err => {
          alert("ì—…ë¡œë“œ ì‹¤íŒ¨");
          console.error(err);
      });
  }

  // --- íƒ­ ë° í†µê³„ ê´€ë ¨ ë¡œì§ ---

  // ê° í†µê³„ íƒ­ì˜ ë°ì´í„° ë¡œë“œ ì—¬ë¶€ë¥¼ ì¶”ì í•˜ëŠ” í”Œë˜ê·¸
  let goldPriceStatsLoaded = false;
  let orderTrendsLoaded = false;
  let categoryProfitLoaded = false;
  let demographicsLoaded = false;
  let cartAbandonmentLoaded = false;
  let profitAnalysisLoaded = false;

  // Chart.js ì°¨íŠ¸ ë³€ìˆ˜ë“¤
  let demographicsCharts = {};
  let categoryProfitCharts = {};

  /**
   * ë©”ì¸ íƒ­ ì „í™˜ í•¨ìˆ˜
   */
  function showTab(tabId, event) {
      // ëª¨ë“  íƒ­ ì»¨í…ì¸ ì™€ ë²„íŠ¼ ë¹„í™œì„±í™”
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.dashboard-card').forEach(card => card.classList.remove('active'));

      // í´ë¦­ëœ íƒ­ê³¼ ë²„íŠ¼ í™œì„±í™”
      document.getElementById(tabId).classList.add('active');
      event.currentTarget.classList.add('active');

      // 'í†µê³„' íƒ­ì„ ì²˜ìŒ ì—´ ë•Œ ê¸°ë³¸ í•˜ìœ„ íƒ­ ë¡œì§ ì‹¤í–‰
      if (tabId === 'statsTab') {
          const defaultSubTabButton = document.querySelector('.stats-subtab-btn[onclick*="orderTrends"]');
          if (defaultSubTabButton && !defaultSubTabButton.classList.contains('active')) {
              showStatsSubTab('orderTrends', { currentTarget: defaultSubTabButton });
          }
      }
  }

  /**
   * í†µê³„ í•˜ìœ„ íƒ­ ì „í™˜ í•¨ìˆ˜
   */
  function showStatsSubTab(subTabId, event) {
      // ëª¨ë“  í•˜ìœ„ íƒ­ ë²„íŠ¼ê³¼ ì»¨í…ì¸  ë¹„í™œì„±í™”
      document.querySelectorAll('.stats-subtab-bar button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.stats-subtab-content').forEach(content => content.classList.remove('active'));

      const subTabDiv = document.getElementById(subTabId);
      if (!subTabDiv) {
          console.error(`[showStatsSubTab] id="${subTabId}"ì¸ divê°€ ì—†ìŠµë‹ˆë‹¤.`);
          return;
      }

      // í´ë¦­ëœ í•˜ìœ„ íƒ­ ë²„íŠ¼ê³¼ ì»¨í…ì¸  í™œì„±í™”
      if (event && event.currentTarget) {
          event.currentTarget.classList.add('active');
      }
      subTabDiv.classList.add('active');

      // ê° í•˜ìœ„ íƒ­ì— ë§ëŠ” ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ë¥¼ *í•„ìš”í•  ë•Œë§Œ* í˜¸ì¶œ
      if (subTabId === 'goldPrice' && !goldPriceStatsLoaded) {
          loadGoldPriceForecast();
          goldPriceStatsLoaded = true;
      } else if (subTabId === 'orderTrends' && !orderTrendsLoaded) {
          loadOrderTrends();
          orderTrendsLoaded = true;
      } else if (subTabId === 'categoryProfit' && !categoryProfitLoaded) {
          loadCategoryProfit();
          categoryProfitLoaded = true;
      } else if (subTabId === 'demographics' && !demographicsLoaded) {
          loadDemographicsChart();
          demographicsLoaded = true;
      } else if (subTabId === 'cartAbandonment') {
          console.log('ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ì´íƒˆ ë¶„ì„ íƒ­ í™œì„±í™”');
      } else if (subTabId === 'salesAnalysis' && document.getElementById('salesAnalysis').classList.contains('active')) {
          loadSalesAnalysis();
      } else if (subTabId === 'profitAnalysis' && !profitAnalysisLoaded) {
          loadProfitAnalysis();
          profitAnalysisLoaded = true;
      }
  }

  // --- ì°¨íŠ¸ ë¡œë“œ í•¨ìˆ˜ë“¤ ---

  /**
   * ê¸ˆ ì‹œì„¸ ì˜ˆì¸¡ ë°ì´í„° ë¡œë“œ ë° ê·¸ë˜í”„ ê·¸ë¦¬ê¸° í•¨ìˆ˜
   */
  function loadGoldPriceForecast() {
      const loadingMsg = document.getElementById('loadingMessage');
      const plotDivs = ['forecastPlot', 'trendPlot', 'weeklyPlot'];

      loadingMsg.style.display = 'block';
      plotDivs.forEach(id => document.getElementById(id).style.display = 'none');

      fetch('/api/statistics/gold-price-forecast')
          .then(response => {
              if (!response.ok) throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ' + response.statusText);
              return response.json();
          })
          .then(data => {
              if (data.error) throw new Error(data.error);

              loadingMsg.style.display = 'none';
              plotDivs.forEach(id => document.getElementById(id).style.display = 'block');

              // ì˜ˆì¸¡ ê·¸ë˜í”„
              const forecast = data.forecast;
              Plotly.newPlot('forecastPlot', [
                { x: forecast.ds, y: forecast.yhat_upper, mode: 'lines', line: { width: 0 }, showlegend: false },
                { x: forecast.ds, y: forecast.yhat_lower, mode: 'lines', line: { width: 0 }, fill: 'tonexty', fillcolor: 'rgba(0, 100, 255, 0.2)', showlegend: false },
                { x: forecast.ds, y: forecast.y, mode: 'markers', type: 'scatter', name: 'ì‹¤ì œ ê°€ê²©' },
                { x: forecast.ds, y: forecast.yhat, mode: 'lines', type: 'scatter', name: 'ì˜ˆì¸¡ ê°€ê²©', line: { color: 'blue' } }
              ], { title: 'í–¥í›„ 30ì¼ ê¸ˆ ì‹œì„¸ ì˜ˆì¸¡', xaxis: { title: 'ë‚ ì§œ' }, yaxis: { title: 'ê°€ê²© (ì›/g)' } });

              // íŠ¸ë Œë“œ ê·¸ë˜í”„
              const trend = data.trend;
              Plotly.newPlot('trendPlot', [{ x: trend.ds, y: trend.y, mode: 'lines', type: 'scatter', name: 'íŠ¸ë Œë“œ' }], { title: 'ì‹œì„¸ íŠ¸ë Œë“œ', xaxis: { title: 'ë‚ ì§œ' }, yaxis: { title: 'íŠ¸ë Œë“œ ê°’' } });

              // ì£¼ê°„ ê³„ì ˆì„± ê·¸ë˜í”„
              const weekly = data.weekly;
              Plotly.newPlot('weeklyPlot', [{ x: weekly.x, y: weekly.y, mode: 'lines', type: 'scatter', name: 'ì£¼ê°„ ê³„ì ˆì„±' }], { title: 'ì£¼ê°„ ê³„ì ˆì„±', xaxis: { title: 'ìš”ì¼' }, yaxis: { title: 'ê³„ì ˆì„± ì˜í–¥' } });
          })
          .catch(error => {
              console.error('Error fetching forecast data:', error);
              loadingMsg.innerText = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. \nì˜¤ë¥˜: ' + error.message;
              loadingMsg.style.color = 'red';
          });
  }

  /**
   * ìš”ì¼, ì›”ë³„ íŠ¸ë Œë“œ ë¶„ì„ ë°ì´í„° ë¡œë“œ ë° ê·¸ë˜í”„ ê·¸ë¦¬ê¸° í•¨ìˆ˜
   */
  let weeklyChart = null;
  let yearlyChart = null;

  function loadOrderTrends() {
      const loadingMsg = document.getElementById('orderTrendsLoading');
      const weeklyCanvas = document.getElementById('salesWeeklyCanvas');
      const yearlyCanvas = document.getElementById('salesYearlyCanvas');

      loadingMsg.style.display = 'block';
      loadingMsg.innerText = 'ë¡œë”© ì¤‘...';

      // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ ì œê±°
      if (weeklyChart) {
          weeklyChart.destroy();
      }
      if (yearlyChart) {
          yearlyChart.destroy();
      }

      fetch('/api/statistics/order-trends')
          .then(response => {
              if (!response.ok) {
                  throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ' + response.statusText);
              }
              return response.json();
          })
          .then(data => {
              if (data.error) {
                  throw new Error(data.error);
              }

              loadingMsg.style.display = 'none';

              // ìš”ì¼ë³„ ë°ì´í„° ì¤€ë¹„
              const weeklyLabels = data.weekly_seasonality.map(d => d.day_name);
              const weeklyValues = data.weekly_seasonality.map(d => d.weekly_effect);
              const weeklyColors = weeklyValues.map(v => v > 0 ? 'crimson' : 'royalblue');

              weeklyChart = new Chart(weeklyCanvas, {
                  type: 'bar',
                  data: {
                      labels: weeklyLabels,
                      datasets: [{
                          label: 'ìš”ì¼ë³„ íš¨ê³¼',
                          data: weeklyValues,
                          backgroundColor: weeklyColors
                      }]
                  },
                  options: {
                      responsive: true,
                      plugins: {
                          title: {
                              display: true,
                              text: 'ìš”ì¼ë³„ ë§¤ì¶œ íŠ¸ë Œë“œ'
                          }
                      },
                      scales: {
                          x: {
                              title: {
                                  display: true,
                                  text: 'ìš”ì¼'
                              }
                          },
                          y: {
                              title: {
                                  display: true,
                                  text: 'ë§¤ì¶œ ì¦ê° íš¨ê³¼'
                              },
                              ticks: {
                                  callback: value => value.toLocaleString()
                              }
                          }
                      }
                  }
              });

              // ì›”ë³„ ë°ì´í„° ì¤€ë¹„
              const yearlyLabels = data.yearly_seasonality.map(d => d.month_name);
              const yearlyValues = data.yearly_seasonality.map(d => d.yearly_effect);

              yearlyChart = new Chart(yearlyCanvas, {
                  type: 'line',
                  data: {
                      labels: yearlyLabels,
                      datasets: [{
                          label: 'ì›”ë³„ íš¨ê³¼',
                          data: yearlyValues,
                          borderColor: 'teal',
                          backgroundColor: 'rgba(0, 128, 128, 0.1)',
                          tension: 0.4,
                          fill: true,
                          pointRadius: 5,
                          pointHoverRadius: 7
                      }]
                  },
                  options: {
                      responsive: true,
                      plugins: {
                          title: {
                              display: true,
                              text: 'ì›”ë³„ ë§¤ì¶œ íŠ¸ë Œë“œ'
                          }
                      },
                      scales: {
                          x: {
                              title: {
                                  display: true,
                                  text: 'ì›”'
                              }
                          },
                          y: {
                              title: {
                                  display: true,
                                  text: 'ë§¤ì¶œ ì¦ê° íš¨ê³¼'
                              },
                              ticks: {
                                  callback: value => value.toLocaleString()
                              }
                          }
                      }
                  }
              });

          })
          .catch(error => {
              console.error('Error fetching order trends data:', error);
              loadingMsg.innerText = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. \nì˜¤ë¥˜: ' + error.message;
              loadingMsg.style.color = 'red';
          });
  }

  // ì¹´í…Œê³ ë¦¬ë³„ ì´ìµë¥  ë¶„ì„ ë° ì˜ˆì¸¡ ë°ì´í„° ë¡œë“œ ë° ê·¸ë˜í”„ ê·¸ë¦¬ê¸° í•¨ìˆ˜ (Chart.jsë¡œ ë³€ê²½)
  function loadCategoryProfit() {
      const loadingDiv = document.getElementById("categoryProfitLoading");
      const plotDiv1 = document.getElementById("categoryProfitPlot1");
      const plotDiv2 = document.getElementById("categoryProfitPlot2");
      const plotDiv3 = document.getElementById("categoryProfitPlot3");

      loadingDiv.style.display = 'block';
      plotDiv1.style.display = 'none';
      plotDiv2.style.display = 'none';
      plotDiv3.style.display = 'none';

      // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
      if (categoryProfitCharts.chart1) categoryProfitCharts.chart1.destroy();
      if (categoryProfitCharts.chart2) categoryProfitCharts.chart2.destroy();
      if (categoryProfitCharts.chart3) categoryProfitCharts.chart3.destroy();

      fetch('/category_profit_dashboard.json')
        .then(res => res.json())
        .then(data => {
           console.log('ë°›ì€ ë°ì´í„°:', data);
           if (!data || !Array.isArray(data.category_sales) || !Array.isArray(data.category_margin)) {
              console.error('category_sales ë˜ëŠ” category_margin ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤.');
              return;  // ì—¬ê¸°ì„œ í•¨ìˆ˜ ì¢…ë£Œí•´ì„œ ì´í›„ ì—ëŸ¬ ë°©ì§€
          }

          loadingDiv.style.display = 'none';
          plotDiv1.style.display = 'block';
          plotDiv2.style.display = 'block';
          plotDiv3.style.display = 'block';

          const sales = data.category_sales;
          const margin = data.category_margin;
          const ts = data.category_timeseries;
          const forecast = data.category_forecast;

          // ì°¨íŠ¸ 1: ì¹´í…Œê³ ë¦¬ë³„ ì´ íŒë§¤ê¸ˆì•¡ (Chart.js)
          const ctx1 = document.getElementById('categoryProfitChart1').getContext('2d');
          categoryProfitCharts.chart1 = new Chart(ctx1, {
              type: 'bar',
              data: {
                  labels: sales.map(d => d.Category),
                  datasets: [{
                      label: 'ì´ íŒë§¤ê¸ˆì•¡',
                      data: sales.map(d => d.total_price),
                      backgroundColor: 'goldenrod',
                      borderColor: 'darkgoldenrod',
                      borderWidth: 1
                  }]
              },
              options: {
                  responsive: true,
                  plugins: {
                      title: {
                          display: true,
                          text: 'ì¹´í…Œê³ ë¦¬ë³„ ì´ íŒë§¤ê¸ˆì•¡',
                          font: { size: 16, weight: 'bold' }
                      }
                  },
                  scales: {
                      y: {
                          beginAtZero: true,
                          title: {
                              display: true,
                              text: 'ì´ íŒë§¤ê¸ˆì•¡ (ì›)'
                          },
                          ticks: {
                              callback: function(value) {
                                  return new Intl.NumberFormat('ko-KR').format(value) + 'ì›';
                              }
                          }
                      }
                  }
              }
          });

          // ì°¨íŠ¸ 2: ì¹´í…Œê³ ë¦¬ë³„ í‰ê·  ì´ìµë¥  (Chart.js)
          const ctx2 = document.getElementById('categoryProfitChart2').getContext('2d');
          categoryProfitCharts.chart2 = new Chart(ctx2, {
              type: 'bar',
              data: {
                  labels: margin.map(d => d.Category),
                  datasets: [{
                      label: 'í‰ê·  ì´ìµë¥ ',
                      data: margin.map(d => d.avg_profit_margin * 100), // í¼ì„¼íŠ¸ë¡œ ë³€í™˜
                      backgroundColor: 'seagreen',
                      borderColor: 'darkseagreen',
                      borderWidth: 1
                  }]
              },
              options: {
                  responsive: true,
                  plugins: {
                      title: {
                          display: true,
                          text: 'ì¹´í…Œê³ ë¦¬ë³„ í‰ê·  ì´ìµë¥ ',
                          font: { size: 16, weight: 'bold' }
                      }
                  },
                  scales: {
                      y: {
                          beginAtZero: true,
                          title: {
                              display: true,
                              text: 'í‰ê·  ì´ìµë¥  (%)'
                          },
                          ticks: {
                              callback: function(value) {
                                  return value.toFixed(2) + '%';
                              }
                          }
                      }
                  }
              }
          });

          // ì°¨íŠ¸ 3: ì¹´í…Œê³ ë¦¬ë³„ ìˆœì´ìµ ì‹œê³„ì—´ + ì˜ˆì¸¡ (Chart.js)
          const netprofit_ts = data.category_netprofit_timeseries;
          const netprofit_forecast = data.category_netprofit_forecast;

          const np_categories = [...new Set(netprofit_ts.map(d => d.Category))];
          const categoryColors = {
              "ê³¨ë“œë°”": "rgb(54, 162, 235)",
              "ê¸°ë…í’ˆ": "rgb(255, 159, 64)",
              "ì£¼ì–¼ë¦¬": "rgb(75, 192, 192)"
          };

          const datasets = [];

          // ì‹œê³„ì—´ ë°ì´í„°
          np_categories.forEach(cat => {
              const catData = netprofit_ts.filter(d => d.Category === cat);
              datasets.push({
                  label: cat,
                  data: catData.map(d => ({ x: d.Month, y: d.Net_Profit })),
                  borderColor: categoryColors[cat],
                  backgroundColor: categoryColors[cat] + '33',
                  tension: 0.1,
                  fill: false
              });
          });

          // ì˜ˆì¸¡ ë°ì´í„° (ì ìœ¼ë¡œ í‘œì‹œ)
          netprofit_forecast.forEach(f => {
              datasets.push({
                  label: `${f.Category} ì˜ˆì¸¡`,
                  data: [{ x: f.Month, y: f.Predicted_Net_Profit }],
                  backgroundColor: categoryColors[f.Category],
                  borderColor: categoryColors[f.Category],
                  pointRadius: 8,
                  pointHoverRadius: 10,
                  showLine: false
              });
          });

          const ctx3 = document.getElementById('categoryProfitChart3').getContext('2d');
          categoryProfitCharts.chart3 = new Chart(ctx3, {
              type: 'line',
              data: { datasets: datasets },
              options: {
                  responsive: true,
                  plugins: {
                      title: {
                          display: true,
                          text: 'ì¹´í…Œê³ ë¦¬ë³„ ìˆœì´ìµ ì‹œê³„ì—´ ë° ì˜ˆì¸¡ (2025ë…„ 7ì›”)',
                          font: { size: 16, weight: 'bold' }
                      }
                  },
                  scales: {
                      x: {
                          type: 'category',
                          title: {
                              display: true,
                              text: 'ì›”'
                          }
                      },
                      y: {
                          title: {
                              display: true,
                              text: 'ìˆœì´ìµ (ì›)'
                          },
                          ticks: {
                              callback: function(value) {
                                  return new Intl.NumberFormat('ko-KR').format(value) + 'ì›';
                              }
                          }
                      }
                  }
              }
          });
        })
        .catch(err => {
          loadingDiv.innerText = "ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
          console.error('ì´ìµë¥  ë¶„ì„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', err);
        });
  }

  // ì„±ë³„/ì—°ë ¹ëŒ€ë³„ ì°¨íŠ¸ (Chart.jsë¡œ ë³€ê²½)
  function loadDemographicsChart() {
      const loadingDiv = document.getElementById("sexAgeLoading");
      const plotDivMale = document.getElementById("genderAgeChartPlotMale");
      const plotDivFemale = document.getElementById("genderAgeChartPlotFemale");
      const topProductsDiv = document.getElementById("topProductsChart");
      const bottomProductsDiv = document.getElementById("bottomProductsChart");

      if (!loadingDiv || !plotDivMale || !plotDivFemale) {
          console.error("[ì„±ë³„/ì—°ë ¹ëŒ€] í•„ìš”í•œ divê°€ ì—†ìŠµë‹ˆë‹¤.");
          return;
      }

      loadingDiv.style.display = 'block';
      loadingDiv.innerText = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...';

      fetch("/demographics_dashboard.json")
          .then(response => response.json())
          .then(data => {
              if (!data || !data.male || !data.female) {
                  loadingDiv.innerText = "ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
                  return;
              }

              const maleData = data.male;
              const femaleData = data.female;
              const allData = [...maleData, ...femaleData];

              // ì—°ë ¹ëŒ€ì™€ ì¹´í…Œê³ ë¦¬ ì¶”ì¶œ
              const ageGroups = [...new Set(allData.map(d => d.Age_Group))].sort();
              const categories = [...new Set(allData.map(d => d.Category))];

              // HTMLì— Canvas ìš”ì†Œ ì¶”ê°€
              plotDivMale.innerHTML = '<canvas id="maleChart" width="400" height="300"></canvas>';
              plotDivFemale.innerHTML = '<canvas id="femaleChart" width="400" height="300"></canvas>';
              topProductsDiv.innerHTML = '<canvas id="topChart" width="400" height="200"></canvas>';
              bottomProductsDiv.innerHTML = '<canvas id="bottomChart" width="400" height="200"></canvas>';

              // ê¸°ì¡´ ì°¨íŠ¸ ì‚­ì œ
              if (demographicsCharts.male) demographicsCharts.male.destroy();
              if (demographicsCharts.female) demographicsCharts.female.destroy();
              if (demographicsCharts.top) demographicsCharts.top.destroy();
              if (demographicsCharts.bottom) demographicsCharts.bottom.destroy();

              // 1. ë‚¨ì„± ì°¨íŠ¸
              const maleCtx = document.getElementById('maleChart').getContext('2d');
              const maleDatasets = categories.map((category, index) => {
                  const colors = ['#3498db', '#2ecc71', '#f39c12', '#e74c3c', '#9b59b6'];
                  return {
                      label: category,
                      data: ageGroups.map(age => {
                          const item = maleData.find(d => d.Age_Group === age && d.Category === category);
                          return item ? item.Total_Price / 1000000 : 0; // ë°±ë§Œì› ë‹¨ìœ„
                      }),
                      backgroundColor: colors[index % colors.length] + '80',
                      borderColor: colors[index % colors.length],
                      borderWidth: 2
                  };
              });

              demographicsCharts.male = new Chart(maleCtx, {
                  type: 'bar',
                  data: {
                      labels: ageGroups,
                      datasets: maleDatasets
                  },
                  options: {
                      responsive: true,
                      plugins: {
                          title: {
                              display: true,
                              text: 'ğŸ‘¨ ë‚¨ì„± ì—°ë ¹ëŒ€ë³„ ì¹´í…Œê³ ë¦¬ ë§¤ì¶œ',
                              font: { size: 16, weight: 'bold' }
                          },
                          legend: {
                              position: 'bottom'
                          }
                      },
                      scales: {
                          x: {
                              stacked: true
                          },
                          y: {
                              stacked: true,
                              beginAtZero: true,
                              title: {
                                  display: true,
                                  text: 'ë§¤ì¶œ (ë°±ë§Œì›)'
                              },
                              ticks: {
                                  callback: function(value) {
                                      return new Intl.NumberFormat('ko-KR').format(value) + 'ë°±ë§Œì›';
                                  }
                              }
                          }
                      }
                  }
              });

              // 2. ì—¬ì„± ì°¨íŠ¸
              const femaleCtx = document.getElementById('femaleChart').getContext('2d');
              const femaleDatasets = categories.map((category, index) => {
                  const colors = ['#e74c3c', '#f39c12', '#9b59b6', '#3498db', '#2ecc71'];
                  return {
                      label: category,
                      data: ageGroups.map(age => {
                          const item = femaleData.find(d => d.Age_Group === age && d.Category === category);
                          return item ? item.Total_Price / 1000000 : 0; // ë°±ë§Œì› ë‹¨ìœ„
                      }),
                      backgroundColor: colors[index % colors.length] + '80',
                      borderColor: colors[index % colors.length],
                      borderWidth: 2
                  };
              });

              demographicsCharts.female = new Chart(femaleCtx, {
                  type: 'bar',
                  data: {
                      labels: ageGroups,
                      datasets: femaleDatasets
                  },
                  options: {
                      responsive: true,
                      plugins: {
                          title: {
                              display: true,
                              text: 'ğŸ‘© ì—¬ì„± ì—°ë ¹ëŒ€ë³„ ì¹´í…Œê³ ë¦¬ ë§¤ì¶œ',
                              font: { size: 16, weight: 'bold' }
                          },
                          legend: {
                              position: 'bottom'
                          }
                      },
                      scales: {
                          x: {
                              stacked: true
                          },
                          y: {
                              stacked: true,
                              beginAtZero: true,
                              title: {
                                  display: true,
                                  text: 'ë§¤ì¶œ (ë°±ë§Œì›)'
                              },
                              ticks: {
                                  callback: function(value) {
                                      return new Intl.NumberFormat('ko-KR').format(value) + 'ë°±ë§Œì›';
                                  }
                              }
                          }
                      }
                  }
              });

              // 3. Top ì œí’ˆ ì°¨íŠ¸ (data.top_bottomê°€ ìˆë‹¤ë©´)
              if (data.top_bottom && data.top_bottom.top3 && data.top_bottom.top3.length > 0) {
                  let allTopProducts = [];
                  data.top_bottom.top3.forEach(group => {
                      if (group.Products) {
                          group.Products.forEach(product => {
                              allTopProducts.push({
                                  name: product.Product_Name,
                                  sales: product.Total_Price,
                                  group: `${group.Gender} ${group.Age_Group}`
                              });
                          });
                      }
                  });

                  // ì¤‘ë³µ ì œí’ˆ ì œê±° ë° ìƒìœ„ 10ê°œ ì„ íƒ
                  const productMap = new Map();
                  allTopProducts.forEach(product => {
                      if (productMap.has(product.name)) {
                          productMap.get(product.name).sales += product.sales;
                      } else {
                          productMap.set(product.name, { name: product.name, sales: product.sales });
                      }
                  });

                  const top10Products = Array.from(productMap.values())
                      .sort((a, b) => b.sales - a.sales)
                      .slice(0, 10);

                  const topCtx = document.getElementById('topChart').getContext('2d');
                  demographicsCharts.top = new Chart(topCtx, {
                      type: 'bar',
                      data: {
                          labels: top10Products.map(p => p.name),
                          datasets: [{
                              label: 'ë§¤ì¶œì•¡',
                              data: top10Products.map(p => p.sales / 1000000), // ë°±ë§Œì› ë‹¨ìœ„
                              backgroundColor: 'rgba(46, 204, 113, 0.8)',
                              borderColor: '#2ecc71',
                              borderWidth: 2
                          }]
                      },
                      options: {
                          responsive: true,
                          indexAxis: 'y',
                          plugins: {
                              title: {
                                  display: true,
                                  text: 'ğŸ† ì¸ê¸° ì œí’ˆ TOP 10',
                                  font: { size: 16, weight: 'bold' }
                              }
                          },
                          scales: {
                              x: {
                                  beginAtZero: true,
                                  title: {
                                      display: true,
                                      text: 'ë§¤ì¶œì•¡ (ë°±ë§Œì›)'
                                  },
                                  ticks: {
                                      callback: function(value) {
                                          return new Intl.NumberFormat('ko-KR').format(value) + 'ë°±ë§Œì›';
                                      }
                                  }
                              }
                          }
                      }
                  });

                  // 4. Bottom ì œí’ˆ ì°¨íŠ¸
                  if (data.top_bottom.bottom3 && data.top_bottom.bottom3.length > 0) {
                      let allBottomProducts = [];
                      data.top_bottom.bottom3.forEach(group => {
                          if (group.Products) {
                              group.Products.forEach(product => {
                                  allBottomProducts.push({
                                      name: product.Product_Name,
                                      sales: product.Total_Price
                                  });
                              });
                          }
                      });

                      const bottom10Products = allBottomProducts
                          .sort((a, b) => a.sales - b.sales)
                          .slice(0, 10);

                      const bottomCtx = document.getElementById('bottomChart').getContext('2d');
                      demographicsCharts.bottom = new Chart(bottomCtx, {
                          type: 'bar',
                          data: {
                              labels: bottom10Products.map(p => p.name),
                              datasets: [{
                                  label: 'ë§¤ì¶œì•¡',
                                  data: bottom10Products.map(p => p.sales / 1000000), // ë°±ë§Œì› ë‹¨ìœ„
                                  backgroundColor: 'rgba(231, 76, 60, 0.8)',
                                  borderColor: '#e74c3c',
                                  borderWidth: 2
                              }]
                          },
                          options: {
                              responsive: true,
                              indexAxis: 'y',
                              plugins: {
                                  title: {
                                      display: true,
                                      text: 'ğŸ“‰ ì €ì¡°í•œ ì œí’ˆ BOTTOM 10',
                                      font: { size: 16, weight: 'bold' }
                                  }
                              },
                              scales: {
                                  x: {
                                      beginAtZero: true,
                                      title: {
                                          display: true,
                                          text: 'ë§¤ì¶œì•¡ (ë°±ë§Œì›)'
                                      },
                                      ticks: {
                                          callback: function(value) {
                                              return new Intl.NumberFormat('ko-KR').format(value) + 'ë°±ë§Œì›';
                                          }
                                      }
                                  }
                              }
                          }
                      });
                  }
              }

              // ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
              loadingDiv.style.display = "none";
          })
          .catch(error => {
              loadingDiv.innerText = "ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
              console.error("âŒ JSON ë¡œë”© ì˜¤ë¥˜:", error);
          });
  }
</script>

<script>
  // ê¸°ë³¸ ìƒíƒœ
  let currentPeriod = 'month';
  let showForecast = true;

  // ì°¨íŠ¸ ì´ˆê¸°í™”
  function drawSalesAnalysisChart(data) {
    const plotDiv = document.getElementById('salesForecastPlot');
    if (!plotDiv) return;

    if (!data || data.length === 0) {
      plotDiv.style.display = 'none';
      document.getElementById('orderTrendsLoading').innerText = 'ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
      return;
    }

    const x = data.map(item => item.date);
    const ySales = data.map(item => item.sales);
    const yForecast = showForecast ? data.map(item => item.forecast) : [];

    const traces = [
      {
        x,
        y: ySales,
        mode: 'lines+markers',
        name: 'ì‹¤ì œ ë§¤ì¶œ',
        line: {color: 'blue'}
      }
    ];

    if(showForecast){
      traces.push({
        x,
        y: yForecast,
        mode: 'lines+markers',
        name: 'ì˜ˆì¸¡ ë§¤ì¶œ',
        line: {color: 'red', dash: 'dot'}
      });
    }

    Plotly.newPlot(plotDiv, traces, {
      title: `ë§¤ì¶œ ë¶„ì„ (${currentPeriod} ë‹¨ìœ„)`,
      xaxis: {title: 'ê¸°ê°„'},
      yaxis: {title: 'ë§¤ì¶œì•¡'},
      margin: { t: 40, b: 50 }
    });

    plotDiv.style.display = 'block';
    document.getElementById('orderTrendsLoading').style.display = 'none';
  }

  // ê¸°ê°„ ë³€ê²½ ì´ë²¤íŠ¸
  document.querySelectorAll('input[name="period"]').forEach(radio => {
    radio.addEventListener('change', e => {
      currentPeriod = e.target.value;
      fetchAndDrawChart();
    });
  });

  // ì˜ˆì¸¡ í‘œì‹œ on/off ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
  document.getElementById('toggleForecast').addEventListener('change', e => {
    showForecast = e.target.checked;
    fetchAndDrawChart();
  });

  // ì„œë²„ì—ì„œ ë°ì´í„° ë°›ì•„ì™€ì„œ ì°¨íŠ¸ ê·¸ë¦¬ê¸°
  function fetchAndDrawChart(){
    const loadingDiv = document.getElementById('orderTrendsLoading');
    const plotDiv = document.getElementById('salesForecastPlot');

    loadingDiv.style.display = 'block';
    loadingDiv.innerText = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...';
    plotDiv.style.display = 'none';

    fetch(`/api/sales-analysis?period=${currentPeriod}`)
      .then(res => res.json())
      .then(data => {
        if(!data || data.length === 0){
          loadingDiv.innerText = 'ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
          plotDiv.style.display = 'none';
          return;
        }
        drawSalesAnalysisChart(data);
      })
      .catch(err => {
        loadingDiv.innerText = 'ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        console.error(err);
      });
  }
</script>

<script>
  let salesChartInstance = null;

  /**
   * ì„œë²„ì—ì„œ ë§¤ì¶œ ë¶„ì„ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ ì°¨íŠ¸ì™€ í…Œì´ë¸”ì„ ê·¸ë¦¬ëŠ” ë©”ì¸ í•¨ìˆ˜
   */
  function loadSalesAnalysis() {
    const unit = document.getElementById('unit').value;
    const showForecast = document.getElementById('toggleForecast').checked;
    const loadingDiv = document.getElementById('salesAnalysisLoading');
    const chartCanvas = document.getElementById('salesChart');
    const tableDiv = document.getElementById('salesTableContainer');

    document.getElementById('toggleForecast').disabled = false;
    const predictParam = showForecast;

    loadingDiv.style.display = 'block';
    chartCanvas.style.display = 'none';
    tableDiv.style.display = 'none';

    fetch(`/api/statistics/sales-analysis?unit=${unit}&predict=${predictParam}`)
      .then(res => {
        if (!res.ok) throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (${res.status})`);
        return res.json();
      })
      .then(data => {
        if (data.error) throw new Error(data.error);

        let processedData = data;

        if (showForecast) {
          const lastActualIndex = data.findLastIndex(d => d.y !== null && d.y !== undefined);
          if (lastActualIndex !== -1) {
            const predictionLengths = {
              year: 2,
              month: 2,
              week: 2,
              day: 5
            };
            const predictionCount = predictionLengths[unit];
            const endIndex = lastActualIndex + 1 + predictionCount;
            processedData = data.slice(0, endIndex);
          }
        }

        let filteredData = processedData;
        const dataLength = processedData.length;

        if (unit === 'week') {
          const weekCount = 53;
          if (dataLength > weekCount) {
            filteredData = processedData.slice(dataLength - weekCount);
          }
        } else if (unit === 'day') {
          const dayCount = 31;
          if (dataLength > dayCount) {
            filteredData = processedData.slice(dataLength - dayCount);
          }
        } else if (unit === 'month') {
            filteredData = processedData.filter(d => d.ds >= '2024-01');
        }

        loadingDiv.style.display = 'none';
        chartCanvas.style.display = 'block';
        tableDiv.style.display = 'block';

        drawSalesChart(filteredData);
        drawSalesTable(filteredData);
      })
      .catch(err => {
        loadingDiv.style.display = 'block';
        loadingDiv.innerText = `ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ${err.message}`;
        loadingDiv.style.color = 'red';
        console.error('ë§¤ì¶œ ë¶„ì„ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', err);
      });
  }

  /**
   * ë°ì´í„°ë¥¼ ë°›ì•„ Chart.js ì°¨íŠ¸ë¥¼ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
   */
  function drawSalesChart(data) {
    const showForecast = document.getElementById('toggleForecast').checked;
    const unit = document.getElementById('unit').value;

    if (salesChartInstance) {
      salesChartInstance.destroy();
    }

    const labels = data.map(d => d.ds);
    const actualData = data.map(d => d.y);
    const forecastData = data.map(d => (d.yhat !== undefined && d.yhat !== null) ? d.yhat : null);

    const datasets = [{
      label: "ì‹¤ì œ ë§¤ì¶œ",
      data: actualData,
      borderColor: "rgba(54, 162, 235, 1)",
      backgroundColor: "rgba(54, 162, 235, 0.5)",
      type: 'bar',
      order: 2
    }];

    if (showForecast && forecastData.some(d => d !== null)) {
      datasets.push({
        label: "ì˜ˆì¸¡ ë§¤ì¶œ",
        data: forecastData,
        borderColor: "rgba(255, 99, 132, 1)",
        backgroundColor: "rgba(255, 99, 132, 0)",
        type: 'line',
        fill: false,
        tension: 0.1,
        order: 1
      });
    }

    const ctx = document.getElementById('salesChart').getContext('2d');
    salesChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: datasets
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return value.toLocaleString() + 'ì›';
              }
            }
          }
        },
        plugins: {
          tooltip: {
            mode: 'index',
            intersect: false
          },
          title: {
            display: true,
            font: {
              size: 16
            },
            text: `ë§¤ì¶œ ë¶„ì„ ë° ì˜ˆì¸¡ (${{year:'ì—°',month:'ì›”',week:'ì£¼',day:'ì¼'}[unit]} ë‹¨ìœ„)`
          }
        }
      }
    });
  }

  /**
   * ë°ì´í„°ë¥¼ ë°›ì•„ HTML í…Œì´ë¸”ì„ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
   */
  function drawSalesTable(data) {
    const tableBody = document.getElementById('salesTableBody');
    const showForecast = document.getElementById('toggleForecast').checked;

    tableBody.innerHTML = '';

    const reversedData = [...data].reverse();

    reversedData.forEach(d => {
      const row = document.createElement('tr');
      const yValue = d.y !== null && d.y !== undefined ? d.y.toLocaleString() + 'ì›' : 'N/A';
      let yhatValue = 'N/A';

      if (showForecast) {
        yhatValue = d.yhat !== null && d.yhat !== undefined ? d.yhat.toLocaleString() + 'ì›' : '-';
      }

      row.innerHTML = `
        <td>${d.ds}</td>
        <td>${yValue}</td>
        ${showForecast ? `<td>${yhatValue}</td>` : ''}
      `;
      tableBody.appendChild(row);
    });

    document.getElementById('forecastHeader').style.display = showForecast ? '' : 'none';
  }

  document.addEventListener('DOMContentLoaded', () => {
    const salesAnalysisTab = document.getElementById('salesAnalysis');
    if (salesAnalysisTab && salesAnalysisTab.classList.contains('active')) {
      loadSalesAnalysis();
    }

    const profitAnalysisTab = document.getElementById('profitAnalysis');
    if (profitAnalysisTab && profitAnalysisTab.classList.contains('active')) {
      loadProfitAnalysis();
    }
});
</script>

<!-- ìˆœì´ìµ ë¶„ì„ì„ ìœ„í•œ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
  let profitChartInstance = null;

  /**
   * ì„œë²„ì—ì„œ ìˆœì´ìµ ë¶„ì„ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ ì°¨íŠ¸ì™€ í…Œì´ë¸”ì„ ê·¸ë¦¬ëŠ” ë©”ì¸ í•¨ìˆ˜
   */
  function loadProfitAnalysis() {
    const unit = document.getElementById('profit_unit').value;
    const showForecast = document.getElementById('profit_toggleForecast').checked;
    const loadingDiv = document.getElementById('profitAnalysisLoading');
    const chartCanvas = document.getElementById('profitChart');
    const tableDiv = document.getElementById('profitTableContainer');

    document.getElementById('profit_toggleForecast').disabled = false;
    const predictParam = showForecast;

    loadingDiv.style.display = 'block';
    chartCanvas.style.display = 'none';
    tableDiv.style.display = 'none';

    fetch(`/api/statistics/profit-analysis?unit=${unit}&predict=${predictParam}`)
      .then(res => {
        if (!res.ok) throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (${res.status})`);
        return res.json();
      })
      .then(data => {
        if (data.error) throw new Error(data.error);

        let processedData = data;

        if (showForecast) {
          const lastActualIndex = data.findLastIndex(d => d.y !== null && d.y !== undefined);
          if (lastActualIndex !== -1) {
            const predictionLengths = { year: 2, month: 2, week: 2, day: 5 };
            const predictionCount = predictionLengths[unit];
            const endIndex = lastActualIndex + 1 + predictionCount;
            processedData = data.slice(0, endIndex);
          }
        }

        let filteredData = processedData;
        const dataLength = processedData.length;

        if (unit === 'week' && dataLength > 53) {
            filteredData = processedData.slice(dataLength - 53);
        } else if (unit === 'day' && dataLength > 31) {
            filteredData = processedData.slice(dataLength - 31);
        } else if (unit === 'month') {
            filteredData = processedData.filter(d => d.ds >= '2024-01');
        }

        loadingDiv.style.display = 'none';
        chartCanvas.style.display = 'block';
        tableDiv.style.display = 'block';

        drawProfitChart(filteredData);
        drawProfitTable(filteredData);
      })
      .catch(err => {
        loadingDiv.style.display = 'block';
        loadingDiv.innerText = `ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ${err.message}`;
        loadingDiv.style.color = 'red';
        console.error('ìˆœì´ìµ ë¶„ì„ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', err);
      });
  }

  /**
   * ë°ì´í„°ë¥¼ ë°›ì•„ ìˆœì´ìµ Chart.js ì°¨íŠ¸ë¥¼ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
   */
  function drawProfitChart(data) {
    const showForecast = document.getElementById('profit_toggleForecast').checked;
    const unit = document.getElementById('profit_unit').value;

    if (profitChartInstance) {
      profitChartInstance.destroy();
    }

    const labels = data.map(d => d.ds);
    const actualData = data.map(d => d.y);
    const forecastData = data.map(d => (d.yhat !== undefined && d.yhat !== null) ? d.yhat : null);

    const datasets = [{
      label: "ì‹¤ì œ ìˆœì´ìµ",
      data: actualData,
      borderColor: "rgba(75, 192, 192, 1)",
      backgroundColor: "rgba(75, 192, 192, 0.5)",
      type: 'bar',
      order: 2
    }];

    if (showForecast && forecastData.some(d => d !== null)) {
      datasets.push({
        label: "ì˜ˆì¸¡ ìˆœì´ìµ",
        data: forecastData,
        borderColor: "rgba(255, 159, 64, 1)",
        backgroundColor: "rgba(255, 159, 64, 0)",
        type: 'line',
        fill: false,
        tension: 0.1,
        order: 1
      });
    }

    const ctx = document.getElementById('profitChart').getContext('2d');
    profitChartInstance = new Chart(ctx, {
      type: 'bar',
      data: { labels: labels, datasets: datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            ticks: {
              callback: function(value) {
                return value.toLocaleString() + 'ì›';
              }
            }
          }
        },
        plugins: {
          tooltip: { mode: 'index', intersect: false },
          title: {
            display: true,
            font: { size: 16 },
            text: `ìˆœì´ìµ ë¶„ì„ ë° ì˜ˆì¸¡ (${{year:'ì—°',month:'ì›”',week:'ì£¼',day:'ì¼'}[unit]} ë‹¨ìœ„)`
          }
        }
      }
    });
  }

  /**
   * ë°ì´í„°ë¥¼ ë°›ì•„ ìˆœì´ìµ HTML í…Œì´ë¸”ì„ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
   */
  function drawProfitTable(data) {
    const tableBody = document.getElementById('profitTableBody');
    const showForecast = document.getElementById('profit_toggleForecast').checked;

    tableBody.innerHTML = '';
    const reversedData = [...data].reverse();

    reversedData.forEach(d => {
      const row = document.createElement('tr');
      const yValue = d.y !== null && d.y !== undefined ? d.y.toLocaleString() + 'ì›' : 'N/A';
      let yhatValue = 'N/A';

      if (showForecast) {
        yhatValue = d.yhat !== null && d.yhat !== undefined ? d.yhat.toLocaleString() + 'ì›' : '-';
      }

      row.innerHTML = `<td>${d.ds}</td><td>${yValue}</td>${showForecast ? `<td>${yhatValue}</td>` : ''}`;
      tableBody.appendChild(row);
    });

    document.getElementById('profit_forecastHeader').style.display = showForecast ? '' : 'none';
  }
</script>

<script>
  // ì¥ë°”êµ¬ë‹ˆ ì´íƒˆ ë¶„ì„ ì „ì—­ ë³€ìˆ˜
  let cartAnalysisData = null;

  /**
   * ì¸í„°ë™í‹°ë¸Œ ì¥ë°”êµ¬ë‹ˆ ì´íƒˆ ë¶„ì„ ì‹¤í–‰
   */
  function executeInteractiveCartAnalysis() {
    const threshold = document.getElementById('abandonmentThreshold').value;
    const loadingDiv = document.getElementById('interactiveAnalysisLoading');
    const executeBtn = document.getElementById('executeAnalysisBtn');

    hideAllAnalysisElements();
    loadingDiv.style.display = 'block';
    executeBtn.disabled = true;
    executeBtn.textContent = 'ì‹¤í–‰ ì¤‘...';

    console.log(`ğŸ›’ ìƒˆë¡œìš´ ë¶„ì„ ì‹¤í–‰ (ê¸°ì¤€: ${threshold}ì‹œê°„)`);

    fetch('/api/cart-analysis/execute', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ hours: parseInt(threshold) })
    })
    .then(response => response.json())
    .then(data => {
      console.log('Python ì‹¤í–‰ ê²°ê³¼:', data);

      if (data.status === 'success') {
        console.log(`âœ… ${threshold}ì‹œê°„ ê¸°ì¤€ ë¶„ì„ ì™„ë£Œ! ìƒˆ JSON íŒŒì¼ ìƒì„±ë¨`);
        return loadAnalysisJsonData(true);
      } else {
        throw new Error(data.message || 'Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨');
      }
    })
    .then(() => {
      console.log('âœ… ìƒˆë¡œìš´ ë¶„ì„ ê²°ê³¼ ë¡œë“œ ì™„ë£Œ');
      loadingDiv.style.display = 'none';
      executeBtn.disabled = false;
      executeBtn.textContent = 'ğŸ“Š ë¶„ì„ ì‹¤í–‰';

      showInteractiveAnalysisResults();
    })
    .catch(error => {
      console.error('âŒ ë¶„ì„ ì‹¤íŒ¨:', error);
      loadingDiv.style.display = 'none';
      executeBtn.disabled = false;
      executeBtn.textContent = 'ğŸ“Š ë¶„ì„ ì‹¤í–‰';

      showInteractiveError(error.message);
    });
  }

  /**
   * ê¸°ì¡´ ë¶„ì„ ê²°ê³¼ ë¡œë“œ
   */
  function loadExistingAnalysis() {
    console.log('ğŸ“‚ ê¸°ì¡´ ë¶„ì„ ê²°ê³¼ ë¡œë“œ ì‹œë„');

    hideAllAnalysisElements();
    document.getElementById('interactiveAnalysisLoading').style.display = 'block';

    loadAnalysisJsonData(false)
      .then(() => {
        console.log('âœ… ê¸°ì¡´ ê²°ê³¼ ë¡œë“œ ì™„ë£Œ');
        document.getElementById('interactiveAnalysisLoading').style.display = 'none';
        showInteractiveAnalysisResults();
      })
      .catch(error => {
        console.error('âŒ ê¸°ì¡´ ê²°ê³¼ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('interactiveAnalysisLoading').style.display = 'none';
        showInteractiveError('ê¸°ì¡´ ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¶„ì„ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
      });
  }

  /**
   * JSON ë¶„ì„ ë°ì´í„° ë¡œë“œ
   */
  function loadAnalysisJsonData() {
    console.log('ğŸ“‚ JSON íŒŒì¼ ë¡œë“œ ì‹œë„...');

    return fetch('/cart_abandonment_analysis.json')
      .then(response => {
        if (!response.ok) {
          throw new Error(`JSON íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. cart_abandonment_analysis.json íŒŒì¼ì´ src/main/resources/static/ í´ë”ì— ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.`);
        }
        console.log('âœ… JSON íŒŒì¼ ë¡œë“œ ì„±ê³µ!');
        return response.json();
      })
      .then(data => {
        if (data.error) {
          throw new Error(data.error);
        }

        cartAnalysisData = data;
        console.log('ğŸ“Š JSON ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', data);
        return data;
      });
  }

  /**
   * ì¸í„°ë™í‹°ë¸Œ ë¶„ì„ ê²°ê³¼ í‘œì‹œ
   */
  function showInteractiveAnalysisResults() {
    if (!cartAnalysisData) {
      showInteractiveError('ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    const { summary, charts, insights, threshold_analysis } = cartAnalysisData;

    // ìš”ì•½ ì¹´ë“œ ì—…ë°ì´íŠ¸
    updateSummaryCards(summary);

    // ì¸í„°ë™í‹°ë¸Œ ì°¨íŠ¸ ê·¸ë¦¬ê¸°
    drawInteractiveCharts(charts);

    // ì‹œê°„ëŒ€ë³„ ë¹„êµ ì°¨íŠ¸
    drawThresholdComparisonChart(threshold_analysis);

    // ì¸ì‚¬ì´íŠ¸ ì—…ë°ì´íŠ¸
    updateInsights(insights);

    // ëª¨ë“  ê²°ê³¼ ì˜ì—­ í‘œì‹œ
    document.getElementById('interactiveSummaryCards').style.display = 'block';
    document.getElementById('interactiveCharts').style.display = 'block';
    document.getElementById('thresholdComparison').style.display = 'block';
    document.getElementById('interactiveInsights').style.display = 'block';
  }

  /**
   * ìš”ì•½ ì¹´ë“œ ì—…ë°ì´íŠ¸
   */
  function updateSummaryCards(summary) {
    document.getElementById('iTotalItems').textContent = summary.total.toLocaleString();
    document.getElementById('iAbandonedItems').textContent = summary.abandoned.toLocaleString();
    document.getElementById('iActiveItems').textContent = summary.active.toLocaleString();
    document.getElementById('iAbandonmentRate').textContent = summary.rate + '%';
  }

  /**
   * ì¸í„°ë™í‹°ë¸Œ ì°¨íŠ¸ ê·¸ë¦¬ê¸°
   */
  function drawInteractiveCharts(charts) {
    // 1. ì´íƒˆë¥  ë„ë„›ì°¨íŠ¸
    const abandonmentData = charts.abandonment_donut.data;
    Plotly.newPlot('interactiveAbandonmentChart', [{
      values: abandonmentData.values,
      labels: abandonmentData.labels,
      type: 'pie',
      hole: 0.6,
      marker: { colors: abandonmentData.colors },
      textinfo: 'label+percent+value',
      textposition: 'outside',
      hovertemplate: '<b>%{label}</b><br>ê°œìˆ˜: %{value:,}<br>ë¹„ìœ¨: %{percent}<extra></extra>'
    }], {
      title: 'ğŸ“Š ì „ì²´ ì´íƒˆë¥ ',
      showlegend: true,
      margin: { t: 50, b: 50, l: 50, r: 50 }
    }, { responsive: true });

    // 2. ì‹œê°„ëŒ€ë³„ ë¼ì¸ì°¨íŠ¸
    const hourlyData = charts.hourly_line.data;
    Plotly.newPlot('interactiveHourlyChart', [{
      x: hourlyData.x,
      y: hourlyData.y,
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#4ECDC4', width: 3 },
      marker: { size: 8, color: '#FF6B6B' },
      fill: 'tonexty',
      fillcolor: 'rgba(78, 205, 196, 0.3)',
      hovertemplate: '<b>%{x}ì‹œ</b><br>ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€: %{y}ê±´<extra></extra>'
    }], {
      title: 'â° ì‹œê°„ëŒ€ë³„ ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ íŒ¨í„´',
      xaxis: { title: 'ì‹œê°„', dtick: 2 },
      yaxis: { title: 'ì¶”ê°€ ê±´ìˆ˜' },
      margin: { t: 50, b: 50, l: 50, r: 50 },
      annotations: [{
        x: hourlyData.peak_hour,
        y: hourlyData.peak_value,
        text: `í”¼í¬: ${hourlyData.peak_hour}ì‹œ<br>(${hourlyData.peak_value}ê±´)`,
        arrowcolor: 'red',
        arrowwidth: 2,
        bgcolor: 'yellow',
        bordercolor: 'red',
        borderwidth: 1
      }]
    }, { responsive: true });

    // 3. ìˆœë„ë³„ ë°”ì°¨íŠ¸
    const karatData = charts.karat_bar.data;
    Plotly.newPlot('interactiveKaratChart', [{
      x: karatData.x,
      y: karatData.y,
      type: 'bar',
      marker: {
        color: karatData.colors,
        line: { color: 'black', width: 1 }
      },
      hovertemplate: '<b>%{x}</b><br>ì´íƒˆ ê±´ìˆ˜: %{y:,}ê±´<extra></extra>'
    }], {
      title: 'ğŸ’ ìˆœë„ë³„ ì´íƒˆ í˜„í™©',
      xaxis: { title: 'ìˆœë„' },
      yaxis: { title: 'ì´íƒˆ ê±´ìˆ˜' },
      margin: { t: 50, b: 50, l: 50, r: 50 }
    }, { responsive: true });

    // 4. ì´íƒˆ ì‹œê°„ ë¶„í¬
    const timeData = charts.time_distribution.data;
    Plotly.newPlot('interactiveTimeChart', [{
      x: timeData.x,
      y: timeData.y,
      type: 'bar',
      marker: {
        color: timeData.colors,
        line: { color: 'black', width: 1 }
      },
      text: timeData.y.map((count, i) => `${count}ê±´<br>(${timeData.percentages[i].toFixed(1)}%)`),
      textposition: 'outside',
      hovertemplate: '<b>%{x}</b><br>ì´íƒˆ ê±´ìˆ˜: %{y:,}ê±´<br>ë¹„ìœ¨: %{text}<extra></extra>'
    }], {
      title: 'ğŸ“ˆ ì´íƒˆ ì‹œê°„ ë¶„í¬',
      xaxis: { title: 'ì´íƒˆ ì‹œê°„ êµ¬ê°„' },
      yaxis: { title: 'ì´íƒˆ ê±´ìˆ˜' },
      margin: { t: 50, b: 80, l: 50, r: 50 }
    }, { responsive: true });
  }

  /**
   * ì‹œê°„ëŒ€ë³„ ë¹„êµ ì°¨íŠ¸ ê·¸ë¦¬ê¸°
   */
  function drawThresholdComparisonChart(thresholdData) {
    Plotly.newPlot('thresholdComparisonChart', [{
      x: thresholdData.map(d => d.time_label),
      y: thresholdData.map(d => d.rate),
      type: 'bar',
      marker: {
        color: thresholdData.map(d => d.rate > 50 ? '#FF6B6B' : '#4ECDC4'),
        line: { color: 'black', width: 1 }
      },
      text: thresholdData.map(d => `${d.abandoned_count.toLocaleString()}ê°œ`),
      textposition: 'outside',
      hovertemplate: '<b>%{x} ê¸°ì¤€</b><br>ì´íƒˆë¥ : %{y}%<br>ì´íƒˆ ê±´ìˆ˜: %{text}<extra></extra>'
    }], {
      title: 'ë‹¤ì–‘í•œ ê¸°ì¤€ë³„ ì´íƒˆë¥  ë¹„êµ',
      xaxis: { title: 'ì´íƒˆ ê¸°ì¤€ ì‹œê°„' },
      yaxis: { title: 'ì´íƒˆë¥  (%)' },
      margin: { t: 50, b: 80, l: 50, r: 50 }
    }, { responsive: true });
  }

  /**
   * ì¸ì‚¬ì´íŠ¸ ì—…ë°ì´íŠ¸
   */
  function updateInsights(insights) {
    // í•µì‹¬ ë°œê²¬ì‚¬í•­
    const findings = insights.key_findings.map(finding => `â€¢ ${finding}`).join('<br>');
    document.getElementById('keyFindings').innerHTML = findings;

    // ì¶”ì²œ ì•¡ì…˜
    const recommendations = insights.recommendations.map((rec, index) => `${index + 1}. ${rec}`).join('<br>');
    document.getElementById('recommendations').innerHTML = recommendations;
  }

  /**
   * ëª¨ë“  ë¶„ì„ ê²°ê³¼ ì˜ì—­ ìˆ¨ê¸°ê¸°
   */
  function hideAllAnalysisElements() {
    const elements = [
      'interactiveSummaryCards', 'interactiveCharts',
      'thresholdComparison', 'interactiveInsights', 'interactiveAnalysisError'
    ];
    elements.forEach(id => {
      document.getElementById(id).style.display = 'none';
    });
  }

  /**
   * ì—ëŸ¬ í‘œì‹œ
   */
  function showInteractiveError(message) {
    document.getElementById('interactiveErrorContent').innerHTML = `<p>${message}</p>`;
    document.getElementById('interactiveAnalysisError').style.display = 'block';
  }
</script>

</body>
</html>