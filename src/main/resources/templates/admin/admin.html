<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>AuGold ê´€ë¦¬ì í˜ì´ì§€</title>
  <style>
    body { margin: 0; font-family: 'Segoe UI', sans-serif; }
    header {
        background-color: #343a40;
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .tab-bar {
        background-color: #f8f9fa;
        display: flex;
        border-bottom: 1px solid #dee2e6;
    }
    .tab-bar button {
        flex: 1;
        padding: 15px;
        font-size: 16px;
        border: none;
        background-color: #f8f9fa;
        cursor: pointer;
    }
    .tab-bar button.active {
        background-color: white;
        border-bottom: 3px solid goldenrod;
        font-weight: bold;
    }
    .content {
        padding: 30px;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 20px;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
    }
    th {
        background-color: #f2f2f2;
    }
    .form-container {
        margin-top: 30px;
        border: 1px solid #ccc;
        padding: 20px;
    }
    .form-container input, .form-container select {
        padding: 8px;
        margin: 5px 0;
        width: 100%;
    }
    .form-container button {
        margin-top: 10px;
        padding: 10px 20px;
        background-color: goldenrod;
        border: none;
        color: white;
        cursor: pointer;
    }
    .form-container .delete-btn {
        background-color: #dc3545;
        margin-left: 10px;
    }
  </style>
</head>
<body>

<header>
  <h2>ê´€ë¦¬ì í˜ì´ì§€</h2>
  <div>AuGold Admin</div>
</header>

<div class="tab-bar">
  <button class="tab-btn active" onclick="showTab('productTab')">ìƒí’ˆ ê´€ë¦¬</button>
  <button class="tab-btn" onclick="showTab('statsTab')">í†µê³„</button>
  <button class="tab-btn" onclick="showTab('receiptTab')">ì˜ìˆ˜ì¦ ë“±ë¡</button>
  <button class="tab-btn" onclick="showTab('inquiryTab')">ë¬¸ì˜ ë‹µë³€</button>
</div>

<div class="content">
  <div id="productTab" class="tab-content active">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h3>ìƒí’ˆ ê´€ë¦¬</h3>
      <button onclick="toggleForm()">ìƒí’ˆ ë“±ë¡</button>
    </div>

    <div class="form-container" id="productForm" style="display:none;">
      <form onsubmit="submitProduct(event)">
        <label>ìƒí’ˆ ID:
          <input type="text" name="productId" readonly>
        </label><br><br>
        <label>ìƒí’ˆëª…:
          <input type="text" name="productName" required>
        </label><br><br>
        <label>ì¹´í…Œê³ ë¦¬:
          <select name="ctgrId" required>
            <option value="">ì„ íƒ</option>
            <option value="0001">0001 [ì£¼ì–¼ë¦¬]</option>
            <option value="0002">0002 [ê³¨ë“œë°”]</option>
            <option value="0003">0003 [ê¸°ë…í’ˆ]</option>
          </select>
        </label><br><br>
        <label>ì„œë¸Œ ì¹´í…Œê³ ë¦¬:
          <select name="subCtgr" required>
            <option value="">ì„ íƒ</option>
            <option value="ê·€ê±¸ì´">ê·€ê±¸ì´</option>
            <option value="ë°˜ì§€">ë°˜ì§€</option>
            <option value="ëª©ê±¸ì´">ëª©ê±¸ì´</option>
            <option value="ê³¨ë“œë°”">ê³¨ë“œë°”</option>
            <option value="ê¸°ë…í’ˆ">ê¸°ë…í’ˆ</option>
          </select>
        </label><br><br>
        <label>ê¸ˆ í•¨ëŸ‰:
          <select name="karatCode" required>
            <option value="">ì„ íƒ</option>
            <option value="14K">14K</option>
            <option value="18K">18K</option>
            <option value="24K">24K</option>
          </select>
        </label><br><br>
        <label>ê¸ˆ ë¬´ê²Œ (g):
          <input type="number" name="goldWeight" step="0.01" required>
        </label><br><br>
        <label>ì›ê°€:
          <input type="number" name="basePrice" step="0.01" required>
        </label><br><br>
        <label>íŒë§¤ê°€:
          <input type="number" name="finalPrice" step="0.01" required>
        </label><br><br>
        <label>ìƒí’ˆ ì„¤ëª…:
          <input type="text" name="description">
        </label><br><br>
        <label>ëŒ€í‘œ ì´ë¯¸ì§€:
          <input type="file" name="imageFile" accept="image/*" required>
        </label><br><br>
        <label>ìƒì„¸ ì´ë¯¸ì§€1:
          <input type="file" name="detailImageFile1" accept="image/*">
        </label><br><br>
        <label>ìƒì„¸ ì´ë¯¸ì§€2:
          <input type="file" name="detailImageFile2" accept="image/*">
        </label><br><br>
        <label>ìƒì„¸ ì´ë¯¸ì§€3:
          <input type="file" name="detailImageFile3" accept="image/*">
        </label><br><br>
        <button type="submit">ìƒí’ˆ ì €ì¥</button>
        <button type="button" class="delete-btn" onclick="deleteProduct()" style="display: none;">ìƒí’ˆ ì‚­ì œ</button>
      </form>
    </div>

    <table id="productTable">
      <thead>
      <tr>
        <th>ID</th><th>ì´ë¦„</th><th>ê¸ˆ í•¨ëŸ‰</th><th>ì¹´í…Œê³ ë¦¬</th><th>ê°€ê²©</th><th>ë¬´ê²Œ</th><th>ìµœì¢…ê°€</th><th>ì„œë¸Œ</th>
      </tr>
      </thead>
      <tbody>
      <!-- JSë¡œ ìƒí’ˆëª©ë¡ ì¶”ê°€ -->
      </tbody>
    </table>
  </div>

  <!-- í†µê³„ ë¶€ë¶„ í…ŒìŠ¤íŠ¸ -->
  <div id="statsTab" class="tab-content">
    <h3>ê¸ˆ ì‹œì„¸ ì˜ˆì¸¡ í†µê³„</h3>

    <!-- Plotly.js CDN ì¶”ê°€ -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <!-- ê·¸ë˜í”„ê°€ ê·¸ë ¤ì§ˆ ì˜ì—­ë“¤ -->
    <div id="loadingMessage" style="text-align: center; padding: 50px; font-size: 1.2em;">
      ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
    </div>
    <div id="forecastPlot" class="plot-container" style="width: 90%; max-width: 900px; margin: 20px auto; display: none;"></div>
    <div id="trendPlot" class="plot-container" style="width: 90%; max-width: 900px; margin: 20px auto; display: none;"></div>
    <div id="weeklyPlot" class="plot-container" style="width: 90%; max-width: 900px; margin: 20px auto; display: none;"></div>
  </div>

  <div id="receiptTab" class="tab-content">
    <h3>ì˜ìˆ˜ì¦ ë“±ë¡</h3>
    <form id="receiptForm" enctype="multipart/form-data" onsubmit="uploadReceipt(event)">
      <h4>ì˜ìˆ˜ì¦ ì´ë¯¸ì§€ ì—…ë¡œë“œ</h4>
      <input type="file" name="receiptImage" accept="image/*" required><br><br>
      <button type="submit">ì—…ë¡œë“œ</button>
    </form>

    <div id="ocrResult" style="margin-top: 20px;"></div>
  </div>

  <div id="inquiryTab" class="tab-content">
    <h3>ë¬¸ì˜ ë‹µë³€</h3>

    <table id="inquiryTable">
      <thead>
      <tr>
        <th>#</th>
        <th>íšŒì›ë²ˆí˜¸</th>
        <th>ì œëª©</th>
        <th>ì²˜ë¦¬ìƒíƒœ</th>
        <th>ë¬¸ì˜ì¼ì‹œ</th>
      </tr>
      </thead>
      <tbody>
      <!-- JSê°€ ì´ ì˜ì—­ì„ ì±„ì›ë‹ˆë‹¤ -->
      </tbody>
    </table>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      fetchInquiries();
    });

    /**
     * ë¬¸ì˜ ëª©ë¡ì„ ì„œë²„ì—ì„œ ê°€ì ¸ì™€ í‘œì— ì±„ìš´ë‹¤
     */
    function fetchInquiries() {
      fetch('/api/inquiries')
        .then(res => {
          if (!res.ok) throw new Error("ë¬¸ì˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
          return res.json();
        })
        .then(data => {
          const tbody = document.querySelector("#inquiryTable tbody");
          tbody.innerHTML = "";  // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”

          data.forEach((inq, index) => {
            const row = `
              <tr>
                <td>${index + 1}</td>
                <td>${inq.cstmNumber}</td>
                <td>
                 <a href="/admin/inquiry/${inq.inqNumber}">${inq.inqTitle}</a>

                  </a>
                </td>
                <td>${inq.inqStatus}</td>
                <td>${new Date(inq.inqDate).toLocaleString()}</td>
              </tr>
            `;
            tbody.insertAdjacentHTML("beforeend", row);
          });
        })
        .catch(err => {
          console.error(err);
          alert(err.message);
        });
    }
  </script>


</div>

<script>
  let editing = false;
  let editProductId = null;



  function toggleForm(show = null) {
      const form = document.getElementById('productForm');
      form.style.display = (show === true || (show === null && form.style.display === 'none')) ? 'block' : 'none';
  }

  document.addEventListener('DOMContentLoaded', () => {
      document.querySelector('select[name="subCtgr"]').addEventListener("change", function () {
          const subCtgr = this.value;
          if (!subCtgr || editing) return;

          fetch(`/api/products/next-id?subCtgr=${encodeURIComponent(subCtgr)}`)
              .then(res => res.text())
              .then(productId => {
                  document.querySelector('#productForm input[name="productId"]').value = productId;
              });
      });

      fetchProducts();
  });

  function fetchProducts() {
      fetch('/api/products')
          .then(res => res.json())
          .then(data => {
              const tbody = document.querySelector("#productTable tbody");
              tbody.innerHTML = "";
              data.forEach(p => {
                  const row = `<tr>
                      <td>${p.productId}</td>
                      <td><a href="#" onclick="editProduct('${p.productId}')">${p.productName}</a></td>
                      <td>${p.karatCode}</td>
                      <td>${p.ctgrId}</td>
                      <td>${p.basePrice}</td>
                      <td>${p.goldWeight}</td>
                      <td>${p.finalPrice}</td>
                      <td>${p.subCtgr}</td>
                  </tr>`;
                  tbody.insertAdjacentHTML("beforeend", row);
              });
          });
  }

  function editProduct(id) {
      fetch(`/api/products/${id}`)
          .then(res => res.json())
          .then(p => {
              const form = document.querySelector('#productForm form');
              form.productId.value = p.productId;
              form.productName.value = p.productName;
              form.ctgrId.value = p.ctgrId;
              form.subCtgr.value = p.subCtgr;
              form.karatCode.value = p.karatCode;
              form.goldWeight.value = p.goldWeight;
              form.basePrice.value = p.basePrice;
              form.finalPrice.value = p.finalPrice;
              form.description.value = p.description;
              form.imageUrl.value = p.imageUrl;
              form.imageUrl1.value = p.imageUrl1 || "";
              form.imageUrl2.value = p.imageUrl2 || "";
              form.imageUrl3.value = p.imageUrl3 || "";

              editProductId = id;
              editing = true;
              toggleForm(true);
              form.querySelector("button[type='submit']").innerText = "ìƒí’ˆ ìˆ˜ì •";
              form.querySelector(".delete-btn").style.display = "inline-block";
          });
  }

function submitProduct(event) {
    event.preventDefault();
    const form = event.target;

    // JSON ëŒ€ì‹  FormData ì‚¬ìš© (íŒŒì¼ í¬í•¨ ê°€ëŠ¥)
    const formData = new FormData(form);

    // ìƒí’ˆ ID, ì´ë¦„ ë“± í…ìŠ¤íŠ¸ í•„ë“œë„ ìë™ìœ¼ë¡œ í¬í•¨ë¨

    const method = editing ? 'PUT' : 'POST';
    const url = editing ? `/api/products/${editProductId}` : '/api/products';

    fetch(url, {
        method: method,
        body: formData,  // FormData ê·¸ëŒ€ë¡œ ì „ë‹¬
        // Content-Type í—¤ë”ëŠ” fetchê°€ ìë™ìœ¼ë¡œ ì„¤ì •í•¨
    }).then(res => {
        if (res.ok) {
            alert(editing ? "ìˆ˜ì • ì™„ë£Œ!" : "ìƒí’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
            form.reset();
            toggleForm(false);
            fetchProducts();
            editing = false;
            editProductId = null;
            form.querySelector("button[type='submit']").innerText = "ìƒí’ˆ ì €ì¥";
            form.querySelector(".delete-btn").style.display = "none";
        } else {
            alert("ì €ì¥ ì‹¤íŒ¨");
        }
    });
}



  function deleteProduct() {
      if (!editProductId) return;
      if (!confirm("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

      fetch(`/api/products/${editProductId}`, {
          method: 'DELETE'
      }).then(res => {
          if (res.ok) {
              alert("ì‚­ì œ ì™„ë£Œ!");
              const form = document.querySelector('#productForm form');
              form.reset();
              toggleForm(false);
              fetchProducts();
              editing = false;
              editProductId = null;
              form.querySelector("button[type='submit']").innerText = "ìƒí’ˆ ì €ì¥";
              form.querySelector(".delete-btn").style.display = "none";
          } else {
              alert("ì‚­ì œ ì‹¤íŒ¨");
          }
      });
  }

  function uploadReceipt(event) {
      event.preventDefault();
      const form = document.getElementById("receiptForm");
      const formData = new FormData(form);

      fetch('/api/receipt/upload', {
          method: 'POST',
          body: formData
      })
      .then(res => res.json())
      .then(data => {
          document.getElementById("ocrResult").innerText = "ğŸ“„ OCR ê²°ê³¼:\n" + data.text;
      })
      .catch(err => {
          alert("ì—…ë¡œë“œ ì‹¤íŒ¨");
          console.error(err);
      });
  }
</script>

<script>
  /**
 * íƒ­ì„ ë³´ì—¬ì£¼ëŠ” í•¨ìˆ˜ë¥¼ ìˆ˜ì •í•˜ì—¬, í†µê³„ íƒ­ì´ ì²˜ìŒ ì—´ë¦´ ë•Œ ë°ì´í„°ë¥¼ ë¡œë“œí•˜ë„ë¡ í•¨.
 */
let statsLoaded = false; // í†µê³„ ë°ì´í„°ê°€ ì´ë¯¸ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” í”Œë˜ê·¸

function showTab(tabId) {
    const tabs = document.querySelectorAll('.tab-content');
    const buttons = document.querySelectorAll('.tab-btn');
    tabs.forEach(tab => tab.classList.remove('active'));
    buttons.forEach(btn => btn.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    event.target.classList.add('active');

    // í†µê³„ íƒ­ì„ ì²˜ìŒ í´ë¦­í–ˆì„ ë•Œë§Œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜´
    if (tabId === 'statsTab' && !statsLoaded) {
        loadGoldPriceForecast();
        statsLoaded = true; // ë¡œë“œë˜ì—ˆìŒì„ í‘œì‹œ
    }
}


/**
 * ê¸ˆ ì‹œì„¸ ì˜ˆì¸¡ ë°ì´í„°ë¥¼ ì„œë²„ì—ì„œ ë¹„ë™ê¸°ì ìœ¼ë¡œ ê°€ì ¸ì™€ ê·¸ë˜í”„ë¥¼ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
 */
function loadGoldPriceForecast() {
    const loadingMsg = document.getElementById('loadingMessage');
    const forecastPlotDiv = document.getElementById('forecastPlot');
    const trendPlotDiv = document.getElementById('trendPlot');
    const weeklyPlotDiv = document.getElementById('weeklyPlot');

    // ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
    loadingMsg.style.display = 'block';
    forecastPlotDiv.style.display = 'none';
    trendPlotDiv.style.display = 'none';
    weeklyPlotDiv.style.display = 'none';

    fetch('/api/statistics/gold-price-forecast')
        .then(response => {
            if (!response.ok) {
                throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }

            loadingMsg.style.display = 'none'; // ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°

            // ê·¸ë˜í”„ ì˜ì—­ ë³´ì´ê¸°
            forecastPlotDiv.style.display = 'block';
            trendPlotDiv.style.display = 'block';
            weeklyPlotDiv.style.display = 'block';

            // 1. ë©”ì¸ ì˜ˆì¸¡ ê·¸ë˜í”„ ê·¸ë¦¬ê¸° (ì´ì „ ë‹µë³€ì˜ JS ì½”ë“œì™€ ë™ì¼)
            const forecast = data.forecast;
            const traceActual = { x: forecast.ds, y: forecast.y, mode: 'markers', type: 'scatter', name: 'ì‹¤ì œ ê°€ê²©' };
            const tracePredicted = { x: forecast.ds, y: forecast.yhat, mode: 'lines', type: 'scatter', name: 'ì˜ˆì¸¡ ê°€ê²©', line: { color: 'blue' } };
            const traceUpperBand = { x: forecast.ds, y: forecast.yhat_upper, mode: 'lines', line: { width: 0 }, showlegend: false };
            const traceLowerBand = { x: forecast.ds, y: forecast.yhat_lower, mode: 'lines', line: { width: 0 }, fill: 'tonexty', fillcolor: 'rgba(0, 100, 255, 0.2)', showlegend: false };
            const forecastLayout = { title: 'í–¥í›„ 30ì¼ ê¸ˆ ì‹œì„¸ ì˜ˆì¸¡', xaxis: { title: 'ë‚ ì§œ' }, yaxis: { title: 'ê°€ê²© (ì›/g)' } };
            Plotly.newPlot('forecastPlot', [traceUpperBand, traceLowerBand, traceActual, tracePredicted], forecastLayout);

            // 2. íŠ¸ë Œë“œ ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
            const trend = data.trend;
            const trendTrace = { x: trend.ds, y: trend.y, mode: 'lines', type: 'scatter', name: 'íŠ¸ë Œë“œ' };
            const trendLayout = { title: 'ì‹œì„¸ íŠ¸ë Œë“œ', xaxis: { title: 'ë‚ ì§œ' }, yaxis: { title: 'íŠ¸ë Œë“œ ê°’' } };
            Plotly.newPlot('trendPlot', [trendTrace], trendLayout);

            // 3. ì£¼ê°„ ê³„ì ˆì„± ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
            const weekly = data.weekly;
            const weeklyTrace = { x: weekly.x, y: weekly.y, mode: 'lines', type: 'scatter', name: 'ì£¼ê°„ ê³„ì ˆì„±' };
            const weeklyLayout = { title: 'ì£¼ê°„ ê³„ì ˆì„±', xaxis: { title: 'ìš”ì¼' }, yaxis: { title: 'ê³„ì ˆì„± ì˜í–¥' } };
            Plotly.newPlot('weeklyPlot', [weeklyTrace], weeklyLayout);
        })
        .catch(error => {
            console.error('Error fetching forecast data:', error);
            loadingMsg.innerText = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. \nì˜¤ë¥˜: ' + error.message;
            loadingMsg.style.color = 'red';
        });
}

</script>

</body>
</html>