<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>AuGold ê´€ë¦¬ì í˜ì´ì§€</title>
  <style>
    body { margin: 0; font-family: 'Segoe UI', sans-serif; }
    header {
      background-color: #343a40;
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .tab-bar {
      background-color: #f8f9fa;
      display: flex;
      border-bottom: 1px solid #dee2e6;
    }
    .tab-bar button {
      flex: 1;
      padding: 15px;
      font-size: 16px;
      border: none;
      background-color: #f8f9fa;
      cursor: pointer;
    }
    .tab-bar button.active {
      background-color: white;
      border-bottom: 3px solid goldenrod;
      font-weight: bold;
    }
    .content {
      padding: 30px;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .stats-subtab-bar {
      margin-bottom: 20px;
      display: flex;
      border-bottom: 1px solid #ccc;
    }
    .stats-subtab-bar button {
      padding: 10px 15px;
      border: none;
      background-color: #eee;
      cursor: pointer;
      margin-right: 5px;
      font-size: 14px;
    }
    .stats-subtab-bar button.active {
      background-color: white;
      border-bottom: 3px solid goldenrod;
      font-weight: bold;
    }
    .stats-subtab-content { display: none; }
    .stats-subtab-content.active { display: block; }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }
    .form-container {
      margin-top: 30px;
      border: 1px solid #ccc;
      padding: 20px;
    }
    .form-container input, .form-container select, .form-container textarea {
      padding: 8px;
      margin: 5px 0;
      width: 100%;
      box-sizing: border-box;
    }
    .form-container button {
      margin-top: 10px;
      padding: 10px 20px;
      background-color: goldenrod;
      border: none;
      color: white;
      cursor: pointer;
    }
    .form-container .delete-btn {
      background-color: #dc3545;
      margin-left: 10px;
    }
  </style>

  <!-- Plotly.js CDN (í•œ ë²ˆë§Œ ì„ ì–¸) -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>

<body>

<header>
  <h2>ê´€ë¦¬ì í˜ì´ì§€</h2>
  <div>AuGold Admin</div>
</header>

<div class="tab-bar">
  <button class="tab-btn active" onclick="showTab('productTab', event)">ìƒí’ˆ ê´€ë¦¬</button>
  <button class="tab-btn" onclick="showTab('statsTab', event)">í†µê³„</button>
  <button class="tab-btn" onclick="showTab('receiptTab', event)">ì˜ìˆ˜ì¦ ë“±ë¡</button>
  <button class="tab-btn" onclick="showTab('inquiryTab', event)">ë¬¸ì˜ ë‹µë³€</button>
</div>

<div class="content">
  <!-- 1. ìƒí’ˆ ê´€ë¦¬ íƒ­ -->
  <div id="productTab" class="tab-content active">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h3>ìƒí’ˆ ê´€ë¦¬</h3>
      <button onclick="toggleForm()">ìƒí’ˆ ë“±ë¡</button>
    </div>

    <div class="form-container" id="productForm" style="display:none;">
      <form onsubmit="submitProduct(event)" enctype="multipart/form-data">
        <label>ìƒí’ˆ ID: <input type="text" name="productId" readonly></label><br>
        <label>ìƒí’ˆëª…: <input type="text" name="productName" required></label><br>
        <label>ì¹´í…Œê³ ë¦¬:
          <select name="ctgrId" required>
            <option value="">ì„ íƒ</option>
            <option value="CTGR-00001">CTGR-00001 [ì£¼ì–¼ë¦¬]</option>
            <option value="CTGR-00002">CTGR-00002 [ê³¨ë“œë°”]</option>
            <option value="CTGR-00003">CTGR-00003 [ê¸°ë…í’ˆ]</option>
          </select>
        </label><br>
        <label>ì„œë¸Œ ì¹´í…Œê³ ë¦¬:
          <select name="subCtgr" required>
            <option value="">ì„ íƒ</option>
            <option value="ê·€ê±¸ì´">ê·€ê±¸ì´</option>
            <option value="ë°˜ì§€">ë°˜ì§€</option>
            <option value="ëª©ê±¸ì´">ëª©ê±¸ì´</option>
            <option value="ê³¨ë“œë°”">ê³¨ë“œë°”</option>
            <option value="ê°ì‚¬íŒ¨">ê°ì‚¬íŒ¨</option>
            <option value="ëŒë°˜ì§€">ëŒë°˜ì§€</option>
            <option value="ì¹´ë„¤ì´ì…˜ ê¸°ë…í’ˆ">ì¹´ë„¤ì´ì…˜ ê¸°ë…í’ˆ</option>
          </select>
        </label><br>
        <label>ê¸ˆ í•¨ëŸ‰:
          <select name="karatCode" required>
            <option value="">ì„ íƒ</option>
            <option value="14K">14K</option>
            <option value="18K">18K</option>
            <option value="24K">24K</option>
          </select>
        </label><br>
        <label>ê¸ˆ ë¬´ê²Œ (g): <input type="number" name="goldWeight" step="0.01" required></label><br>
        <label>ì›ê°€: <input type="number" name="basePrice" step="0.01" required></label><br>
        <label>íŒë§¤ê°€: <input type="number" name="finalPrice" step="0.01" required></label><br>
        <label>ìƒí’ˆ ì¬ê³  (Inventory): <input type="number" name="productInventory" value="0" required></label><br>
        <label>ì´ˆê¸° ì¬ê³ ëŸ‰ (Stock Quantity): <input type="number" name="stockQuantity" value="10" required></label><br>
        <label>ìƒí’ˆ ì„¤ëª…: <textarea name="description" rows="4"></textarea></label><br>
        <label>ëŒ€í‘œ ì´ë¯¸ì§€: <input type="file" name="imageFile" accept="image/*" required></label><br>
        <label>ìƒì„¸ ì´ë¯¸ì§€ (ì—¬ëŸ¬ ì¥ ì„ íƒ ê°€ëŠ¥): <input type="file" name="detailImages" accept="image/*" multiple></label><br>

        <button type="submit">ìƒí’ˆ ì €ì¥</button>
        <button type="button" class="delete-btn" onclick="deleteProduct()" style="display: none;">ìƒí’ˆ ì‚­ì œ</button>
      </form>
    </div>

    <table id="productTable">
      <thead>
      <tr>
        <th>ID</th><th>ì´ë¦„</th><th>ê¸ˆ í•¨ëŸ‰</th><th>ì¹´í…Œê³ ë¦¬</th><th>ê°€ê²©</th><th>ë¬´ê²Œ</th><th>ìµœì¢…ê°€</th><th>ì„œë¸Œ</th>
      </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- 2. í†µê³„ íƒ­ -->
  <div id="statsTab" class="tab-content">
    <h3>í†µê³„ ë¶„ì„</h3>
    <div class="stats-subtab-bar">
      <button class="stats-subtab-btn active" onclick="showStatsSubTab('orderTrends', event)">ë§¤ì¶œ íŠ¸ë Œë“œ ë¶„ì„</button>
      <button class="stats-subtab-btn" onclick="showStatsSubTab('goldPrice', event)">ê¸ˆ ì‹œì„¸ ë¶„ì„</button>
      <button class="stats-subtab-btn" onclick="showStatsSubTab('demographics', event)">ì„±ë³„/ì—°ë ¹ëŒ€ë³„ ë¶„ì„</button>
      <button class="stats-subtab-btn" onclick="showStatsSubTab('categoryProfit', event)">ì¹´í…Œê³ ë¦¬ë³„ ì´ìµë¥  ë¶„ì„</button>
    </div>

    <!-- 2-1. ë§¤ì¶œ íŠ¸ë Œë“œ ë¶„ì„ -->
    <div id="orderTrends" class="stats-subtab-content active">
      <div id="orderTrendsLoading" class="loading-message">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
      <div id="salesForecastPlot" class="plot-container" style="display: none;"></div>
      <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
        <div id="salesWeeklyPlot" class="plot-container" style="width: 90%; max-width: 480px; display: none;"></div>
        <div id="salesYearlyPlot" class="plot-container" style="width: 90%; max-width: 480px; display: none;"></div>
      </div>
    </div>

    <!-- 2-2. ê¸ˆ ì‹œì„¸ ë¶„ì„ -->
    <div id="goldPrice" class="stats-subtab-content">
      <div id="goldPriceLoading" class="loading-message">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
      <div id="forecastPlot" class="plot-container" style="display: none;"></div>
      <div id="trendPlot" class="plot-container" style="display: none;"></div>
      <div id="weeklyPlot" class="plot-container" style="display: none;"></div>
    </div>

    <!-- 2-3. ì„±ë³„/ì—°ë ¹ëŒ€ë³„ ë¶„ì„ -->
    <div id="demographics" class="stats-subtab-content">
      <div id="sexAgeLoading" class="loading-message">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
      <div style="display: flex; gap: 30px; justify-content: center;">
        <div id="genderAgeChartPlotMale" style="flex:1; min-width:350px;"></div>
        <div id="genderAgeChartPlotFemale" style="flex:1; min-width:350px;"></div>
      </div>
    </div>

    <!-- 2-4. ì¹´í…Œê³ ë¦¬ë³„ ì´ìµë¥  ë¶„ì„ -->
    <div id="categoryProfit" class="stats-subtab-content">
      <div id="categoryProfitLoading" class="loading-message">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
      <div id="categoryProfitPlot" class="plot-container" style="display: none;"></div>
    </div>
  </div>

  <!-- 3. ì˜ìˆ˜ì¦ ë“±ë¡ íƒ­ -->
  <div id="receiptTab" class="tab-content">
    <h3>ì˜ìˆ˜ì¦ ë“±ë¡</h3>
    <form id="receiptForm" enctype="multipart/form-data" onsubmit="uploadReceipt(event)">
      <h4>ì˜ìˆ˜ì¦ ì´ë¯¸ì§€ ì—…ë¡œë“œ</h4>
      <input type="file" name="receiptImage" accept="image/*" required><br><br>
      <button type="submit">ì—…ë¡œë“œ</button>
    </form>
    <div id="ocrResult" style="margin-top: 20px;"></div>
  </div>

  <!-- 4. ë¬¸ì˜ ë‹µë³€ íƒ­ -->
  <div id="inquiryTab" class="tab-content">
    <h3>ë¬¸ì˜ ë‹µë³€</h3>
    <table id="inquiryTable">
      <thead>
      <tr>
        <th>#</th><th>íšŒì›ë²ˆí˜¸</th><th>ì œëª©</th><th>ì²˜ë¦¬ìƒíƒœ</th><th>ë¬¸ì˜ì¼ì‹œ</th>
      </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
  // ==========================================================
  //  ê³µí†µ ë° ì´ˆê¸°í™” ë¡œì§
  // ==========================================================

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
  document.addEventListener('DOMContentLoaded', () => {
    fetchProducts();
    fetchInquiries();

    // ìƒí’ˆ ë“±ë¡ í¼ì˜ ì„œë¸Œì¹´í…Œê³ ë¦¬ ë³€ê²½ ì‹œ ID ìë™ ìƒì„± ì´ë²¤íŠ¸ ì—°ê²°
    document.querySelector('select[name="subCtgr"]').addEventListener("change", function () {
      if (editing) return; // ìˆ˜ì • ì¤‘ì¼ ë•ŒëŠ” IDë¥¼ ë³€ê²½í•˜ì§€ ì•ŠìŒ
      const subCtgr = this.value;
      if (!subCtgr) {
        document.querySelector('#productForm input[name="productId"]').value = '';
        return;
      }
      fetch(`/api/products/next-id?subCtgr=${encodeURIComponent(subCtgr)}`)
        .then(res => res.text())
        .then(productId => {
          document.querySelector('#productForm input[name="productId"]').value = productId;
        });
    });

    // í†µê³„ íƒ­ì˜ ê¸°ë³¸ í•˜ìœ„ íƒ­(ë§¤ì¶œ íŠ¸ë Œë“œ)ì„ ë¡œë“œ
    loadOrderTrends();
    orderTrendsLoaded = true;
  });

  // ë©”ì¸ íƒ­ ì „í™˜
  function showTab(tabId, event) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    event.currentTarget.classList.add('active');
  }

  // ==========================================================
  //  1. ìƒí’ˆ ê´€ë¦¬ ê´€ë ¨ í•¨ìˆ˜
  // ==========================================================

  let editing = false;
  let editProductId = null;

  function toggleForm(show = null) {
    const formContainer = document.getElementById('productForm');
    const form = formContainer.querySelector('form');
    const shouldShow = show === true || (show === null && formContainer.style.display === 'none');

    if (shouldShow) {
      if (!editing) { // 'ìƒí’ˆ ë“±ë¡' ëª¨ë“œì¼ ë•Œë§Œ í¼ ë¦¬ì…‹
        form.reset();
        form.querySelector("button[type='submit']").innerText = "ìƒí’ˆ ì €ì¥";
        form.querySelector(".delete-btn").style.display = "none";
      }
      formContainer.style.display = 'block';
    } else {
      formContainer.style.display = 'none';
      editing = false; // í¼ì´ ë‹«í ë•Œ ìˆ˜ì • ìƒíƒœ í•´ì œ
      editProductId = null;
    }
  }

  function fetchProducts() {
    fetch('/api/products')
      .then(res => res.json())
      .then(data => {
        const tbody = document.querySelector("#productTable tbody");
        tbody.innerHTML = "";
        data.forEach(p => {
          const row = `<tr>
              <td>${p.productId}</td>
              <td><a href="#" onclick="editProduct('${p.productId}')">${p.productName}</a></td>
              <td>${p.karatCode}</td>
              <td>${p.ctgrId}</td>
              <td>${p.basePrice}</td>
              <td>${p.goldWeight}</td>
              <td>${p.finalPrice}</td>
              <td>${p.subCtgr}</td>
            </tr>`;
          tbody.insertAdjacentHTML("beforeend", row);
        });
      });
  }

  function editProduct(id) {
    fetch(`/api/products/${id}`)
      .then(res => res.json())
      .then(p => {
        const form = document.querySelector('#productForm form');
        // í¼ í•„ë“œ ì±„ìš°ê¸°
        for (const key in p) {
            if (form.elements[key]) {
                form.elements[key].value = p[key];
            }
        }

        editProductId = id;
        editing = true;
        toggleForm(true);
        form.querySelector("button[type='submit']").innerText = "ìƒí’ˆ ìˆ˜ì •";
        form.querySelector(".delete-btn").style.display = "inline-block";
      });
  }

  function submitProduct(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);

    // ìˆ˜ì • ëª¨ë“œì¼ ë•ŒëŠ” PUT, ë“±ë¡ ëª¨ë“œì¼ ë•ŒëŠ” POST
    const method = editing ? 'PUT' : 'POST';
    const url = editing ? `/api/products/${editProductId}` : '/api/products';

    fetch(url, { method: method, body: formData })
      .then(res => {
        if (res.ok) {
          alert(editing ? "ìƒí’ˆì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!" : "ìƒí’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
          toggleForm(false);
          fetchProducts();
        } else {
          res.text().then(text => alert("ì‘ì—… ì‹¤íŒ¨: " + text));
        }
      })
      .catch(err => {
        console.error("Fetch Error:", err);
        alert("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      });
  }

  function deleteProduct() {
    if (!editProductId || !confirm("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    fetch(`/api/products/${editProductId}`, { method: 'DELETE' })
      .then(res => {
        if (res.ok) {
          alert("ì‚­ì œ ì™„ë£Œ!");
          toggleForm(false);
          fetchProducts();
        } else {
          alert("ì‚­ì œ ì‹¤íŒ¨");
        }
      });
  }

  // ==========================================================
  //  2. í†µê³„ ê´€ë ¨ í•¨ìˆ˜
  // ==========================================================

  let goldPriceStatsLoaded = false;
  let orderTrendsLoaded = false;
  let categoryProfitLoaded = false;
  let demographicsLoaded = false;

  function showStatsSubTab(subTabId, event) {
    document.querySelectorAll('.stats-subtab-bar button').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.stats-subtab-content').forEach(content => content.classList.remove('active'));

    const subTabDiv = document.getElementById(subTabId);
    if (subTabDiv) {
      event.currentTarget.classList.add('active');
      subTabDiv.classList.add('active');
    }

    // ê° íƒ­ì„ ì²˜ìŒ í´ë¦­í•  ë•Œë§Œ ë°ì´í„° ë¡œë“œ
    if (subTabId === 'goldPrice' && !goldPriceStatsLoaded) {
      loadGoldPriceForecast();
      goldPriceStatsLoaded = true;
    } else if (subTabId === 'orderTrends' && !orderTrendsLoaded) {
      loadOrderTrends();
      orderTrendsLoaded = true;
    } else if (subTabId === 'categoryProfit' && !categoryProfitLoaded) {
      loadCategoryProfit();
      categoryProfitLoaded = true;
    } else if (subTabId === 'demographics' && !demographicsLoaded) {
      loadDemographicsChart();
      demographicsLoaded = true;
    }
  }

  function loadOrderTrends() {
    const loadingMsg = document.getElementById('orderTrendsLoading');
    loadingMsg.style.display = 'block';

    fetch('/api/statistics/order-trends')
      .then(res => res.json())
      .then(data => {
        if (data.error) throw new Error(data.error);
        loadingMsg.style.display = 'none';

        // ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
        document.getElementById('salesForecastPlot').style.display = 'block';
        document.getElementById('salesWeeklyPlot').style.display = 'block';
        document.getElementById('salesYearlyPlot').style.display = 'block';

        const forecastData = data.main_forecast;
        Plotly.newPlot('salesForecastPlot', [
            { x: forecastData.map(d => d.ds), y: forecastData.map(d => d.yhat_upper), mode: 'lines', line: { width: 0 }, showlegend: false },
            { x: forecastData.map(d => d.ds), y: forecastData.map(d => d.yhat_lower), mode: 'lines', line: { width: 0 }, fill: 'tonexty', fillcolor: 'rgba(65, 105, 225, 0.2)', showlegend: false },
            { x: forecastData.map(d => d.ds), y: forecastData.map(d => d.y), mode: 'markers', name: 'ì‹¤ì œ ë§¤ì¶œ'},
            { x: forecastData.map(d => d.ds), y: forecastData.map(d => d.yhat), mode: 'lines', name: 'ì˜ˆì¸¡ ë§¤ì¶œ'}
        ], { title: 'ì´ ë§¤ì¶œ ì˜ˆì¸¡ (í–¥í›„ 90ì¼)' });

        const weeklyData = data.weekly_seasonality;
        Plotly.newPlot('salesWeeklyPlot', [{ x: weeklyData.map(d => d.day_name), y: weeklyData.map(d => d.weekly_effect), type: 'bar' }], { title: 'ìš”ì¼ë³„ ë§¤ì¶œ íŠ¸ë Œë“œ' });

        const yearlyData = data.yearly_seasonality;
        Plotly.newPlot('salesYearlyPlot', [{ x: yearlyData.map(d => d.month_name), y: yearlyData.map(d => d.yearly_effect), mode: 'lines+markers' }], { title: 'ì›”ë³„ ë§¤ì¶œ íŠ¸ë Œë“œ' });
      })
      .catch(error => {
        loadingMsg.innerText = 'ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ' + error.message;
      });
  }

  function loadGoldPriceForecast() {
    const loadingMsg = document.getElementById('goldPriceLoading');
    loadingMsg.style.display = 'block';

    fetch('/api/statistics/gold-price-forecast')
      .then(res => res.json())
      .then(data => {
        if (data.error) throw new Error(data.error);
        loadingMsg.style.display = 'none';

        document.getElementById('forecastPlot').style.display = 'block';
        document.getElementById('trendPlot').style.display = 'block';
        document.getElementById('weeklyPlot').style.display = 'block';

        Plotly.newPlot('forecastPlot', [
          { x: data.forecast.ds, y: data.forecast.yhat_upper, mode: 'lines', line: { width: 0 }, showlegend: false },
          { x: data.forecast.ds, y: data.forecast.yhat_lower, mode: 'lines', fill: 'tonexty', showlegend: false },
          { x: data.forecast.ds, y: data.forecast.y, mode: 'markers', name: 'ì‹¤ì œ ê°€ê²©' },
          { x: data.forecast.ds, y: data.forecast.yhat, mode: 'lines', name: 'ì˜ˆì¸¡ ê°€ê²©' }
        ], { title: 'í–¥í›„ 30ì¼ ê¸ˆ ì‹œì„¸ ì˜ˆì¸¡' });
        Plotly.newPlot('trendPlot', [{ x: data.trend.ds, y: data.trend.y, mode: 'lines' }], { title: 'ì‹œì„¸ íŠ¸ë Œë“œ' });
        Plotly.newPlot('weeklyPlot', [{ x: data.weekly.x, y: data.weekly.y, mode: 'lines' }], { title: 'ì£¼ê°„ ê³„ì ˆì„±' });
      })
      .catch(error => {
        loadingMsg.innerText = 'ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ' + error.message;
      });
  }

  function loadDemographicsChart() {
    const loadingDiv = document.getElementById("sexAgeLoading");
    loadingDiv.style.display = 'block';

    fetch("/api/statistics/sex-age-chart") // âœ… ì‹¤ì œ API ì—”ë“œí¬ì¸íŠ¸ë¡œ ë³€ê²½
      .then(res => res.json())
      .then(data => {
        if (data.error) throw new Error(data.error);
        loadingDiv.style.display = "none";

        const maleData = data.male;
        const femaleData = data.female;
        const ageGroups = [...new Set([...maleData, ...femaleData].map(d => d.Age_Group))];
        const categories = [...new Set([...maleData, ...femaleData].map(d => d.Category))];

        const maleSeries = categories.map(cat => ({ x: ageGroups, y: ageGroups.map(ag => maleData.find(d=>d.Age_Group===ag && d.Category===cat)?.Total_Price||0), name: cat, type: 'bar' }));
        const femaleSeries = categories.map(cat => ({ x: ageGroups, y: ageGroups.map(ag => femaleData.find(d=>d.Age_Group===ag && d.Category===cat)?.Total_Price||0), name: cat, type: 'bar' }));
        const layout = { barmode: 'group', xaxis: { title: 'ì—°ë ¹ëŒ€' }, yaxis: { title: 'ì´ ë§¤ì¶œ' } };

        Plotly.newPlot("genderAgeChartPlotMale", maleSeries, { ...layout, title: 'ğŸ‘¨ ë‚¨ì„± í†µê³„' });
        Plotly.newPlot("genderAgeChartPlotFemale", femaleSeries, { ...layout, title: 'ğŸ‘© ì—¬ì„± í†µê³„' });
      })
      .catch(error => {
        loadingDiv.innerText = "ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: " + error.message;
      });
  }

  function loadCategoryProfit() {
      const loadingDiv = document.getElementById("categoryProfitLoading");
      loadingDiv.style.display = 'block';

      fetch('/api/statistics/category-profit')
          .then(res => res.json())
          .then(data => {
              if (data.error) throw new Error(data.error);
              loadingDiv.style.display = "none";
              document.getElementById('categoryProfitPlot').style.display = 'block';

              const forecast = data.forecast;
              Plotly.newPlot("categoryProfitPlot", [
                  { x: data.monthly.map(i => i.Month), y: data.monthly.map(i => i.Profit_Margin), mode: 'lines+markers', name: 'ì´ìµë¥ ' },
                  { x: [forecast.month], y: [forecast.predicted_margin], mode: 'markers', name: 'ì˜ˆì¸¡ê°’' }
              ], { title: 'ì¹´í…Œê³ ë¦¬ë³„ ì´ìµë¥  ë¶„ì„ ë° ì˜ˆì¸¡' });
          })
          .catch(err => {
              loadingDiv.innerText = "ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: " + err.message;
          });
  }

  // ==========================================================
  //  3. ì˜ìˆ˜ì¦ ê´€ë¦¬ í•¨ìˆ˜
  // ==========================================================
  function uploadReceipt(event) {
    event.preventDefault();
    const form = document.getElementById("receiptForm");
    const formData = new FormData(form);

    fetch('/api/receipt/upload', { method: 'POST', body: formData })
    .then(res => res.json())
    .then(data => {
        document.getElementById("ocrResult").innerText = "ğŸ“„ OCR ê²°ê³¼:\n" + data.text;
    })
    .catch(err => {
        alert("ì—…ë¡œë“œ ì‹¤íŒ¨");
        console.error(err);
    });
  }

  // ==========================================================
  //  4. ë¬¸ì˜ ê´€ë¦¬ í•¨ìˆ˜
  // ==========================================================
  function fetchInquiries() {
    fetch('/api/inquiries')
      .then(res => res.json())
      .then(data => {
        const tbody = document.querySelector("#inquiryTable tbody");
        tbody.innerHTML = "";
        data.forEach((inq, index) => {
          const row = `
            <tr>
              <td>${index + 1}</td>
              <td>${inq.cstmNumber}</td>
              <td><a href="/admin/inquiry/${inq.inqNumber}">${inq.inqTitle}</a></td>
              <td>${inq.inqStatus}</td>
              <td>${new Date(inq.inqDate).toLocaleString()}</td>
            </tr>`;
          tbody.insertAdjacentHTML("beforeend", row);
        });
      })
      .catch(err => console.error(err));
  }
</script>

</body>
</html>