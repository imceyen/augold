<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>AuGold 관리자 페이지</title>
  <style>
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #f5f8fa; }
    header {
        background-color: #2a3f54;
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    /* 카드형 대시보드 스타일 */
    .dashboard-cards {
        display: flex;
        gap: 24px;
        margin: 32px 0 24px 0;
        justify-content: space-between;
        padding: 0 24px;
    }
    .dashboard-card {
        flex: 1;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        padding: 32px 0 24px 0;
        text-align: center;
        color: #2a3f54;
        cursor: pointer;
        font-size: 1.1em;
        font-weight: 500;
        transition: box-shadow 0.2s, background 0.2s;
        border: 2px solid transparent;
    }
    .dashboard-card.active, .dashboard-card:hover {
        box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        background: #eaf3fb;
        border: 2px solid #1976d2;
        color: #1976d2;
    }
    .dashboard-card i {
        display: block;
        font-size: 2.2em;
        margin-bottom: 10px;
        color: #1976d2;
    }
    .content {
        padding: 30px 24px;
    }
    /* 기존 탭바 숨김 */
    .tab-bar { display: none; }
    /* 하단 카드/박스 스타일 */
    .tab-content {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        padding: 32px 24px;
        margin-bottom: 32px;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* 통계 하위 탭 스타일 */
    .stats-subtab-bar {
      display: flex;
      gap: 16px;
      padding: 0 24px;
      background: transparent;
      border-bottom: none;
      margin-bottom: 40px;
      justify-content: center;
    }
    .stats-subtab-bar button {
      background: #fff;
      color: #1976d2;
      border: 2px solid #e3eaf5;
      border-radius: 22px;
      box-shadow: 0 4px 16px rgba(25, 118, 210, 0.13);
      padding: 28px 48px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: box-shadow 0.18s, border 0.18s, color 0.18s, background 0.18s;
      margin-bottom: 0;
      outline: none;
      letter-spacing: 0.5px;
    }
    .stats-subtab-bar button.active {
      border: 3px solid #1976d2;
      color: #1976d2;
      background: #f5faff;
      box-shadow: 0 8px 32px rgba(25, 118, 210, 0.18);
      z-index: 2;
    }
    .stats-subtab-bar button:hover:not(.active) {
      border: 2px solid #90caf9;
      background: #f5faff;
      color: #1976d2;
      box-shadow: 0 4px 24px rgba(25, 118, 210, 0.13);
    }

    .stats-subtab-content {
        display: none;
    }
    .stats-subtab-content.active {
        display: block;
    }

    table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 20px;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
    }
    th {
        background-color: #f2f2f2;
    }
    .form-container {
        margin-top: 30px;
        border: 1px solid #ccc;
        padding: 20px;
    }
    .form-container input, .form-container select {
        padding: 8px;
        margin: 5px 0;
        width: 100%;
    }
    .form-container button {
        margin-top: 10px;
        padding: 10px 20px;
        background-color: goldenrod;
        border: none;
        color: white;
        cursor: pointer;
    }
    .form-container .delete-btn {
        background-color: #dc3545;
        margin-left: 10px;
    }
    /* 상품관리 표 modern 스타일 */
    #productTable {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-collapse: collapse;
        margin-top: 24px;
        width: 100%;
        font-size: 14px;
    }
    #productTable thead tr {
        background: #e3f2fd;
        border-bottom: 2px solid #1976d2;
    }
    #productTable th {
        color: #1565c0;
        font-weight: 600;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 16px 12px;
        text-align: center;
        border-bottom: 2px solid #1976d2;
    }
    #productTable td {
        padding: 16px 12px;
        text-align: center;
        border-bottom: 1px solid #e0e0e0;
        vertical-align: middle;
    }
    #productTable tbody tr {
        transition: background 0.15s ease;
    }
    #productTable tbody tr:hover {
        background: #f5f5f5;
    }
    #productTable tbody tr:nth-child(even) {
        background: #fafafa;
    }
    #productTable tbody tr:nth-child(even):hover {
        background: #f0f0f0;
    }
    /* 표 안 링크(상품명) 스타일 */
    #productTable a {
        color: #1976d2;
        text-decoration: none;
        font-weight: 500;
    }
    #productTable a:hover {
        color: #1565c0;
        text-decoration: underline;
    }

    /* 상품 등록 버튼 호버 효과 */
    .tab-content button[onclick="toggleForm()"]:hover {
        background: #1565c0 !important;
    }
  </style>



  <!-- 🔷 Plotly.js 업데이트된 버전 -->
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

</head>

<body>

<header>
  <h2>관리자 페이지</h2>
  <div style="display: flex; align-items: center; gap: 20px;">
    <a href="/" style="color: white; text-decoration: none; padding: 8px 16px; border: 1px solid white; border-radius: 4px; transition: all 0.2s;">홈</a>
    <a href="/logout" style="color: white; text-decoration: none; padding: 8px 16px; border: 1px solid white; border-radius: 4px; transition: all 0.2s;">로그아웃</a>
    <div>AuGold Admin</div>
  </div>
</header>

<!-- 상단 카드형 대시보드 -->
<div class="dashboard-cards">
  <div class="dashboard-card tab-btn active" onclick="showTab('productTab', event)">
    <i class="fa fa-cube"></i>
    상품 관리
  </div>
  <div class="dashboard-card tab-btn" onclick="showTab('statsTab', event)">
    <i class="fa fa-chart-bar"></i>
    통계
  </div>
  <div class="dashboard-card tab-btn" onclick="showTab('receiptTab', event)">
    <i class="fa fa-receipt"></i>
    영수증 등록
  </div>
  <div class="dashboard-card tab-btn" onclick="showTab('inquiryTab', event)">
    <i class="fa fa-question-circle"></i>
    문의 답변
  </div>
</div>

<div class="content">
  <!-- 상품 관리 -->
  <div id="productTab" class="tab-content active">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3 style="margin: 0; color: #1976d2; font-size: 24px; font-weight: 600;">상품 관리</h3>
      <button onclick="toggleForm()" style="background: #1976d2; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 8px;">
        <i class="fa fa-plus" style="font-size: 14px;"></i>
        상품 등록
      </button>
    </div>

    <div class="form-container" id="productForm" style="display:none;">
      <form onsubmit="submitProduct(event)" enctype="multipart/form-data">
        <label>상품 ID:
          <input type="text" name="productId" readonly>
        </label><br><br>
        <label>상품명:
          <input type="text" name="productName" required>
        </label><br><br>
        <label>카테고리:
          <select name="ctgrId" required>
            <option value="">선택</option>
            <option value="CTGR-00001">CTGR-00001 [주얼리]</option>
            <option value="CTGR-00002">CTGR-00002 [골드바]</option>
            <option value="CTGR-00003">CTGR-00003 [기념품]</option>
          </select>
        </label><br><br>
        <label>서브 카테고리:
          <select name="subCtgr" required>
            <option value="">선택</option>
            <option value="귀걸이">귀걸이</option>
            <option value="반지">반지</option>
            <option value="목걸이">목걸이</option>
            <option value="골드바">골드바</option>
            <option value="감사패">감사패</option>
            <option value="돌반지">돌반지</option>
            <option value="카네이션 기념품">카네이션 기념품</option>
          </select>
        </label><br><br>
        <label>금 함량:
          <select name="karatCode" required>
            <option value="">선택</option>
            <option value="14K">14K</option>
            <option value="18K">18K</option>
            <option value="24K">24K</option>
          </select>
        </label><br><br>
        <label>금 무게 (g):
          <input type="number" name="goldWeight" step="0.01" required>
        </label><br><br>
        <label>원가:
          <input type="number" name="basePrice" step="0.01" required>
        </label><br><br>
        <label>판매가:
          <input type="number" name="finalPrice" step="0.01" required>
        </label><br><br>
        <label>상품 설명:
          <input type="text" name="description">
        </label><br><br>
        <label>대표 이미지:
          <input type="file" name="imageFile" accept="image/*" required>
        </label><br><br>
        <label>상세 이미지 1:
          <input type="file" name="detailImage1" accept="image/*">
        </label><br><br>
        <label>상세 이미지 2:
          <input type="file" name="detailImage2" accept="image/*">
        </label><br><br>
        <label>상세 이미지 3:
          <input type="file" name="detailImage3" accept="image/*">
        </label><br><br>
        <label>상품 재고 (Inventory):
          <input type="number" name="productInventory" required>
        </label><br><br>
        <label>초기 재고량 (Stock Quantity):
          <input type="number" name="stockQuantity" value="10" required> <!-- 기본값 10으로 설정 -->
        </label><br><br>
        <button type="submit">상품 저장</button>
        <button type="button" class="delete-btn" onclick="deleteProduct()" style="display: none;">상품 삭제</button>
      </form>
    </div>

    <table id="productTable">
      <thead>
      <tr>
        <th>ID</th><th>이름</th><th>금 함량</th><th>카테고리</th><th>가격</th><th>무게</th><th>최종가</th><th>서브</th>
      </tr>
      </thead>
      <tbody>
      <!-- JS로 상품목록 추가 -->
      </tbody>
    </table>
  </div>

  <!-- 통계 탭 -->
  <div id="statsTab" class="tab-content">
    <h3>통계 분석</h3>

    <!-- 통계 하위 탭 버튼 -->
    <div class="stats-subtab-bar">
      <button class="stats-subtab-btn" onclick="showStatsSubTab('salesAnalysis', event)">매출 분석 및 예측</button>
      <button class="stats-subtab-btn" onclick="showStatsSubTab('profitAnalysis', event)">순이익 분석 및 예측</button>
      <button class="stats-subtab-btn active" onclick="showStatsSubTab('goldPrice', event)">금 시세 분석 및 예측</button>
      <button class="stats-subtab-btn" onclick="showStatsSubTab('demographics', event)">성별/연령대별 매출/구매패턴 분석</button>
      <button class="stats-subtab-btn" onclick="showStatsSubTab('orderTrends', event)">판매날짜 기반 주문 트렌드 분석</button>
      <button class="stats-subtab-btn" onclick="showStatsSubTab('categoryProfit', event)">카테고리별 이익률 분석/예측</button>
      <button class="stats-subtab-btn" onclick="showStatsSubTab('cartAbandonment', event)">장바구니 이탈 분석</button>
    </div>

    <!-- 매출 분석 탭 -->
    <div id="salesAnalysis" class="stats-subtab-content active">
      <h3>매출 분석 및 예측</h3>
      <!-- 컨트롤 영역 -->
      <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 20px;">
        <div>
          <label for="unit">분석 단위:</label>
          <select id="unit" onchange="loadSalesAnalysis()">
            <option value="day">일</option>
            <option value="week">주</option>
            <option value="month" selected>월</option>
            <option value="year">연</option>
          </select>
        </div>
        <div>
          <label>
            <input type="checkbox" id="toggleForecast" onchange="loadSalesAnalysis()" checked> 예측값 표시
          </label>
        </div>
      </div>
      <!-- 로딩 메시지 -->
      <div id="salesAnalysisLoading" style="text-align: center; padding: 40px; font-size: 1.1em; display: none;">
        데이터를 불러오는 중입니다...
      </div>
      <!-- 표와 차트를 담는 Flex 컨테이너 -->
      <div style="display: flex; gap: 20px; width: 100%;">
        <!-- 왼쪽: 데이터 표 -->
        <div id="salesTableContainer" style="flex: 1; max-height: 500px; overflow-y: auto; display: none;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
            <tr style="background-color: #f2f2f2;">
              <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">기간</th>
              <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">실제 매출</th>
              <th id="forecastHeader" style="padding: 8px; border: 1px solid #ddd; text-align: left;">예측 매출</th>
            </tr>
            </thead>
            <tbody id="salesTableBody"></tbody>
          </table>
        </div>
        <!-- 오른쪽: 차트 -->
        <div style="flex: 2; position: relative; height:500px;">
          <canvas id="salesChart"></canvas>
        </div>
      </div>
    </div>

    <!-- 순이익 분석 탭 -->
    <div id="profitAnalysis" class="stats-subtab-content">
      <h3>순이익 분석 및 예측</h3>
      <!-- 컨트롤 영역 -->
      <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 20px;">
        <div>
          <label for="profit_unit">분석 단위:</label>
          <select id="profit_unit" onchange="loadProfitAnalysis()">
            <option value="day">일</option>
            <option value="week">주</option>
            <option value="month" selected>월</option>
            <option value="year">연</option>
          </select>
        </div>
        <div>
          <label>
            <input type="checkbox" id="profit_toggleForecast" onchange="loadProfitAnalysis()" checked> 예측값 표시
          </label>
        </div>
      </div>
      <!-- 로딩 메시지 -->
      <div id="profitAnalysisLoading" style="text-align: center; padding: 40px; font-size: 1.1em; display: none;">
        데이터를 불러오는 중입니다...
      </div>
      <!-- 표와 차트를 담는 Flex 컨테이너 -->
      <div style="display: flex; gap: 20px; width: 100%;">
        <!-- 왼쪽: 데이터 표 -->
        <div id="profitTableContainer" style="flex: 1; max-height: 500px; overflow-y: auto; display: none;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
            <tr style="background-color: #f2f2f2;">
              <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">기간</th>
              <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">실제 순이익</th>
              <th id="profit_forecastHeader" style="padding: 8px; border: 1px solid #ddd; text-align: left;">예측 순이익</th>
            </tr>
            </thead>
            <!-- ✅ [수정된 부분] > 문자 제거 -->
            <tbody id="profitTableBody"></tbody>
          </table>
        </div>
        <!-- 오른쪽: 차트 -->
        <div style="flex: 2; position: relative; height:500px;">
          <canvas id="profitChart"></canvas>
        </div>
      </div>
    </div>


    <div id="orderTrends" class="stats-subtab-content">
      <h3>판매날짜 기반 주문 트렌드 분석</h3>
      <p>주문 날짜 데이터를 기반으로 요일별, 월별 매출 트렌드를 분석한 결과입니다.</p>

      <!-- 로딩 메시지 -->
      <div id="orderTrendsLoading" style="text-align: center; padding: 40px; font-size: 1.1em;">
        데이터를 불러오는 중입니다...
      </div>

      <!-- 차트가 나란히 그려질 영역 -->
      <div style="display: flex; gap: 30px; justify-content: center; flex-wrap: nowrap;">
        <!-- 1. 요일별 트렌드 차트 -->
        <div id="salesWeeklyPlot" style="flex:1; min-width:400px; max-width:600px;">
          <canvas id="salesWeeklyCanvas"></canvas>
        </div>

        <!-- 2. 월별 트렌드 차트 -->
        <div id="yearlyChart" style="flex:1; min-width:400px; max-width:600px;">
          <canvas id="salesYearlyCanvas"></canvas>
        </div>
      </div>
    </div>

    <div id="goldPrice" class="stats-subtab-content">
      <div id="loadingMessage" style="text-align: center; padding: 50px; font-size: 1.2em;">
        데이터를 불러오는 중입니다...
      </div>
      <div id="forecastPlot" class="plot-container" style="width: 90%; max-width: 900px; margin: 20px auto; display: none;"></div>
      <div id="trendPlot" class="plot-container" style="width: 90%; max-width: 900px; margin: 20px auto; display: none;"></div>
      <div id="weeklyPlot" class="plot-container" style="width: 90%; max-width: 900px; margin: 20px auto; display: none;"></div>
    </div>





    <!-- 📊 성별·연령대별 매출 차트 영역 -->
    <div id="demographics" class="stats-subtab-content">
      <!--<p>성별 및 연령대별 매출 분석 시각화 결과입니다.</p>-->
      <div id="sexAgeLoading" style="text-align: center; padding: 40px; font-size: 1.1em;">
        <!-- 데이터를 불러오는 중입니다...-->
      </div>

      <!-- Plotly 차트들 -->
      <div style="display: flex; gap: 30px; justify-content: center;">
        <div id="genderAgeChartPlotMale" style="flex:1; min-width:350px; max-width:600px;"></div>
        <div id="genderAgeChartPlotFemale" style="flex:1; min-width:350px; max-width:600px;"></div>
      </div>

      <div style="display: flex; gap: 40px; justify-content: center; margin-top: 40px;">
        <div id="topProductsChart" style="flex:1; min-width:500px; max-width:700px; height:520px;"></div>
        <div id="bottomProductsChart" style="flex:1; min-width:500px; max-width:700px; height:520px;"></div>
      </div>
    </div>





    <!-- 카테고리별 이익률 분석/예측 탭 -->
    <div id="categoryProfit" class="stats-subtab-content">
      <p>카테고리별 이익률 분석 및 예측 데이터를 보여주는 영역입니다.</p>
      <div id="categoryProfitLoading" style="text-align: center; padding: 50px; font-size: 1.2em;">
        데이터를 불러오는 중입니다...
      </div>
      <div id="categoryProfitPlot1" class="plot-container" style="width: 90%; max-width: 900px; margin: 20px auto; display: none;"></div>
      <div id="categoryProfitPlot2" class="plot-container" style="width: 90%; max-width: 900px; margin: 20px auto; display: none;"></div>
      <div id="categoryProfitPlot3" class="plot-container" style="width: 90%; max-width: 900px; margin: 20px auto; display: none;"></div>
    </div>
  </div>
  <div id="cartAbandonment" class="stats-subtab-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3>🛒 장바구니 이탈 분석 (인터랙티브)</h3>
      <div style="display: flex; gap: 15px; align-items: center;">
        <label>
          이탈 기준:
          <select id="abandonmentThreshold">
            <option value="1" selected>1시간</option>
            <option value="2">2시간</option>
            <option value="6">6시간</option>
            <option value="12">12시간</option>
            <option value="24">24시간</option>
          </select>
        </label>
        <button id="executeAnalysisBtn" onclick="executeInteractiveCartAnalysis()"
                style="padding: 10px 20px; background-color: #4ECDC4; color: white; border: none; border-radius: 5px; cursor: pointer;">
          📊 분석 실행
        </button>
        <button onclick="loadExistingAnalysis()"
                style="padding: 10px 15px; background-color: #17a2b8; color: white; border: none; border-radius: 5px; cursor: pointer;">
          📂 기존 결과 로드
        </button>
      </div>
    </div>

    <!-- 로딩 영역 -->
    <div id="interactiveAnalysisLoading" style="display: none; text-align: center; padding: 40px; border: 2px dashed #ddd; border-radius: 10px; margin-bottom: 20px;">
      <div style="font-size: 20px; margin-bottom: 10px;">🔄</div>
      <div style="font-size: 16px; color: #666;">장바구니 이탈 분석 실행 중...</div>
      <div style="font-size: 14px; color: #999; margin-top: 5px;">JSON 데이터 생성 중입니다</div>
    </div>

    <!-- 요약 통계 카드 -->
    <div id="interactiveSummaryCards" style="display: none;">
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
          <div style="font-size: 24px; font-weight: bold;" id="iTotalItems">-</div>
          <div style="font-size: 14px; opacity: 0.9;">총 아이템</div>
        </div>
        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
          <div style="font-size: 24px; font-weight: bold;" id="iAbandonedItems">-</div>
          <div style="font-size: 14px; opacity: 0.9;">이탈 아이템</div>
        </div>
        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
          <div style="font-size: 24px; font-weight: bold;" id="iActiveItems">-</div>
          <div style="font-size: 14px; opacity: 0.9;">활성 아이템</div>
        </div>
        <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
          <div style="font-size: 24px; font-weight: bold;" id="iAbandonmentRate">-</div>
          <div style="font-size: 14px; opacity: 0.9;">이탈률</div>
        </div>
      </div>
    </div>

    <!-- 인터랙티브 차트 영역 -->
    <div id="interactiveCharts" style="display: none;">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
        <!-- 이탈률 도넛차트 -->
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <div id="interactiveAbandonmentChart" style="height: 400px;"></div>
        </div>

        <!-- 시간대별 라인차트 -->
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <div id="interactiveHourlyChart" style="height: 400px;"></div>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
        <!-- 순도별 바차트 -->
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <div id="interactiveKaratChart" style="height: 400px;"></div>
        </div>

        <!-- 이탈 시간 분포 -->
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <div id="interactiveTimeChart" style="height: 400px;"></div>
        </div>
      </div>
    </div>

    <!-- 다양한 시간대별 이탈률 비교 -->
    <div id="thresholdComparison" style="display: none; margin-bottom: 30px;">
      <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <h4 style="margin-bottom: 15px;">📊 다양한 기준별 이탈률 비교</h4>
        <div id="thresholdComparisonChart" style="height: 400px;"></div>
      </div>
    </div>

    <!-- 인사이트 및 액션 아이템 -->
    <div id="interactiveInsights" style="display: none;">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <!-- 핵심 인사이트 -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px;">
          <h4 style="margin-bottom: 15px;">💡 핵심 발견사항</h4>
          <div id="keyFindings" style="line-height: 1.8; font-size: 14px;">
            <!-- JavaScript로 채워집니다 -->
          </div>
        </div>

        <!-- 즉시 실행 액션 -->
        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 8px;">
          <h4 style="margin-bottom: 15px;">🎯 추천 액션</h4>
          <div id="recommendations" style="line-height: 1.8; font-size: 14px;">
            <!-- JavaScript로 채워집니다 -->
          </div>
        </div>
      </div>
    </div>

    <!-- 에러 영역 -->
    <div id="interactiveAnalysisError" style="display: none; padding: 20px; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; color: #721c24;">
      <h4>❌ 분석 오류</h4>
      <div id="interactiveErrorContent"></div>
    </div>
  </div>



  <div id="receiptTab" class="tab-content">
    <h3>영수증 등록</h3>
    <form id="receiptForm" enctype="multipart/form-data" onsubmit="uploadReceipt(event)">
      <h4>영수증 이미지 업로드</h4>
      <input type="file" name="receiptImage" accept="image/*" required><br><br>
      <button type="submit">업로드</button>
    </form>

    <div id="ocrResult" style="margin-top: 20px;"></div>
  </div>

  <div id="inquiryTab" class="tab-content">
    <h3>문의 답변</h3>

    <table id="inquiryTable">
      <thead>
      <tr>
        <th>#</th>
        <th>회원번호</th>
        <th>제목</th>
        <th>처리상태</th>
        <th>문의일시</th>
      </tr>
      </thead>
      <tbody>
      <!-- JS가 이 영역을 채웁니다 -->
      </tbody>
    </table>
  </div>

  <script>


    /**
     * 문의 목록을 서버에서 가져와 표에 채운다
     */
    function fetchInquiries() {
      fetch('/api/inquiries')
        .then(res => {
          if (!res.ok) throw new Error("문의 목록을 불러오지 못했습니다.");
          return res.json();
        })
        .then(data => {
          const tbody = document.querySelector("#inquiryTable tbody");
          tbody.innerHTML = "";  // 기존 내용 초기화

          data.forEach((inq, index) => {
            const row = `
              <tr>
                <td>${index + 1}</td>
                <td>${inq.cstmNumber}</td>
                <td>
                 <a href="/admin/inquiry/${inq.inqNumber}">${inq.inqTitle}</a>
                </td>
                <td>${inq.inqStatus}</td>
                <td>${new Date(inq.inqDate).toLocaleString()}</td>
              </tr>
            `;
            tbody.insertAdjacentHTML("beforeend", row);
          });
        })
        .catch(err => {
          console.error(err);
          alert(err.message);
        });
    }
  </script>

</div>

<script>
  // 상품 관리 관련 변수 및 함수
  let editing = false;
  let editProductId = null;

  function toggleForm(show = null) {
      const form = document.getElementById('productForm');
      form.style.display = (show === true || (show === null && form.style.display === 'none')) ? 'block' : 'none';
  }

  // 페이지 로드 시 실행될 함수들
  document.addEventListener('DOMContentLoaded', () => {
      // 상품 관리 초기화
      document.querySelector('select[name="subCtgr"]').addEventListener("change", function () {
          const subCtgr = this.value;
          if (!subCtgr || editing) return;

          fetch(`/api/products/next-id?subCtgr=${encodeURIComponent(subCtgr)}`)
              .then(res => res.text())
              .then(productId => {
                  document.querySelector('#productForm input[name="productId"]').value = productId;
              });
      });
      fetchProducts();

      // 문의 관리 초기화
      fetchInquiries();

      // 기본 탭 설정 (여기서는 상품 관리 탭이 기본으로 활성화됨)
      // 만약 다른 탭을 기본으로 하고 싶다면 이 부분을 수정할 수 있습니다.
  });

  function fetchProducts() {
      fetch('/api/products')
          .then(res => res.json())
          .then(data => {
              const tbody = document.querySelector("#productTable tbody");
              tbody.innerHTML = "";
              data.forEach(p => {
                  const row = `<tr>
                      <td>${p.productId}</td>
                      <td><a href="#" onclick="editProduct('${p.productId}')">${p.productName}</a></td>
                      <td>${p.karatCode}</td>
                      <td>${p.ctgrId}</td>
                      <td>${p.basePrice}</td>
                      <td>${p.goldWeight}</td>
                      <td>${p.finalPrice}</td>
                      <td>${p.subCtgr}</td>
                  </tr>`;
                  tbody.insertAdjacentHTML("beforeend", row);
              });
          });
  }

  function editProduct(id) {
    fetch(`/api/products/${id}`)
        .then(res => res.json())
        .then(p => {
            const form = document.querySelector('#productForm form');
            form.productId.value = p.productId;
            form.productName.value = p.productName;
            form.ctgrId.value = p.ctgrId;
            form.subCtgr.value = p.subCtgr;
            form.karatCode.value = p.karatCode;
            form.goldWeight.value = p.goldWeight;
            form.basePrice.value = p.basePrice;
            form.finalPrice.value = p.finalPrice;
            form.description.value = p.description;

            editProductId = id;
            editing = true;
            toggleForm(true);
            form.querySelector("button[type='submit']").innerText = "상품 수정";
            form.querySelector(".delete-btn").style.display = "inline-block";
        });
  }

 function submitProduct(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    // const url = editing ? `/api/products/${editProductId}` : '/api/products';
    const url = '/api/products';

    // fetch 요청의 method는 항상 'POST'가 됩니다.
    fetch(url, { method: 'POST', body: formData })
        .then(res => {
            if (res.ok) {
                alert("상품이 등록되었습니다!");
                form.reset();
                toggleForm(false);
                fetchProducts();
            } else {
                // 서버에서 오는 에러 메시지를 보여주면 더 좋습니다.
                res.text().then(text => alert("저장 실패: " + text));
            }
        })
        .catch(err => {
            console.error("Fetch Error:", err);
            alert("요청 중 오류가 발생했습니다.");
        });
  }

  function deleteProduct() {
      if (!editProductId) return;
      if (!confirm("정말로 삭제하시겠습니까?")) return;

      fetch(`/api/products/${editProductId}`, { method: 'DELETE' })
        .then(res => {
          if (res.ok) {
              alert("삭제 완료!");
              const form = document.querySelector('#productForm form');
              form.reset();
              toggleForm(false);
              fetchProducts();
              editing = false;
              editProductId = null;
              form.querySelector("button[type='submit']").innerText = "상품 저장";
              form.querySelector(".delete-btn").style.display = "none";
          } else {
              alert("삭제 실패");
          }
      });
  }

  // 문의 관리 함수
  function fetchInquiries() {
      fetch('/api/inquiries')
        .then(res => {
          if (!res.ok) throw new Error("문의 목록을 불러오지 못했습니다.");
          return res.json();
        })
        .then(data => {
          const tbody = document.querySelector("#inquiryTable tbody");
          tbody.innerHTML = "";
          data.forEach((inq, index) => {
            const row = `
              <tr>
                <td>${index + 1}</td>
                <td>${inq.cstmNumber}</td>
                <td><a href="/admin/inquiry/${inq.inqNumber}">${inq.inqTitle}</a></td>
                <td>${inq.inqStatus}</td>
                <td>${new Date(inq.inqDate).toLocaleString()}</td>
              </tr>
            `;
            tbody.insertAdjacentHTML("beforeend", row);
          });
        })
        .catch(err => {
          console.error(err);
          alert(err.message);
        });
  }

  // 영수증 관리 함수
  function uploadReceipt(event) {
      event.preventDefault();
      const form = document.getElementById("receiptForm");
      const formData = new FormData(form);

      fetch('/api/receipt/upload', { method: 'POST', body: formData })
      .then(res => res.json())
      .then(data => {
          document.getElementById("ocrResult").innerText = "📄 OCR 결과:\n" + data.text;
      })
      .catch(err => {
          alert("업로드 실패");
          console.error(err);
      });
  }

  // --- 탭 및 통계 관련 로직 ---

  // 각 통계 탭의 데이터 로드 여부를 추적하는 플래그
  let goldPriceStatsLoaded = false;
  let orderTrendsLoaded = false;
  let categoryProfitLoaded = false;
  let demographicsLoaded = false;
  let cartAbandonmentLoaded = false;
  let profitAnalysisLoaded = false; // ✅ [추가된 부분]

  /**
   * 메인 탭 전환 함수
   */
  function showTab(tabId, event) {
      // 모든 탭 컨텐츠와 버튼 비활성화
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.dashboard-card').forEach(card => card.classList.remove('active'));

      // 클릭된 탭과 버튼 활성화
      document.getElementById(tabId).classList.add('active');
      event.currentTarget.classList.add('active');

      // '통계' 탭을 처음 열 때 기본 하위 탭 로직 실행
      if (tabId === 'statsTab') {
          // '판매날짜 기반 주문 트렌드 분석'을 기본 하위 탭으로 설정
          const defaultSubTabButton = document.querySelector('.stats-subtab-btn[onclick*="orderTrends"]');
          if (defaultSubTabButton && !defaultSubTabButton.classList.contains('active')) {
              showStatsSubTab('orderTrends', { currentTarget: defaultSubTabButton });
          }
      }
  }

  /**
   * 통계 하위 탭 전환 함수 (모든 하위 탭에 대해 한 번에 하나만 active)
   */
  function showStatsSubTab(subTabId, event) {
      // 모든 하위 탭 버튼과 컨텐츠 비활성화
      document.querySelectorAll('.stats-subtab-bar button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.stats-subtab-content').forEach(content => content.classList.remove('active'));

      // null 체크 추가
      const subTabDiv = document.getElementById(subTabId);
      if (!subTabDiv) {
          console.error(`[showStatsSubTab] id="${subTabId}"인 div가 없습니다.`);
          return;
      }

      // 클릭된 하위 탭 버튼과 컨텐츠 활성화
      if (event && event.currentTarget) {
          event.currentTarget.classList.add('active');
      }
      subTabDiv.classList.add('active');

      // 각 하위 탭에 맞는 데이터 로드 함수를 *필요할 때만* 호출
      if (subTabId === 'goldPrice' && !goldPriceStatsLoaded) {
          loadGoldPriceForecast();
          goldPriceStatsLoaded = true;
      } else if (subTabId === 'orderTrends' && !orderTrendsLoaded) {
          loadOrderTrends();
          orderTrendsLoaded = true;
      } else if (subTabId === 'categoryProfit' && !categoryProfitLoaded) {
          loadCategoryProfit();
          categoryProfitLoaded = true;
      } else if (subTabId === 'demographics' && !demographicsLoaded) {
          loadDemographicsChart();
          demographicsLoaded = true;

      } else if (subTabId === 'cartAbandonment') {
      console.log('🛒 장바구니 이탈 분석 탭 활성화');
      } else if (subTabId === 'salesAnalysis' && document.getElementById('salesAnalysis').classList.contains('active')) {
          loadSalesAnalysis();
      }
      // ✅ [추가된 부분] 순이익 분석 탭을 처음 열 때 데이터 로드
      else if (subTabId === 'profitAnalysis' && !profitAnalysisLoaded) {
          loadProfitAnalysis();
          profitAnalysisLoaded = true;
      }


  }

  // --- 차트 로드 함수들 ---

  /**
   * 금 시세 예측 데이터 로드 및 그래프 그리기 함수
   */
  function loadGoldPriceForecast() {
      const loadingMsg = document.getElementById('loadingMessage');
      const plotDivs = ['forecastPlot', 'trendPlot', 'weeklyPlot'];

      loadingMsg.style.display = 'block';
      plotDivs.forEach(id => document.getElementById(id).style.display = 'none');

      fetch('/api/statistics/gold-price-forecast')
          .then(response => {
              if (!response.ok) throw new Error('서버 응답 오류: ' + response.statusText);
              return response.json();
          })
          .then(data => {
              if (data.error) throw new Error(data.error);

              loadingMsg.style.display = 'none';
              plotDivs.forEach(id => document.getElementById(id).style.display = 'block');

              // 예측 그래프
              const forecast = data.forecast;
              Plotly.newPlot('forecastPlot', [
                { x: forecast.ds, y: forecast.yhat_upper, mode: 'lines', line: { width: 0 }, showlegend: false },
                { x: forecast.ds, y: forecast.yhat_lower, mode: 'lines', line: { width: 0 }, fill: 'tonexty', fillcolor: 'rgba(0, 100, 255, 0.2)', showlegend: false },
                { x: forecast.ds, y: forecast.y, mode: 'markers', type: 'scatter', name: '실제 가격' },
                { x: forecast.ds, y: forecast.yhat, mode: 'lines', type: 'scatter', name: '예측 가격', line: { color: 'blue' } }
              ], { title: '향후 30일 금 시세 예측', xaxis: { title: '날짜' }, yaxis: { title: '가격 (원/g)' } });

              // 트렌드 그래프
              const trend = data.trend;
              Plotly.newPlot('trendPlot', [{ x: trend.ds, y: trend.y, mode: 'lines', type: 'scatter', name: '트렌드' }], { title: '시세 트렌드', xaxis: { title: '날짜' }, yaxis: { title: '트렌드 값' } });

              // 주간 계절성 그래프
              const weekly = data.weekly;
              Plotly.newPlot('weeklyPlot', [{ x: weekly.x, y: weekly.y, mode: 'lines', type: 'scatter', name: '주간 계절성' }], { title: '주간 계절성', xaxis: { title: '요일' }, yaxis: { title: '계절성 영향' } });
          })
          .catch(error => {
              console.error('Error fetching forecast data:', error);
              loadingMsg.innerText = '데이터를 불러오는 데 실패했습니다. \n오류: ' + error.message;
              loadingMsg.style.color = 'red';
          });
  }

  /**
   * 요일, 월별 트렌드 분석 데이터 로드 및 그래프 그리기 함수
   */
  let weeklyChart = null;
  let yearlyChart = null;

  function loadOrderTrends() {
      const loadingMsg = document.getElementById('orderTrendsLoading');
      const weeklyCanvas = document.getElementById('salesWeeklyCanvas');
      const yearlyCanvas = document.getElementById('salesYearlyCanvas');

      loadingMsg.style.display = 'block';
      loadingMsg.innerText = '로딩 중...';

      // 기존 차트가 있으면 제거
      if (weeklyChart) {
          weeklyChart.destroy();
      }
      if (yearlyChart) {
          yearlyChart.destroy();
      }

      fetch('/api/statistics/order-trends')
          .then(response => {
              if (!response.ok) {
                  throw new Error('서버 응답 오류: ' + response.statusText);
              }
              return response.json();
          })
          .then(data => {
              if (data.error) {
                  throw new Error(data.error);
              }

              loadingMsg.style.display = 'none';

              // 요일별 데이터 준비
              const weeklyLabels = data.weekly_seasonality.map(d => d.day_name);
              const weeklyValues = data.weekly_seasonality.map(d => d.weekly_effect);
              const weeklyColors = weeklyValues.map(v => v > 0 ? 'crimson' : 'royalblue');

              weeklyChart = new Chart(weeklyCanvas, {
                  type: 'bar',
                  data: {
                      labels: weeklyLabels,
                      datasets: [{
                          label: '요일별 효과',
                          data: weeklyValues,
                          backgroundColor: weeklyColors
                      }]
                  },
                  options: {
                      responsive: true,
                      plugins: {
                          title: {
                              display: true,
                              text: '요일별 매출 트렌드'
                          }
                      },
                      scales: {
                          x: {
                              title: {
                                  display: true,
                                  text: '요일'
                              }
                          },
                          y: {
                              title: {
                                  display: true,
                                  text: '매출 증감 효과'
                              },
                              ticks: {
                                  callback: value => value.toLocaleString()
                              }
                          }
                      }
                  }
              });

              // 월별 데이터 준비
              const yearlyLabels = data.yearly_seasonality.map(d => d.month_name);
              const yearlyValues = data.yearly_seasonality.map(d => d.yearly_effect);

              yearlyChart = new Chart(yearlyCanvas, {
                  type: 'line',
                  data: {
                      labels: yearlyLabels,
                      datasets: [{
                          label: '월별 효과',
                          data: yearlyValues,
                          borderColor: 'teal',
                          backgroundColor: 'rgba(0, 128, 128, 0.1)',
                          tension: 0.4,
                          fill: true,
                          pointRadius: 5,
                          pointHoverRadius: 7
                      }]
                  },
                  options: {
                      responsive: true,
                      plugins: {
                          title: {
                              display: true,
                              text: '월별 매출 트렌드'
                          }
                      },
                      scales: {
                          x: {
                              title: {
                                  display: true,
                                  text: '월'
                              }
                          },
                          y: {
                              title: {
                                  display: true,
                                  text: '매출 증감 효과'
                              },
                              ticks: {
                                  callback: value => value.toLocaleString()
                              }
                          }
                      }
                  }
              });

          })
          .catch(error => {
              console.error('Error fetching order trends data:', error);
              loadingMsg.innerText = '데이터를 불러오는 데 실패했습니다. \n오류: ' + error.message;
              loadingMsg.style.color = 'red';
          });
  }


  // ... 다른 스크립트 함수들 ...

  // '통계' 탭이 처음 열릴 때 기본으로 '판매날짜 기반 주문 트렌드 분석'을 로드하도록 설정
  // showTab 함수 내부에 아래와 비슷한 로직이 이미 있을 수 있습니다.
  if (tabId === 'statsTab' && !orderTrendsLoaded) {
      // orderTrendsLoaded 플래그를 사용하여 한 번만 로드하도록 함
      showStatsSubTab('orderTrends', { currentTarget: document.querySelector('.stats-subtab-btn[onclick*="orderTrends"]') });
      orderTrendsLoaded = true; // 로드되었음을 표시
  }

  // 카테고리별 이익률 분석 및 예측 데이터 로드 및 그래프 그리기 함수
  function loadCategoryProfit() {
      const plotDiv = document.getElementById("categoryProfitPlot");
      const loadingDiv = document.getElementById("categoryProfitLoading");
      if (!plotDiv || !loadingDiv) {
          console.error("[categoryProfit] 필요한 div가 없습니다.");
          return;
      }
      plotDiv.style.display = "none";
      loadingDiv.style.display = "block";

      fetch('/api/statistics/category-profit')
          .then(res => res.json())
          .then(data => {
              if (!data || !data.monthly || !data.forecast) {
                  loadingDiv.innerText = "데이터가 없습니다.";
                  return;
              }
              const months = data.monthly.map(item => item.Month);
              const margins = data.monthly.map(item => item.Profit_Margin);
              const forecast = data.forecast;

              loadingDiv.style.display = "none";
              plotDiv.style.display = "block";

              Plotly.newPlot("categoryProfitPlot", [
                  {
                      x: months,
                      y: margins,
                      mode: 'lines+markers',
                      name: '이익률',
                      line: { color: 'green' }
                  },
                  {
                      x: [forecast.month],
                      y: [forecast.predicted_margin],
                      mode: 'markers+text',
                      name: '예측값',
                      marker: { size: 10, color: 'red' },
                      text: ['예측'],
                      textposition: 'top center'
                  }
              ], {
                  title: '카테고리별 이익률 분석 및 7월 예측',
                  xaxis: { title: '월' },
                  yaxis: { title: '이익률' }
              });
          })
          .catch(err => {
              loadingDiv.innerText = "데이터 로딩 중 오류가 발생했습니다.";
              console.error('이익률 분석 불러오기 실패:', err);
          });
  }

// 성별/연령대별 차트 (탭 클릭 시에만 로드)
    function loadDemographicsChart() {
      const loadingDiv = document.getElementById("sexAgeLoading");
      const plotDivMale = document.getElementById("genderAgeChartPlotMale");
      const plotDivFemale = document.getElementById("genderAgeChartPlotFemale");
      if (!loadingDiv || !plotDivMale || !plotDivFemale) {
        console.error("[성별/연령대] 필요한 div가 없습니다.");
        return;
      }
      fetch("/temp_output.json")
        .then(response => response.json())
        .then(data => {
          if (!data || !data.male || !data.female) {
            loadingDiv.innerText = "데이터가 없습니다.";
            return;
          }
          const maleData = data.male;
          const femaleData = data.female;

          const ageGroups = [...new Set([...maleData, ...femaleData].map(d => d.Age_Group))];
          const categories = [...new Set([...maleData, ...femaleData].map(d => d.Category))];

          // 🔹 남성 데이터 시리즈 생성
          const maleSeries = categories.map(category => {
            return {
              x: ageGroups,
              y: ageGroups.map(ageGroup => {
                const item = maleData.find(d => d.Age_Group === ageGroup && d.Category === category);
                return item ? item.Total_Price : 0;
              }),
              name: `${category}`,
              type: 'bar'
            };
          });

          // 🔹 여성 데이터 시리즈 생성
          const femaleSeries = categories.map(category => {
            return {
              x: ageGroups,
              y: ageGroups.map(ageGroup => {
                const item = femaleData.find(d => d.Age_Group === ageGroup && d.Category === category);
                return item ? item.Total_Price : 0;
              }),
              name: `${category}`,
              type: 'bar'
            };
          });

          // 🔹 공통 레이아웃
          const baseLayout = {
            barmode: 'group',
            xaxis: { title: '연령대' },
            yaxis: { title: '총 매출 (원)' },
            legend: { orientation: 'h' },
            height: 450
          };

          // 🔹 남성/여성 각각의 차트로 나란히 출력
          Plotly.newPlot("genderAgeChartPlotMale", maleSeries, {
            ...baseLayout,
            title: '👨 남성 연령대별 · 카테고리별 매출'
          });
          Plotly.newPlot("genderAgeChartPlotFemale", femaleSeries, {
            ...baseLayout,
            title: '👩 여성 연령대별 · 카테고리별 매출'
          });

          // 🔹 로딩 메시지 숨기기
          loadingDiv.style.display = "none";
        })
        .catch(error => {
          loadingDiv.innerText = "데이터 로딩 중 오류가 발생했습니다.";
          console.error("❌ JSON 로딩 오류:", error);
        });
    }
</script>

<script>
  // 기본 상태
  let currentPeriod = 'month';
  let showForecast = true;


  // 차트 초기화
  function drawSalesAnalysisChart(data) {
    const plotDiv = document.getElementById('salesForecastPlot');
    if (!plotDiv) return;

    if (!data || data.length === 0) {
      plotDiv.style.display = 'none';
      document.getElementById('orderTrendsLoading').innerText = '데이터가 없습니다.';
      return;
    }

    // 예시 데이터 형태 가정: [{date:'2025-07', sales:1000, forecast:1100}, ...]
    const x = data.map(item => item.date);
    const ySales = data.map(item => item.sales);
    const yForecast = showForecast ? data.map(item => item.forecast) : [];

    const traces = [
      {
        x,
        y: ySales,
        mode: 'lines+markers',
        name: '실제 매출',
        line: {color: 'blue'}
      }
    ];

    if(showForecast){
      traces.push({
        x,
        y: yForecast,
        mode: 'lines+markers',
        name: '예측 매출',
        line: {color: 'red', dash: 'dot'}
      });
    }

    Plotly.newPlot(plotDiv, traces, {
      title: `매출 분석 (${currentPeriod} 단위)`,
      xaxis: {title: '기간'},
      yaxis: {title: '매출액'},
      margin: { t: 40, b: 50 }
    });

    plotDiv.style.display = 'block';
    document.getElementById('orderTrendsLoading').style.display = 'none';
  }

  // 기간 변경 이벤트
  document.querySelectorAll('input[name="period"]').forEach(radio => {
    radio.addEventListener('change', e => {
      currentPeriod = e.target.value;
      fetchAndDrawChart();
    });
  });

  // 예측 표시 on/off 체크박스 이벤트
  document.getElementById('toggleForecast').addEventListener('change', e => {
    showForecast = e.target.checked;
    fetchAndDrawChart();
  });

  // 서버에서 데이터 받아와서 차트 그리기 (예: /api/sales-analysis?period=month)
  function fetchAndDrawChart(){
    const loadingDiv = document.getElementById('orderTrendsLoading');
    const plotDiv = document.getElementById('salesForecastPlot');

    loadingDiv.style.display = 'block';
    loadingDiv.innerText = '데이터를 불러오는 중입니다...';
    plotDiv.style.display = 'none';

    fetch(`/api/sales-analysis?period=${currentPeriod}`)
      .then(res => res.json())
      .then(data => {
        if(!data || data.length === 0){
          loadingDiv.innerText = '데이터가 없습니다.';
          plotDiv.style.display = 'none';
          return;
        }
        drawSalesAnalysisChart(data);
      })
      .catch(err => {
        loadingDiv.innerText = '데이터 로딩 중 오류가 발생했습니다.';
        console.error(err);
      });
  }

</script>


<script> // 카테고리별 이익률 분석 및 예측 데이터 로드 및 그래프 그리기 함수
  function loadCategoryProfit() {
const loadingDiv = document.getElementById("categoryProfitLoading");
const plotDiv1 = document.getElementById("categoryProfitPlot1");
const plotDiv2 = document.getElementById("categoryProfitPlot2");
const plotDiv3 = document.getElementById("categoryProfitPlot3");

fetch('/api/statistics/category-profit')
  .then(res => res.json())
  .then(data => {
    loadingDiv.style.display = 'none';
    plotDiv1.style.display = 'block';
    plotDiv2.style.display = 'block';
    plotDiv3.style.display = 'block';

    const sales = data.category_sales;
    const margin = data.category_margin;
    const ts = data.category_timeseries;
    const forecast = data.category_forecast;

    // 차트 1: 카테고리별 총 판매금액
      Plotly.newPlot("categoryProfitPlot1", [{
        x: sales.map(d => d.Category),
        y: sales.map(d => d.total_price),
        type: 'bar',
        marker: { color: 'goldenrod' }
      }], {
        title: '카테고리별 총 판매금액',
        xaxis: { title: '카테고리' },
        yaxis: {
          title: '총 판매금액 (원)',
          tickformat: ',.0f',
          automargin: true,
          titlefont: { size: 14 },
          title: {
            text: '총 판매금액 (원)',
            standoff: 20 // ← Y축 제목과 축 사이 간격
          }
        },
        margin: {
          l: 100,
          r: 20,
          t: 50,
          b: 50
        }
      });


    // 차트 2: 카테고리별 평균 이익률
    Plotly.newPlot("categoryProfitPlot2", [{
      x: margin.map(d => d.Category),
      y: margin.map(d => d.avg_profit_margin),
      type: 'bar',
      marker: { color: 'seagreen' }
    }], {
      title: '카테고리별 평균 이익률',
      xaxis: { title: '카테고리' },
      yaxis: {
        title: '평균 이익률',
        tickformat: ',.2%',
        automargin: true,
        titlefont: { size: 14 },
        title: {
          text: '평균 이익률',
          standoff: 20
        }
      },
      margin: {
        l: 100,
        r: 20,
        t: 50,
        b: 50
      }
    });

   // 차트 3: 카테고리별 순이익 시계열 + 예측
const netprofit_ts = data.category_netprofit_timeseries;
const netprofit_forecast = data.category_netprofit_forecast;

const np_categories = [...new Set(netprofit_ts.map(d => d.Category))];
const np_traces = [];

// 시계열 선
np_categories.forEach(cat => {
const catData = netprofit_ts.filter(d => d.Category === cat);
np_traces.push({
  x: catData.map(d => d.Month),
  y: catData.map(d => d.Net_Profit),
  mode: 'lines+markers',
  name: cat
});
});


// 카테고리별 색상 매핑
const categoryColors = {
"골드바": "blue",
"기념품": "orange",
"주얼리": "green"
};

// 예측 점
netprofit_forecast.forEach(f => {
np_traces.push({
  x: [f.Month],
  y: [f.Predicted_Net_Profit],
  mode: 'markers+text',
  name: `${f.Category} 예측`,
  marker: { color: categoryColors[f.Category], size: 10 },
  text: ['예측'],
  textposition: 'top center'
});
});

Plotly.newPlot("categoryProfitPlot3", np_traces, {
title: '카테고리별 순이익 시계열 및 예측 (2025년 7월)',
xaxis: { title: '월' },
yaxis: {
  title: {
    text: '순이익 (원)',
    standoff: 50  // ✅ 간격을 넓혀서 겹침 방지
  },
  tickformat: ',.0f'
},
margin: {
  l: 100, // ✅ 왼쪽 마진도 넓혀줌
  r: 20,
  t: 50,
  b: 50
}
});



}); // ← fetch.then의 닫는 괄호
} // ← 함수의 닫는 괄호

</script>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script> //매출
  let salesChartInstance = null;

  /**
   * 서버에서 매출 분석 데이터를 가져와 차트와 테이블을 그리는 메인 함수
   * (HTML의 onchange 이벤트가 이 함수를 호출합니다)
   */
  function loadSalesAnalysis() {
    const unit = document.getElementById('unit').value;
    const showForecast = document.getElementById('toggleForecast').checked;
    const loadingDiv = document.getElementById('salesAnalysisLoading');
    const chartCanvas = document.getElementById('salesChart');
    const tableDiv = document.getElementById('salesTableContainer');

    document.getElementById('toggleForecast').disabled = false;
    const predictParam = showForecast;

    loadingDiv.style.display = 'block';
    chartCanvas.style.display = 'none';
    tableDiv.style.display = 'none';

    fetch(`/api/statistics/sales-analysis?unit=${unit}&predict=${predictParam}`)
      .then(res => {
        if (!res.ok) throw new Error(`서버 응답 오류 (${res.status})`);
        return res.json();
      })
      .then(data => {
        if (data.error) throw new Error(data.error);

        let processedData = data;

        // [1단계] 예측 기간 제한 로직 (단위별)
        if (showForecast) {
          const lastActualIndex = data.findLastIndex(d => d.y !== null && d.y !== undefined);
          if (lastActualIndex !== -1) {
            const predictionLengths = {
              year: 2,
              month: 2,
              week: 2,
              day: 5
            };
            const predictionCount = predictionLengths[unit];
            const endIndex = lastActualIndex + 1 + predictionCount;
            processedData = data.slice(0, endIndex);
          }
        }

        // [2단계] 표시할 과거 데이터 기간 필터링
        let filteredData = processedData;
        const dataLength = processedData.length;

        if (unit === 'week') {
          const weekCount = 53; // 최근 1년
          if (dataLength > weekCount) {
            filteredData = processedData.slice(dataLength - weekCount);
          }
        } else if (unit === 'day') {
          const dayCount = 31; // 최근 1달
          if (dataLength > dayCount) {
            filteredData = processedData.slice(dataLength - dayCount);
          }
        }
        // 🔽 [핵심 수정] 월 단위 데이터 필터링 (2024년 이후) 🔽
        else if (unit === 'month') {
            // 'ds' 필드가 '2024-01' 보다 크거나 같은 데이터만 필터링
            filteredData = processedData.filter(d => d.ds >= '2024-01');
        }
        // 🔼 [핵심 수정] 필터링 로직 끝 🔼


        loadingDiv.style.display = 'none';
        chartCanvas.style.display = 'block';
        tableDiv.style.display = 'block';

        drawSalesChart(filteredData);
        drawSalesTable(filteredData);
      })
      .catch(err => {
        loadingDiv.style.display = 'block';
        loadingDiv.innerText = `데이터 로딩 실패: ${err.message}`;
        loadingDiv.style.color = 'red';
        console.error('매출 분석 데이터 로딩 실패:', err);
      });
  }

  /**
   * 데이터를 받아 Chart.js 차트를 그리는 함수
   * @param {Array} data - 백엔드에서 받은 '필터링된' 데이터 배열
   */
  function drawSalesChart(data) {
    const showForecast = document.getElementById('toggleForecast').checked;
    const unit = document.getElementById('unit').value;

    if (salesChartInstance) {
      salesChartInstance.destroy();
    }

    const labels = data.map(d => d.ds);
    const actualData = data.map(d => d.y);
    const forecastData = data.map(d => (d.yhat !== undefined && d.yhat !== null) ? d.yhat : null);

    const datasets = [{
      label: "실제 매출",
      data: actualData,
      borderColor: "rgba(54, 162, 235, 1)",
      backgroundColor: "rgba(54, 162, 235, 0.5)",
      type: 'bar',
      order: 2
    }];

    if (showForecast && forecastData.some(d => d !== null)) {
      datasets.push({
        label: "예측 매출",
        data: forecastData,
        borderColor: "rgba(255, 99, 132, 1)",
        backgroundColor: "rgba(255, 99, 132, 0)",
        type: 'line',
        fill: false,
        tension: 0.1,
        order: 1
      });
    }

    const ctx = document.getElementById('salesChart').getContext('2d');
    salesChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: datasets
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return value.toLocaleString() + '원';
              }
            }
          }
        },
        plugins: {
          tooltip: {
            mode: 'index',
            intersect: false
          },
          title: {
            display: true,
            font: {
              size: 16
            },
            text: `매출 분석 및 예측 (${{year:'연',month:'월',week:'주',day:'일'}[unit]} 단위)`
          }
        }
      }
    });
  }

  /**
   * 데이터를 받아 HTML 테이블을 그리는 함수
   * @param {Array} data - 필터링된 데이터 배열
   */
  function drawSalesTable(data) {
    const tableBody = document.getElementById('salesTableBody');
    const showForecast = document.getElementById('toggleForecast').checked;

    tableBody.innerHTML = '';

    const reversedData = [...data].reverse();

    reversedData.forEach(d => {
      const row = document.createElement('tr');
      const yValue = d.y !== null && d.y !== undefined ? d.y.toLocaleString() + '원' : 'N/A';
      let yhatValue = 'N/A';

      if (showForecast) {
        yhatValue = d.yhat !== null && d.yhat !== undefined ? d.yhat.toLocaleString() + '원' : '-';
      }

      row.innerHTML = `
        <td>${d.ds}</td>
        <td>${yValue}</td>
        ${showForecast ? `<td>${yhatValue}</td>` : ''}
      `;
      tableBody.appendChild(row);
    });

    document.getElementById('forecastHeader').style.display = showForecast ? '' : 'none';
  }


  document.addEventListener('DOMContentLoaded', () => {
    // salesAnalysis 탭이 초기에 활성화 되어 있다면, 데이터를 로드합니다.
    const salesAnalysisTab = document.getElementById('salesAnalysis');
    if (salesAnalysisTab && salesAnalysisTab.classList.contains('active')) {
      loadSalesAnalysis();
    }

    // ✅ [추가된 부분] profitAnalysis 탭이 초기에 활성화 되어 있다면, 데이터를 로드합니다.
    const profitAnalysisTab = document.getElementById('profitAnalysis');
    if (profitAnalysisTab && profitAnalysisTab.classList.contains('active')) {
      loadProfitAnalysis();
    }
});
</script>


<!-- ✅ [추가된 부분] 순이익 분석을 위한 스크립트 -->
<script>
  let profitChartInstance = null;

  /**
   * 서버에서 순이익 분석 데이터를 가져와 차트와 테이블을 그리는 메인 함수
   */
  function loadProfitAnalysis() {
    const unit = document.getElementById('profit_unit').value;
    const showForecast = document.getElementById('profit_toggleForecast').checked;
    const loadingDiv = document.getElementById('profitAnalysisLoading');
    const chartCanvas = document.getElementById('profitChart');
    const tableDiv = document.getElementById('profitTableContainer');

    document.getElementById('profit_toggleForecast').disabled = false;
    const predictParam = showForecast;

    loadingDiv.style.display = 'block';
    chartCanvas.style.display = 'none';
    tableDiv.style.display = 'none';

    // ✅ API 경로를 profit-analysis로 변경
    fetch(`/api/statistics/profit-analysis?unit=${unit}&predict=${predictParam}`)
      .then(res => {
        if (!res.ok) throw new Error(`서버 응답 오류 (${res.status})`);
        return res.json();
      })
      .then(data => {
        if (data.error) throw new Error(data.error);

        let processedData = data;

        if (showForecast) {
          const lastActualIndex = data.findLastIndex(d => d.y !== null && d.y !== undefined);
          if (lastActualIndex !== -1) {
            const predictionLengths = { year: 2, month: 2, week: 2, day: 5 };
            const predictionCount = predictionLengths[unit];
            const endIndex = lastActualIndex + 1 + predictionCount;
            processedData = data.slice(0, endIndex);
          }
        }

        let filteredData = processedData;
        const dataLength = processedData.length;

        if (unit === 'week' && dataLength > 53) {
            filteredData = processedData.slice(dataLength - 53);
        } else if (unit === 'day' && dataLength > 31) {
            filteredData = processedData.slice(dataLength - 31);
        } else if (unit === 'month') {
            filteredData = processedData.filter(d => d.ds >= '2024-01');
        }

        loadingDiv.style.display = 'none';
        chartCanvas.style.display = 'block';
        tableDiv.style.display = 'block';

        drawProfitChart(filteredData);
        drawProfitTable(filteredData);
      })
      .catch(err => {
        loadingDiv.style.display = 'block';
        loadingDiv.innerText = `데이터 로딩 실패: ${err.message}`;
        loadingDiv.style.color = 'red';
        console.error('순이익 분석 데이터 로딩 실패:', err);
      });
  }

  /**
   * 데이터를 받아 순이익 Chart.js 차트를 그리는 함수
   */
  function drawProfitChart(data) {
    const showForecast = document.getElementById('profit_toggleForecast').checked;
    const unit = document.getElementById('profit_unit').value;

    if (profitChartInstance) {
      profitChartInstance.destroy();
    }

    const labels = data.map(d => d.ds);
    const actualData = data.map(d => d.y);
    const forecastData = data.map(d => (d.yhat !== undefined && d.yhat !== null) ? d.yhat : null);

    const datasets = [{
      label: "실제 순이익", // ✅ 레이블 변경
      data: actualData,
      borderColor: "rgba(75, 192, 192, 1)",   // ✅ 색상 변경 (초록 계열)
      backgroundColor: "rgba(75, 192, 192, 0.5)",
      type: 'bar',
      order: 2
    }];

    if (showForecast && forecastData.some(d => d !== null)) {
      datasets.push({
        label: "예측 순이익", // ✅ 레이블 변경
        data: forecastData,
        borderColor: "rgba(255, 159, 64, 1)", // ✅ 색상 변경 (주황 계열)
        backgroundColor: "rgba(255, 159, 64, 0)",
        type: 'line',
        fill: false,
        tension: 0.1,
        order: 1
      });
    }

    const ctx = document.getElementById('profitChart').getContext('2d');
    profitChartInstance = new Chart(ctx, {
      type: 'bar',
      data: { labels: labels, datasets: datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            ticks: {
              callback: function(value) {
                return value.toLocaleString() + '원';
              }
            }
          }
        },
        plugins: {
          tooltip: { mode: 'index', intersect: false },
          title: {
            display: true,
            font: { size: 16 },
            text: `순이익 분석 및 예측 (${{year:'연',month:'월',week:'주',day:'일'}[unit]} 단위)` // ✅ 제목 변경
          }
        }
      }
    });
  }

  /**
   * 데이터를 받아 순이익 HTML 테이블을 그리는 함수
   */
  function drawProfitTable(data) {
    const tableBody = document.getElementById('profitTableBody');
    const showForecast = document.getElementById('profit_toggleForecast').checked;

    tableBody.innerHTML = '';
    const reversedData = [...data].reverse();

    reversedData.forEach(d => {
      const row = document.createElement('tr');
      const yValue = d.y !== null && d.y !== undefined ? d.y.toLocaleString() + '원' : 'N/A';
      let yhatValue = 'N/A';

      if (showForecast) {
        yhatValue = d.yhat !== null && d.yhat !== undefined ? d.yhat.toLocaleString() + '원' : '-';
      }

      row.innerHTML = `<td>${d.ds}</td><td>${yValue}</td>${showForecast ? `<td>${yhatValue}</td>` : ''}`;
      tableBody.appendChild(row);
    });

    document.getElementById('profit_forecastHeader').style.display = showForecast ? '' : 'none';
  }
</script>


<script>
  //성별 연령별 분석
  const colorMap = {
    '골드바': '#1f77b4',   // 파란색
    '기념품': '#ff7f0e',   // 주황색
    '주얼리': '#2ca02c'    // 초록색
  };

  //성별 연령별 분석
  document.addEventListener("DOMContentLoaded", function () {
    const loadingDiv = document.getElementById("sexAgeLoading");
    const plotDivMale = document.getElementById("genderAgeChartPlotMale");
    const plotDivFemale = document.getElementById("genderAgeChartPlotFemale");
    if (!loadingDiv || !plotDivMale || !plotDivFemale) {
      console.error("성별/연령대 필요한 div가 없습니다.");
      return;
    }

    fetch("/temp_output.json")
      .then(response => response.json())
      .then(data => {
        if (!data || !data.male || !data.female) {
          loadingDiv.innerText = "데이터가 없습니다.";
          return;
        }
        const maleData = data.male;
        const femaleData = data.female;

        function renderTopBottomSummaryCharts(maleData, femaleData) {
          const combined = [...maleData, ...femaleData];

          // ➤ 연령대 + 성별 + 카테고리별 매출 정리
          const summaryList = combined.map(d => ({
            label: `${d.Age_Group} ${d.Gender === '남' ? '남성' : '여성'}`,
            category: d.Category,
            value: d.Total_Price / 100000000 // 억 원 단위
          }));

          const validCategories = ['골드바', '기념품', '주얼리'];
          const filtered = summaryList.filter(d => validCategories.includes(d.category));

          // ➤ TOP3 & BOTTOM3
          const top3 = [...filtered].sort((a, b) => b.value - a.value).slice(0, 3);
          const bottom3 = [...filtered].sort((a, b) => a.value - b.value).slice(0, 3);

          // ➤ 막대차트 트레이스 생성 함수
          const makeTrace = (dataList) => ({
            x: dataList.map(d => d.label),
            y: dataList.map(d => d.value),
            type: 'bar',
            marker: {
              color: dataList.map(d => colorMap[d.category])
            },
            text: dataList.map(d => `${d.value.toFixed(2)}억`),
            textposition: 'auto',
            hoverinfo: 'x+y',
            showlegend: false
          });

          // ➤ 레이아웃 공통 옵션
          const makeLayout = (titleText) => ({
            title: titleText,
            xaxis: { title: '연령대 + 성별' },
            yaxis: { title: '매출 (억 원)', tickformat: ',' },
            margin: { t: 60, b: 100 },
            height: 520,
            showlegend: false
          });

          // ➤ Plotly 차트 렌더링
          Plotly.newPlot('topProductsChart', [makeTrace(top3)], makeLayout('연령별 선호도 TOP3'));
          Plotly.newPlot('bottomProductsChart', [makeTrace(bottom3)], makeLayout('연령별 선호도 BOTTOM3'));
        }

      }); // ← fetch("/temp_output.json") 체인 닫기

           function loadDemographicsChart() {
            const loadingDiv = document.getElementById("sexAgeLoading");
            const malePlotDiv = document.getElementById("genderAgeChartPlotMale");
            const femalePlotDiv = document.getElementById("genderAgeChartPlotFemale");

            fetch("/api/statistics/sex-age-chart")
                .then(response => response.json())
                .then(data => {
                    if (!data || !data.male || !data.female) {
                        loadingDiv.innerText = "데이터가 없습니다.";
                        return;
                    }

                    const maleData = data.male;
                    const femaleData = data.female;
                    const ageGroups = [...new Set([...maleData, ...femaleData].map(d => d.Age_Group))].sort();
                    const categories = [...new Set([...maleData, ...femaleData].map(d => d.Category))];

                    // 남자 차트 트레이스 생성
                    const maleTraces = categories.map(category => ({
                        x: ageGroups,
                        y: ageGroups.map(ageGroup => {
                            const item = maleData.find(d => d.Age_Group === ageGroup && d.Category === category);
                            return item ? item.Total_Price / 100000000 : 0; // 억 단위
                        }),
                        name: category,
                        type: 'bar',
                        marker: { color: colorMap[category] || '#cccccc' }
                    }));

                    // 여자 차트 트레이스 생성
                    const femaleTraces = categories.map(category => ({
                        x: ageGroups,
                        y: ageGroups.map(ageGroup => {
                            const item = femaleData.find(d => d.Age_Group === ageGroup && d.Category === category);
                            return item ? item.Total_Price / 100000000 : 0; // 억 단위
                        }),
                        name: category,
                        type: 'bar',
                        marker: { color: colorMap[category] || '#cccccc' }
                    }));

                    // 남/녀 차트 공통 레이아웃 함수
                    const layout = gender => ({
                        barmode: 'stack', // 누적 막대 그래프
                        title: `${gender} · 연령대별 카테고리 매출 (단위: 억 원)`,
                        xaxis: { title: '연령대' },
                        yaxis: { title: '총 매출 (억 원)', tickformat: ',' },
                        legend: { orientation: 'h', x: 0.5, y: -0.25, xanchor: 'center', yanchor: 'top' },
                        margin: { t: 60, b: 100 },
                        height: 500
                    });

                    // 남/녀 차트 그리기
                    Plotly.newPlot(malePlotDiv, maleTraces, layout("👨 남성"));
                    Plotly.newPlot(femalePlotDiv, femaleTraces, layout("👩 여성"));

                    // 선호도 Top/Bottom 차트 그리기 함수 호출
                    renderTopBottomSummaryCharts(maleData, femaleData);

                    // 모든 차트가 그려진 후 로딩 메시지 숨기기
                    loadingDiv.style.display = "none";
                })
                .catch(error => {
                    loadingDiv.innerText = "데이터 로딩 중 오류가 발생했습니다.";
                    console.error("❌ JSON 로딩 오류:", error);
                });
        }

        // 4. 페이지가 로드되면 차트 로딩 함수를 실행
        document.addEventListener('DOMContentLoaded', loadDemographicsChart);

  });
</script>


<script>
  // 장바구니 이탈 분석 전역 변수
  let cartAnalysisData = null;

  /**
   * 인터랙티브 장바구니 이탈 분석 실행 (선택된 시간으로 Python 재실행)
   */
  function executeInteractiveCartAnalysis() {
    const threshold = document.getElementById('abandonmentThreshold').value;
    const loadingDiv = document.getElementById('interactiveAnalysisLoading');
    const executeBtn = document.getElementById('executeAnalysisBtn');


    // UI 초기화
    hideAllAnalysisElements();
    loadingDiv.style.display = 'block';
    executeBtn.disabled = true;
    executeBtn.textContent = '실행 중...';

    console.log(`🛒 새로운 분석 실행 (기준: ${threshold}시간)`);

    // 🔥 핵심: 선택된 시간으로 Python 스크립트 실행
    fetch('/api/cart-analysis/execute', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ hours: parseInt(threshold) })
    })
    .then(response => response.json())
    .then(data => {
      console.log('Python 실행 결과:', data);

      if (data.status === 'success') {
        console.log(`✅ ${threshold}시간 기준 분석 완료! 새 JSON 파일 생성됨`);
        // 성공 시 새로 생성된 JSON 데이터 로드 (캐시 무시)
        return loadAnalysisJsonData(true);
      } else {
        throw new Error(data.message || 'Python 스크립트 실행 실패');
      }
    })
    .then(() => {
      console.log('✅ 새로운 분석 결과 로드 완료');
      loadingDiv.style.display = 'none';
      executeBtn.disabled = false;
      executeBtn.textContent = '📊 분석 실행';

      showInteractiveAnalysisResults();
    })
    .catch(error => {
      console.error('❌ 분석 실패:', error);
      loadingDiv.style.display = 'none';
      executeBtn.disabled = false;
      executeBtn.textContent = '📊 분석 실행';

      showInteractiveError(error.message);
    });
  }

  /**
   * 기존 분석 결과 로드 (Python 실행 없이 현재 JSON만 로드)
   */
  function loadExistingAnalysis() {
    console.log('📂 기존 분석 결과 로드 시도');

    hideAllAnalysisElements();
    document.getElementById('interactiveAnalysisLoading').style.display = 'block';

    loadAnalysisJsonData(false) // 캐시 사용
      .then(() => {
        console.log('✅ 기존 결과 로드 완료');
        document.getElementById('interactiveAnalysisLoading').style.display = 'none';
        showInteractiveAnalysisResults();
      })
      .catch(error => {
        console.error('❌ 기존 결과 로드 실패:', error);
        document.getElementById('interactiveAnalysisLoading').style.display = 'none';
        showInteractiveError('기존 분석 결과가 없습니다. 먼저 분석을 실행해주세요.');
      });
  }

  /**
   * JSON 분석 데이터 로드 (static 폴더에서 직접 로드)
   */
  function loadAnalysisJsonData() {
    console.log('📂 JSON 파일 로드 시도...');

    return fetch('/cart_abandonment_analysis.json')
      .then(response => {
        if (!response.ok) {
          throw new Error(`JSON 파일을 찾을 수 없습니다. cart_abandonment_analysis.json 파일이 src/main/resources/static/ 폴더에 있는지 확인해주세요.`);
        }
        console.log('✅ JSON 파일 로드 성공!');
        return response.json();
      })
      .then(data => {
        if (data.error) {
          throw new Error(data.error);
        }

        cartAnalysisData = data;
        console.log('📊 JSON 데이터 로드 완료:', data);
        return data;
      });
  }

  /**
   * 에러 메시지 업데이트
   */
  function tryLoadFromFiles(fileList, index) {
    // 이 함수는 더 이상 사용하지 않습니다.
    // 단순화를 위해 loadAnalysisJsonData에서 직접 처리합니다.
  }

  /**
   * 인터랙티브 분석 결과 표시 (Python 스크립트 JSON 구조에 맞게 수정)
   */
  function showInteractiveAnalysisResults() {
    if (!cartAnalysisData) {
      showInteractiveError('분석 데이터가 없습니다.');
      return;
    }

    const { summary, charts, insights, threshold_analysis } = cartAnalysisData;

    // 요약 카드 업데이트
    updateSummaryCards(summary);

    // 인터랙티브 차트 그리기
    drawInteractiveCharts(charts);

    // 시간대별 비교 차트
    drawThresholdComparisonChart(threshold_analysis);

    // 인사이트 업데이트 (Python 스크립트 구조에 맞게)
    updateInsights(insights);

    // 모든 결과 영역 표시
    document.getElementById('interactiveSummaryCards').style.display = 'block';
    document.getElementById('interactiveCharts').style.display = 'block';
    document.getElementById('thresholdComparison').style.display = 'block';
    document.getElementById('interactiveInsights').style.display = 'block';
  }

  /**
   * 요약 카드 업데이트
   */
  function updateSummaryCards(summary) {
    document.getElementById('iTotalItems').textContent = summary.total.toLocaleString();
    document.getElementById('iAbandonedItems').textContent = summary.abandoned.toLocaleString();
    document.getElementById('iActiveItems').textContent = summary.active.toLocaleString();
    document.getElementById('iAbandonmentRate').textContent = summary.rate + '%';
  }

  /**
   * 인터랙티브 차트 그리기
   */
  function drawInteractiveCharts(charts) {
    // 1. 이탈률 도넛차트
    const abandonmentData = charts.abandonment_donut.data;
    Plotly.newPlot('interactiveAbandonmentChart', [{
      values: abandonmentData.values,
      labels: abandonmentData.labels,
      type: 'pie',
      hole: 0.6,
      marker: { colors: abandonmentData.colors },
      textinfo: 'label+percent+value',
      textposition: 'outside',
      hovertemplate: '<b>%{label}</b><br>개수: %{value:,}<br>비율: %{percent}<extra></extra>'
    }], {
      title: '📊 전체 이탈률',
      showlegend: true,
      margin: { t: 50, b: 50, l: 50, r: 50 }
    }, { responsive: true });

    // 2. 시간대별 라인차트
    const hourlyData = charts.hourly_line.data;
    Plotly.newPlot('interactiveHourlyChart', [{
      x: hourlyData.x,
      y: hourlyData.y,
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#4ECDC4', width: 3 },
      marker: { size: 8, color: '#FF6B6B' },
      fill: 'tonexty',
      fillcolor: 'rgba(78, 205, 196, 0.3)',
      hovertemplate: '<b>%{x}시</b><br>장바구니 추가: %{y}건<extra></extra>'
    }], {
      title: '⏰ 시간대별 장바구니 추가 패턴',
      xaxis: { title: '시간', dtick: 2 },
      yaxis: { title: '추가 건수' },
      margin: { t: 50, b: 50, l: 50, r: 50 },
      annotations: [{
        x: hourlyData.peak_hour,
        y: hourlyData.peak_value,
        text: `피크: ${hourlyData.peak_hour}시<br>(${hourlyData.peak_value}건)`,
        arrowcolor: 'red',
        arrowwidth: 2,
        bgcolor: 'yellow',
        bordercolor: 'red',
        borderwidth: 1
      }]
    }, { responsive: true });

    // 3. 순도별 바차트
    const karatData = charts.karat_bar.data;
    Plotly.newPlot('interactiveKaratChart', [{
      x: karatData.x,
      y: karatData.y,
      type: 'bar',
      marker: {
        color: karatData.colors,
        line: { color: 'black', width: 1 }
      },
      hovertemplate: '<b>%{x}</b><br>이탈 건수: %{y:,}건<extra></extra>'
    }], {
      title: '💎 순도별 이탈 현황',
      xaxis: { title: '순도' },
      yaxis: { title: '이탈 건수' },
      margin: { t: 50, b: 50, l: 50, r: 50 }
    }, { responsive: true });

    // 4. 이탈 시간 분포
    const timeData = charts.time_distribution.data;
    Plotly.newPlot('interactiveTimeChart', [{
      x: timeData.x,
      y: timeData.y,
      type: 'bar',
      marker: {
        color: timeData.colors,
        line: { color: 'black', width: 1 }
      },
      text: timeData.y.map((count, i) => `${count}건<br>(${timeData.percentages[i].toFixed(1)}%)`),
      textposition: 'outside',
      hovertemplate: '<b>%{x}</b><br>이탈 건수: %{y:,}건<br>비율: %{text}<extra></extra>'
    }], {
      title: '📈 이탈 시간 분포',
      xaxis: { title: '이탈 시간 구간' },
      yaxis: { title: '이탈 건수' },
      margin: { t: 50, b: 80, l: 50, r: 50 }
    }, { responsive: true });
  }

  /**
   * 시간대별 비교 차트 그리기
   */
  function drawThresholdComparisonChart(thresholdData) {
    Plotly.newPlot('thresholdComparisonChart', [{
      x: thresholdData.map(d => d.time_label),
      y: thresholdData.map(d => d.rate),
      type: 'bar',
      marker: {
        color: thresholdData.map(d => d.rate > 50 ? '#FF6B6B' : '#4ECDC4'),
        line: { color: 'black', width: 1 }
      },
      text: thresholdData.map(d => `${d.abandoned_count.toLocaleString()}개`),
      textposition: 'outside',
      hovertemplate: '<b>%{x} 기준</b><br>이탈률: %{y}%<br>이탈 건수: %{text}<extra></extra>'
    }], {
      title: '다양한 기준별 이탈률 비교',
      xaxis: { title: '이탈 기준 시간' },
      yaxis: { title: '이탈률 (%)' },
      margin: { t: 50, b: 80, l: 50, r: 50 }
    }, { responsive: true });
  }

  /**
   * 인사이트 업데이트 (Python 스크립트 JSON 구조에 맞게 수정)
   */
  function updateInsights(insights) {
    // 핵심 발견사항
    const findings = insights.key_findings.map(finding => `• ${finding}`).join('<br>');
    document.getElementById('keyFindings').innerHTML = findings;

    // 추천 액션
    const recommendations = insights.recommendations.map((rec, index) => `${index + 1}. ${rec}`).join('<br>');
    document.getElementById('recommendations').innerHTML = recommendations;
  }

  /**
   * 모든 분석 결과 영역 숨기기
   */
  function hideAllAnalysisElements() {
    const elements = [
      'interactiveSummaryCards', 'interactiveCharts',
      'thresholdComparison', 'interactiveInsights', 'interactiveAnalysisError'
    ];
    elements.forEach(id => {
      document.getElementById(id).style.display = 'none';
    });
  }

  /**
   * 에러 표시
   */
  function showInteractiveError(message) {
    document.getElementById('interactiveErrorContent').innerHTML = `<p>${message}</p>`;
    document.getElementById('interactiveAnalysisError').style.display = 'block';
  }
</script>


</body>

</html>