<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>AuGold 관리자 페이지</title>
  <style>
    body { margin: 0; font-family: 'Segoe UI', sans-serif; }
    header {
      background-color: #343a40;
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .tab-bar {
      background-color: #f8f9fa;
      display: flex;
      border-bottom: 1px solid #dee2e6;
    }
    .tab-bar button {
      flex: 1;
      padding: 15px;
      font-size: 16px;
      border: none;
      background-color: #f8f9fa;
      cursor: pointer;
    }
    .tab-bar button.active {
      background-color: white;
      border-bottom: 3px solid goldenrod;
      font-weight: bold;
    }
    .content {
      padding: 30px;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .stats-subtab-bar {
      margin-bottom: 20px;
      display: flex;
      border-bottom: 1px solid #ccc;
    }
    .stats-subtab-bar button {
      padding: 10px 15px;
      border: none;
      background-color: #eee;
      cursor: pointer;
      margin-right: 5px;
      font-size: 14px;
    }
    .stats-subtab-bar button.active {
      background-color: white;
      border-bottom: 3px solid goldenrod;
      font-weight: bold;
    }
    .stats-subtab-content { display: none; }
    .stats-subtab-content.active { display: block; }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }
    .form-container {
      margin-top: 30px;
      border: 1px solid #ccc;
      padding: 20px;
    }
    .form-container input, .form-container select, .form-container textarea {
      padding: 8px;
      margin: 5px 0;
      width: 100%;
      box-sizing: border-box;
    }
    .form-container button {
      margin-top: 10px;
      padding: 10px 20px;
      background-color: goldenrod;
      border: none;
      color: white;
      cursor: pointer;
    }
    .form-container .delete-btn {
      background-color: #dc3545;
      margin-left: 10px;
    }
  </style>

  <!-- Plotly.js CDN (한 번만 선언) -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>

<body>

<header>
  <h2>관리자 페이지</h2>
  <div>AuGold Admin</div>
</header>

<div class="tab-bar">
  <button class="tab-btn active" onclick="showTab('productTab', event)">상품 관리</button>
  <button class="tab-btn" onclick="showTab('statsTab', event)">통계</button>
  <button class="tab-btn" onclick="showTab('receiptTab', event)">영수증 등록</button>
  <button class="tab-btn" onclick="showTab('inquiryTab', event)">문의 답변</button>
</div>

<div class="content">
  <!-- 1. 상품 관리 탭 -->
  <div id="productTab" class="tab-content active">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h3>상품 관리</h3>
      <button onclick="toggleForm()">상품 등록</button>
    </div>

    <div class="form-container" id="productForm" style="display:none;">
      <form onsubmit="submitProduct(event)" enctype="multipart/form-data">
        <label>상품 ID: <input type="text" name="productId" readonly></label><br>
        <label>상품명: <input type="text" name="productName" required></label><br>
        <label>카테고리:
          <select name="ctgrId" required>
            <option value="">선택</option>
            <option value="CTGR-00001">CTGR-00001 [주얼리]</option>
            <option value="CTGR-00002">CTGR-00002 [골드바]</option>
            <option value="CTGR-00003">CTGR-00003 [기념품]</option>
          </select>
        </label><br>
        <label>서브 카테고리:
          <select name="subCtgr" required>
            <option value="">선택</option>
            <option value="귀걸이">귀걸이</option>
            <option value="반지">반지</option>
            <option value="목걸이">목걸이</option>
            <option value="골드바">골드바</option>
            <option value="감사패">감사패</option>
            <option value="돌반지">돌반지</option>
            <option value="카네이션 기념품">카네이션 기념품</option>
          </select>
        </label><br>
        <label>금 함량:
          <select name="karatCode" required>
            <option value="">선택</option>
            <option value="14K">14K</option>
            <option value="18K">18K</option>
            <option value="24K">24K</option>
          </select>
        </label><br>
        <label>금 무게 (g): <input type="number" name="goldWeight" step="0.01" required></label><br>
        <label>원가: <input type="number" name="basePrice" step="0.01" required></label><br>
        <label>판매가: <input type="number" name="finalPrice" step="0.01" required></label><br>
        <label>상품 재고 (Inventory): <input type="number" name="productInventory" value="0" required></label><br>
        <label>초기 재고량 (Stock Quantity): <input type="number" name="stockQuantity" value="10" required></label><br>
        <label>상품 설명: <textarea name="description" rows="4"></textarea></label><br>
        <label>대표 이미지: <input type="file" name="imageFile" accept="image/*" required></label><br>
        <label>상세 이미지 (여러 장 선택 가능): <input type="file" name="detailImages" accept="image/*" multiple></label><br>

        <button type="submit">상품 저장</button>
        <button type="button" class="delete-btn" onclick="deleteProduct()" style="display: none;">상품 삭제</button>
      </form>
    </div>

    <table id="productTable">
      <thead>
      <tr>
        <th>ID</th><th>이름</th><th>금 함량</th><th>카테고리</th><th>가격</th><th>무게</th><th>최종가</th><th>서브</th>
      </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- 2. 통계 탭 -->
  <div id="statsTab" class="tab-content">
    <h3>통계 분석</h3>
    <div class="stats-subtab-bar">
      <button class="stats-subtab-btn active" onclick="showStatsSubTab('orderTrends', event)">매출 트렌드 분석</button>
      <button class="stats-subtab-btn" onclick="showStatsSubTab('goldPrice', event)">금 시세 분석</button>
      <button class="stats-subtab-btn" onclick="showStatsSubTab('demographics', event)">성별/연령대별 분석</button>
      <button class="stats-subtab-btn" onclick="showStatsSubTab('categoryProfit', event)">카테고리별 이익률 분석</button>
    </div>

    <!-- 2-1. 매출 트렌드 분석 -->
    <div id="orderTrends" class="stats-subtab-content active">
      <div id="orderTrendsLoading" class="loading-message">데이터를 불러오는 중입니다...</div>
      <div id="salesForecastPlot" class="plot-container" style="display: none;"></div>
      <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
        <div id="salesWeeklyPlot" class="plot-container" style="width: 90%; max-width: 480px; display: none;"></div>
        <div id="salesYearlyPlot" class="plot-container" style="width: 90%; max-width: 480px; display: none;"></div>
      </div>
    </div>

    <!-- 2-2. 금 시세 분석 -->
    <div id="goldPrice" class="stats-subtab-content">
      <div id="goldPriceLoading" class="loading-message">데이터를 불러오는 중입니다...</div>
      <div id="forecastPlot" class="plot-container" style="display: none;"></div>
      <div id="trendPlot" class="plot-container" style="display: none;"></div>
      <div id="weeklyPlot" class="plot-container" style="display: none;"></div>
    </div>

    <!-- 2-3. 성별/연령대별 분석 -->
    <div id="demographics" class="stats-subtab-content">
      <div id="sexAgeLoading" class="loading-message">데이터를 불러오는 중입니다...</div>
      <div style="display: flex; gap: 30px; justify-content: center;">
        <div id="genderAgeChartPlotMale" style="flex:1; min-width:350px;"></div>
        <div id="genderAgeChartPlotFemale" style="flex:1; min-width:350px;"></div>
      </div>
    </div>

    <!-- 2-4. 카테고리별 이익률 분석 -->
    <div id="categoryProfit" class="stats-subtab-content">
      <div id="categoryProfitLoading" class="loading-message">데이터를 불러오는 중입니다...</div>
      <div id="categoryProfitPlot" class="plot-container" style="display: none;"></div>
    </div>
  </div>

  <!-- 3. 영수증 등록 탭 -->
  <div id="receiptTab" class="tab-content">
    <h3>영수증 등록</h3>
    <form id="receiptForm" enctype="multipart/form-data" onsubmit="uploadReceipt(event)">
      <h4>영수증 이미지 업로드</h4>
      <input type="file" name="receiptImage" accept="image/*" required><br><br>
      <button type="submit">업로드</button>
    </form>
    <div id="ocrResult" style="margin-top: 20px;"></div>
  </div>

  <!-- 4. 문의 답변 탭 -->
  <div id="inquiryTab" class="tab-content">
    <h3>문의 답변</h3>
    <table id="inquiryTable">
      <thead>
      <tr>
        <th>#</th><th>회원번호</th><th>제목</th><th>처리상태</th><th>문의일시</th>
      </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
  // ==========================================================
  //  공통 및 초기화 로직
  // ==========================================================

  // 페이지 로드 시 실행
  document.addEventListener('DOMContentLoaded', () => {
    fetchProducts();
    fetchInquiries();

    // 상품 등록 폼의 서브카테고리 변경 시 ID 자동 생성 이벤트 연결
    document.querySelector('select[name="subCtgr"]').addEventListener("change", function () {
      if (editing) return; // 수정 중일 때는 ID를 변경하지 않음
      const subCtgr = this.value;
      if (!subCtgr) {
        document.querySelector('#productForm input[name="productId"]').value = '';
        return;
      }
      fetch(`/api/products/next-id?subCtgr=${encodeURIComponent(subCtgr)}`)
        .then(res => res.text())
        .then(productId => {
          document.querySelector('#productForm input[name="productId"]').value = productId;
        });
    });

    // 통계 탭의 기본 하위 탭(매출 트렌드)을 로드
    loadOrderTrends();
    orderTrendsLoaded = true;
  });

  // 메인 탭 전환
  function showTab(tabId, event) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    event.currentTarget.classList.add('active');
  }

  // ==========================================================
  //  1. 상품 관리 관련 함수
  // ==========================================================

  let editing = false;
  let editProductId = null;

  function toggleForm(show = null) {
    const formContainer = document.getElementById('productForm');
    const form = formContainer.querySelector('form');
    const shouldShow = show === true || (show === null && formContainer.style.display === 'none');

    if (shouldShow) {
      if (!editing) { // '상품 등록' 모드일 때만 폼 리셋
        form.reset();
        form.querySelector("button[type='submit']").innerText = "상품 저장";
        form.querySelector(".delete-btn").style.display = "none";
      }
      formContainer.style.display = 'block';
    } else {
      formContainer.style.display = 'none';
      editing = false; // 폼이 닫힐 때 수정 상태 해제
      editProductId = null;
    }
  }

  function fetchProducts() {
    fetch('/api/products')
      .then(res => res.json())
      .then(data => {
        const tbody = document.querySelector("#productTable tbody");
        tbody.innerHTML = "";
        data.forEach(p => {
          const row = `<tr>
              <td>${p.productId}</td>
              <td><a href="#" onclick="editProduct('${p.productId}')">${p.productName}</a></td>
              <td>${p.karatCode}</td>
              <td>${p.ctgrId}</td>
              <td>${p.basePrice}</td>
              <td>${p.goldWeight}</td>
              <td>${p.finalPrice}</td>
              <td>${p.subCtgr}</td>
            </tr>`;
          tbody.insertAdjacentHTML("beforeend", row);
        });
      });
  }

  function editProduct(id) {
    fetch(`/api/products/${id}`)
      .then(res => res.json())
      .then(p => {
        const form = document.querySelector('#productForm form');
        // 폼 필드 채우기
        for (const key in p) {
            if (form.elements[key]) {
                form.elements[key].value = p[key];
            }
        }

        editProductId = id;
        editing = true;
        toggleForm(true);
        form.querySelector("button[type='submit']").innerText = "상품 수정";
        form.querySelector(".delete-btn").style.display = "inline-block";
      });
  }

  function submitProduct(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);

    // 수정 모드일 때는 PUT, 등록 모드일 때는 POST
    const method = editing ? 'PUT' : 'POST';
    const url = editing ? `/api/products/${editProductId}` : '/api/products';

    fetch(url, { method: method, body: formData })
      .then(res => {
        if (res.ok) {
          alert(editing ? "상품이 수정되었습니다!" : "상품이 등록되었습니다!");
          toggleForm(false);
          fetchProducts();
        } else {
          res.text().then(text => alert("작업 실패: " + text));
        }
      })
      .catch(err => {
        console.error("Fetch Error:", err);
        alert("요청 중 오류가 발생했습니다.");
      });
  }

  function deleteProduct() {
    if (!editProductId || !confirm("정말로 삭제하시겠습니까?")) return;

    fetch(`/api/products/${editProductId}`, { method: 'DELETE' })
      .then(res => {
        if (res.ok) {
          alert("삭제 완료!");
          toggleForm(false);
          fetchProducts();
        } else {
          alert("삭제 실패");
        }
      });
  }

  // ==========================================================
  //  2. 통계 관련 함수
  // ==========================================================

  let goldPriceStatsLoaded = false;
  let orderTrendsLoaded = false;
  let categoryProfitLoaded = false;
  let demographicsLoaded = false;

  function showStatsSubTab(subTabId, event) {
    document.querySelectorAll('.stats-subtab-bar button').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.stats-subtab-content').forEach(content => content.classList.remove('active'));

    const subTabDiv = document.getElementById(subTabId);
    if (subTabDiv) {
      event.currentTarget.classList.add('active');
      subTabDiv.classList.add('active');
    }

    // 각 탭을 처음 클릭할 때만 데이터 로드
    if (subTabId === 'goldPrice' && !goldPriceStatsLoaded) {
      loadGoldPriceForecast();
      goldPriceStatsLoaded = true;
    } else if (subTabId === 'orderTrends' && !orderTrendsLoaded) {
      loadOrderTrends();
      orderTrendsLoaded = true;
    } else if (subTabId === 'categoryProfit' && !categoryProfitLoaded) {
      loadCategoryProfit();
      categoryProfitLoaded = true;
    } else if (subTabId === 'demographics' && !demographicsLoaded) {
      loadDemographicsChart();
      demographicsLoaded = true;
    }
  }

  function loadOrderTrends() {
    const loadingMsg = document.getElementById('orderTrendsLoading');
    loadingMsg.style.display = 'block';

    fetch('/api/statistics/order-trends')
      .then(res => res.json())
      .then(data => {
        if (data.error) throw new Error(data.error);
        loadingMsg.style.display = 'none';

        // 그래프 그리기
        document.getElementById('salesForecastPlot').style.display = 'block';
        document.getElementById('salesWeeklyPlot').style.display = 'block';
        document.getElementById('salesYearlyPlot').style.display = 'block';

        const forecastData = data.main_forecast;
        Plotly.newPlot('salesForecastPlot', [
            { x: forecastData.map(d => d.ds), y: forecastData.map(d => d.yhat_upper), mode: 'lines', line: { width: 0 }, showlegend: false },
            { x: forecastData.map(d => d.ds), y: forecastData.map(d => d.yhat_lower), mode: 'lines', line: { width: 0 }, fill: 'tonexty', fillcolor: 'rgba(65, 105, 225, 0.2)', showlegend: false },
            { x: forecastData.map(d => d.ds), y: forecastData.map(d => d.y), mode: 'markers', name: '실제 매출'},
            { x: forecastData.map(d => d.ds), y: forecastData.map(d => d.yhat), mode: 'lines', name: '예측 매출'}
        ], { title: '총 매출 예측 (향후 90일)' });

        const weeklyData = data.weekly_seasonality;
        Plotly.newPlot('salesWeeklyPlot', [{ x: weeklyData.map(d => d.day_name), y: weeklyData.map(d => d.weekly_effect), type: 'bar' }], { title: '요일별 매출 트렌드' });

        const yearlyData = data.yearly_seasonality;
        Plotly.newPlot('salesYearlyPlot', [{ x: yearlyData.map(d => d.month_name), y: yearlyData.map(d => d.yearly_effect), mode: 'lines+markers' }], { title: '월별 매출 트렌드' });
      })
      .catch(error => {
        loadingMsg.innerText = '데이터 로딩 실패: ' + error.message;
      });
  }

  function loadGoldPriceForecast() {
    const loadingMsg = document.getElementById('goldPriceLoading');
    loadingMsg.style.display = 'block';

    fetch('/api/statistics/gold-price-forecast')
      .then(res => res.json())
      .then(data => {
        if (data.error) throw new Error(data.error);
        loadingMsg.style.display = 'none';

        document.getElementById('forecastPlot').style.display = 'block';
        document.getElementById('trendPlot').style.display = 'block';
        document.getElementById('weeklyPlot').style.display = 'block';

        Plotly.newPlot('forecastPlot', [
          { x: data.forecast.ds, y: data.forecast.yhat_upper, mode: 'lines', line: { width: 0 }, showlegend: false },
          { x: data.forecast.ds, y: data.forecast.yhat_lower, mode: 'lines', fill: 'tonexty', showlegend: false },
          { x: data.forecast.ds, y: data.forecast.y, mode: 'markers', name: '실제 가격' },
          { x: data.forecast.ds, y: data.forecast.yhat, mode: 'lines', name: '예측 가격' }
        ], { title: '향후 30일 금 시세 예측' });
        Plotly.newPlot('trendPlot', [{ x: data.trend.ds, y: data.trend.y, mode: 'lines' }], { title: '시세 트렌드' });
        Plotly.newPlot('weeklyPlot', [{ x: data.weekly.x, y: data.weekly.y, mode: 'lines' }], { title: '주간 계절성' });
      })
      .catch(error => {
        loadingMsg.innerText = '데이터 로딩 실패: ' + error.message;
      });
  }

  function loadDemographicsChart() {
    const loadingDiv = document.getElementById("sexAgeLoading");
    loadingDiv.style.display = 'block';

    fetch("/api/statistics/sex-age-chart") // ✅ 실제 API 엔드포인트로 변경
      .then(res => res.json())
      .then(data => {
        if (data.error) throw new Error(data.error);
        loadingDiv.style.display = "none";

        const maleData = data.male;
        const femaleData = data.female;
        const ageGroups = [...new Set([...maleData, ...femaleData].map(d => d.Age_Group))];
        const categories = [...new Set([...maleData, ...femaleData].map(d => d.Category))];

        const maleSeries = categories.map(cat => ({ x: ageGroups, y: ageGroups.map(ag => maleData.find(d=>d.Age_Group===ag && d.Category===cat)?.Total_Price||0), name: cat, type: 'bar' }));
        const femaleSeries = categories.map(cat => ({ x: ageGroups, y: ageGroups.map(ag => femaleData.find(d=>d.Age_Group===ag && d.Category===cat)?.Total_Price||0), name: cat, type: 'bar' }));
        const layout = { barmode: 'group', xaxis: { title: '연령대' }, yaxis: { title: '총 매출' } };

        Plotly.newPlot("genderAgeChartPlotMale", maleSeries, { ...layout, title: '👨 남성 통계' });
        Plotly.newPlot("genderAgeChartPlotFemale", femaleSeries, { ...layout, title: '👩 여성 통계' });
      })
      .catch(error => {
        loadingDiv.innerText = "데이터 로딩 실패: " + error.message;
      });
  }

  function loadCategoryProfit() {
      const loadingDiv = document.getElementById("categoryProfitLoading");
      loadingDiv.style.display = 'block';

      fetch('/api/statistics/category-profit')
          .then(res => res.json())
          .then(data => {
              if (data.error) throw new Error(data.error);
              loadingDiv.style.display = "none";
              document.getElementById('categoryProfitPlot').style.display = 'block';

              const forecast = data.forecast;
              Plotly.newPlot("categoryProfitPlot", [
                  { x: data.monthly.map(i => i.Month), y: data.monthly.map(i => i.Profit_Margin), mode: 'lines+markers', name: '이익률' },
                  { x: [forecast.month], y: [forecast.predicted_margin], mode: 'markers', name: '예측값' }
              ], { title: '카테고리별 이익률 분석 및 예측' });
          })
          .catch(err => {
              loadingDiv.innerText = "데이터 로딩 실패: " + err.message;
          });
  }

  // ==========================================================
  //  3. 영수증 관리 함수
  // ==========================================================
  function uploadReceipt(event) {
    event.preventDefault();
    const form = document.getElementById("receiptForm");
    const formData = new FormData(form);

    fetch('/api/receipt/upload', { method: 'POST', body: formData })
    .then(res => res.json())
    .then(data => {
        document.getElementById("ocrResult").innerText = "📄 OCR 결과:\n" + data.text;
    })
    .catch(err => {
        alert("업로드 실패");
        console.error(err);
    });
  }

  // ==========================================================
  //  4. 문의 관리 함수
  // ==========================================================
  function fetchInquiries() {
    fetch('/api/inquiries')
      .then(res => res.json())
      .then(data => {
        const tbody = document.querySelector("#inquiryTable tbody");
        tbody.innerHTML = "";
        data.forEach((inq, index) => {
          const row = `
            <tr>
              <td>${index + 1}</td>
              <td>${inq.cstmNumber}</td>
              <td><a href="/admin/inquiry/${inq.inqNumber}">${inq.inqTitle}</a></td>
              <td>${inq.inqStatus}</td>
              <td>${new Date(inq.inqDate).toLocaleString()}</td>
            </tr>`;
          tbody.insertAdjacentHTML("beforeend", row);
        });
      })
      .catch(err => console.error(err));
  }
</script>

</body>
</html>