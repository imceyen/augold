<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>AuGold ê´€ë¦¬ì í˜ì´ì§€</title>
  <style>
    body { margin: 0; font-family: 'Segoe UI', sans-serif; }
    header {
        background-color: #343a40;
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .tab-bar {
        background-color: #f8f9fa;
        display: flex;
        border-bottom: 1px solid #dee2e6;
    }
    .tab-bar button {
        flex: 1;
        padding: 15px;
        font-size: 16px;
        border: none;
        background-color: #f8f9fa;
        cursor: pointer;
    }
    .tab-bar button.active {
        background-color: white;
        border-bottom: 3px solid goldenrod;
        font-weight: bold;
    }
    .content {
        padding: 30px;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* í†µê³„ í•˜ìœ„ íƒ­ ìŠ¤íƒ€ì¼ */
    .stats-subtab-bar {
        margin-bottom: 20px;
        display: flex;
        border-bottom: 1px solid #ccc;
    }
    .stats-subtab-bar button {
        padding: 10px 15px;
        border: none;
        background-color: #eee;
        cursor: pointer;
        margin-right: 5px;
        font-size: 14px;
    }
    .stats-subtab-bar button.active {
        background-color: white;
        border-bottom: 3px solid goldenrod;
        font-weight: bold;
    }

    .stats-subtab-content {
        display: none;
    }
    .stats-subtab-content.active {
        display: block;
    }

    table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 20px;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
    }
    th {
        background-color: #f2f2f2;
    }
    .form-container {
        margin-top: 30px;
        border: 1px solid #ccc;
        padding: 20px;
    }
    .form-container input, .form-container select {
        padding: 8px;
        margin: 5px 0;
        width: 100%;
    }
    .form-container button {
        margin-top: 10px;
        padding: 10px 20px;
        background-color: goldenrod;
        border: none;
        color: white;
        cursor: pointer;
    }
    .form-container .delete-btn {
        background-color: #dc3545;
        margin-left: 10px;
    }
  </style>

  <!-- ğŸ”· Plotly.js ì¶”ê°€ -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>

<body>

<header>
  <h2>ê´€ë¦¬ì í˜ì´ì§€</h2>
  <div>AuGold Admin</div>
</header>

<div class="tab-bar">
  <button class="tab-btn active" onclick="showTab('productTab', event)">ìƒí’ˆ ê´€ë¦¬</button>
  <button class="tab-btn" onclick="showTab('statsTab', event)">í†µê³„</button>
  <button class="tab-btn" onclick="showTab('receiptTab', event)">ì˜ìˆ˜ì¦ ë“±ë¡</button>
  <button class="tab-btn" onclick="showTab('inquiryTab', event)">ë¬¸ì˜ ë‹µë³€</button>
</div>

<div class="content">
  <!-- ìƒí’ˆ ê´€ë¦¬ -->
  <div id="productTab" class="tab-content active">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h3>ìƒí’ˆ ê´€ë¦¬</h3>
      <button onclick="toggleForm()">ìƒí’ˆ ë“±ë¡</button>
    </div>

    <div class="form-container" id="productForm" style="display:none;">
      <form onsubmit="submitProduct(event)" enctype="multipart/form-data">
        <label>ìƒí’ˆ ID:
          <input type="text" name="productId" readonly>
        </label><br><br>
        <label>ìƒí’ˆëª…:
          <input type="text" name="productName" required>
        </label><br><br>
        <label>ì¹´í…Œê³ ë¦¬:
          <select name="ctgrId" required>
            <option value="">ì„ íƒ</option>
            <option value="CTGR-00001">CTGR-00001 [ì£¼ì–¼ë¦¬]</option>
            <option value="CTGR-00002">CTGR-00002 [ê³¨ë“œë°”]</option>
            <option value="CTGR-00003">CTGR-00003 [ê¸°ë…í’ˆ]</option>
          </select>
        </label><br><br>
        <label>ì„œë¸Œ ì¹´í…Œê³ ë¦¬:
          <select name="subCtgr" required>
            <option value="">ì„ íƒ</option>
            <option value="ê·€ê±¸ì´">ê·€ê±¸ì´</option>
            <option value="ë°˜ì§€">ë°˜ì§€</option>
            <option value="ëª©ê±¸ì´">ëª©ê±¸ì´</option>
            <option value="ê³¨ë“œë°”">ê³¨ë“œë°”</option>
            <option value="ê°ì‚¬íŒ¨">ê°ì‚¬íŒ¨</option>
            <option value="ëŒë°˜ì§€">ëŒë°˜ì§€</option>
            <option value="ì¹´ë„¤ì´ì…˜ ê¸°ë…í’ˆ">ì¹´ë„¤ì´ì…˜ ê¸°ë…í’ˆ</option>
          </select>
        </label><br><br>
        <label>ê¸ˆ í•¨ëŸ‰:
          <select name="karatCode" required>
            <option value="">ì„ íƒ</option>
            <option value="14K">14K</option>
            <option value="18K">18K</option>
            <option value="24K">24K</option>
          </select>
        </label><br><br>
        <label>ê¸ˆ ë¬´ê²Œ (g):
          <input type="number" name="goldWeight" step="0.01" required>
        </label><br><br>
        <label>ì›ê°€:
          <input type="number" name="basePrice" step="0.01" required>
        </label><br><br>
        <label>íŒë§¤ê°€:
          <input type="number" name="finalPrice" step="0.01" required>
        </label><br><br>
        <label>ìƒí’ˆ ì„¤ëª…:
          <input type="text" name="description">
        </label><br><br>
        <label>ëŒ€í‘œ ì´ë¯¸ì§€:
          <input type="file" name="imageFile" accept="image/*" required>
        </label><br><br>
        <label>ìƒì„¸ ì´ë¯¸ì§€ 1:
          <input type="file" name="detailImage1" accept="image/*">
        </label><br><br>
        <label>ìƒì„¸ ì´ë¯¸ì§€ 2:
          <input type="file" name="detailImage2" accept="image/*">
        </label><br><br>
        <label>ìƒì„¸ ì´ë¯¸ì§€ 3:
          <input type="file" name="detailImage3" accept="image/*">
        </label><br><br>
        <label>ìƒí’ˆ ì¬ê³  (Inventory):
          <input type="number" name="productInventory" required>
        </label><br><br>
        <label>ì´ˆê¸° ì¬ê³ ëŸ‰ (Stock Quantity):
          <input type="number" name="stockQuantity" value="10" required> <!-- ê¸°ë³¸ê°’ 10ìœ¼ë¡œ ì„¤ì • -->
        </label><br><br>
        <button type="submit">ìƒí’ˆ ì €ì¥</button>
        <button type="button" class="delete-btn" onclick="deleteProduct()" style="display: none;">ìƒí’ˆ ì‚­ì œ</button>
      </form>
    </div>

    <table id="productTable">
      <thead>
      <tr>
        <th>ID</th><th>ì´ë¦„</th><th>ê¸ˆ í•¨ëŸ‰</th><th>ì¹´í…Œê³ ë¦¬</th><th>ê°€ê²©</th><th>ë¬´ê²Œ</th><th>ìµœì¢…ê°€</th><th>ì„œë¸Œ</th>
      </tr>
      </thead>
      <tbody>
      <!-- JSë¡œ ìƒí’ˆëª©ë¡ ì¶”ê°€ -->
      </tbody>
    </table>
  </div>

  <!-- í†µê³„ íƒ­ -->
  <div id="statsTab" class="tab-content">
    <h3>í†µê³„ ë¶„ì„</h3>

    <!-- í†µê³„ í•˜ìœ„ íƒ­ ë²„íŠ¼ -->
    <div class="stats-subtab-bar">
      <button class="stats-subtab-btn" onclick="showStatsSubTab('salesAnalysis', event)">ë§¤ì¶œ ë¶„ì„ ë° ì˜ˆì¸¡</button>
      <button class="stats-subtab-btn active" onclick="showStatsSubTab('goldPrice', event)">ê¸ˆ ì‹œì„¸ ë¶„ì„ ë° ì˜ˆì¸¡</button>
      <button class="stats-subtab-btn" onclick="showStatsSubTab('demographics', event)">ì„±ë³„/ì—°ë ¹ëŒ€ë³„ ë§¤ì¶œ/êµ¬ë§¤íŒ¨í„´ ë¶„ì„</button>
      <button class="stats-subtab-btn" onclick="showStatsSubTab('orderTrends', event)">íŒë§¤ë‚ ì§œ ê¸°ë°˜ ì£¼ë¬¸ íŠ¸ë Œë“œ ë¶„ì„</button>
      <button class="stats-subtab-btn" onclick="showStatsSubTab('categoryProfit', event)">ì¹´í…Œê³ ë¦¬ë³„ ì´ìµë¥  ë¶„ì„/ì˜ˆì¸¡</button>
    </div>

    <div id="salesAnalysis" class="stats-subtab-content active">
      <h3>ë§¤ì¶œ ë¶„ì„ ë° ì˜ˆì¸¡</h3>

      <!-- ì»¨íŠ¸ë¡¤ ì˜ì—­: ì˜µì…˜ ë³€ê²½ ì‹œ loadSalesAnalysis() ìë™ í˜¸ì¶œ -->
      <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 20px;">
        <div>
          <label for="unit">ë¶„ì„ ë‹¨ìœ„:</label>
          <select id="unit" onchange="loadSalesAnalysis()">
            <option value="day">ì¼</option>
            <option value="week">ì£¼</option>
            <option value="month" selected>ì›”</option>
            <option value="year">ì—°</option>
          </select>
        </div>
        <div>
          <label>
            <input type="checkbox" id="toggleForecast" onchange="loadSalesAnalysis()" checked> ì˜ˆì¸¡ê°’ í‘œì‹œ
          </label>
        </div>
      </div>

      <!-- ë¡œë”© ë©”ì‹œì§€ -->
      <div id="salesAnalysisLoading" style="text-align: center; padding: 40px; font-size: 1.1em; display: none;">
        ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
      </div>

      <!-- Chart.js ì°¨íŠ¸ê°€ ê·¸ë ¤ì§ˆ ì˜ì—­ (ë°˜ì‘í˜• ëŒ€ì‘) -->
      <div style="position: relative; height:450px; width:100%;">
        <canvas id="salesChart"></canvas>
      </div>
    </div>


    <div id="orderTrends" class="stats-subtab-content active">
      <h3>íŒë§¤ë‚ ì§œ ê¸°ë°˜ ì£¼ë¬¸ íŠ¸ë Œë“œ ë¶„ì„</h3>
      <p>ì£¼ë¬¸ ë‚ ì§œ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìš”ì¼ë³„, ì›”ë³„ ë§¤ì¶œ íŠ¸ë Œë“œë¥¼ ë¶„ì„í•œ ê²°ê³¼ì…ë‹ˆë‹¤.</p>

      <!-- ë¡œë”© ë©”ì‹œì§€ -->
      <div id="orderTrendsLoading" style="text-align: center; padding: 40px; font-size: 1.1em;">
        ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
      </div>

      <!-- ì°¨íŠ¸ê°€ ê·¸ë ¤ì§ˆ ì˜ì—­ -->
      <div style="display: flex; gap: 30px; justify-content: center; flex-wrap: wrap;">
        <!-- 1. ìš”ì¼ë³„ íŠ¸ë Œë“œ ì°¨íŠ¸ê°€ ê·¸ë ¤ì§ˆ ê³³ -->
        <div id="salesWeeklyPlot" style="flex:1; min-width:400px; max-width:600px;"></div>
        <!-- 2. ì›”ë³„ íŠ¸ë Œë“œ ì°¨íŠ¸ê°€ ê·¸ë ¤ì§ˆ ê³³ -->
        <div id="salesYearlyPlot" style="flex:1; min-width:400px; max-width:600px;"></div>
      </div>
    </div>

    <div id="goldPrice" class="stats-subtab-content active">
      <!-- Plotly.js CDN ì¶”ê°€ -->
      <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

      <div id="loadingMessage" style="text-align: center; padding: 50px; font-size: 1.2em;">
        ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
      </div>
      <div id="forecastPlot" class="plot-container" style="width: 90%; max-width: 900px; margin: 20px auto; display: none;"></div>
      <div id="trendPlot" class="plot-container" style="width: 90%; max-width: 900px; margin: 20px auto; display: none;"></div>
      <div id="weeklyPlot" class="plot-container" style="width: 90%; max-width: 900px; margin: 20px auto; display: none;"></div>
    </div>

    <!-- ğŸ“Š ì„±ë³„Â·ì—°ë ¹ëŒ€ë³„ ë§¤ì¶œ ì°¨íŠ¸ ì˜ì—­ -->
    <div id="demographics" class="stats-subtab-content">
      <p>ì„±ë³„ ë° ì—°ë ¹ëŒ€ë³„ ë§¤ì¶œ ë¶„ì„ ì‹œê°í™” ê²°ê³¼ì…ë‹ˆë‹¤.</p>
      <div id="sexAgeLoading" style="text-align: center; padding: 40px; font-size: 1.1em;">
        ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
      </div>
      <!-- ì´ê³³ì— Plotly ì°¨íŠ¸ê°€ ì¶œë ¥ë©ë‹ˆë‹¤ -->
      <div style="display: flex; gap: 30px; justify-content: center;">
        <div id="genderAgeChartPlotMale" style="flex:1; min-width:350px; max-width:600px;"></div>
        <div id="genderAgeChartPlotFemale" style="flex:1; min-width:350px; max-width:600px;"></div>
      </div>
    </div>

    <div id="categoryProfit" class="stats-subtab-content">
      <p>ì¹´í…Œê³ ë¦¬ë³„ ì´ìµë¥  ë¶„ì„ ë° ì˜ˆì¸¡ ë°ì´í„°ë¥¼ ë³´ì—¬ì£¼ëŠ” ì˜ì—­ì…ë‹ˆë‹¤.</p>
      <!-- ğŸ”½ ë¡œë”© ë©”ì‹œì§€ -->
      <div id="categoryProfitLoading" style="text-align: center; padding: 50px; font-size: 1.2em;">
        ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
      </div>
      <!-- ğŸ”½ Plotly ê·¸ë˜í”„ -->
      <div id="categoryProfitPlot" class="plot-container" style="width: 90%; max-width: 900px; margin: 20px auto; display: none;"></div>
    </div>
  </div>

  <div id="receiptTab" class="tab-content">
    <h3>ì˜ìˆ˜ì¦ ë“±ë¡</h3>
    <form id="receiptForm" enctype="multipart/form-data" onsubmit="uploadReceipt(event)">
      <h4>ì˜ìˆ˜ì¦ ì´ë¯¸ì§€ ì—…ë¡œë“œ</h4>
      <input type="file" name="receiptImage" accept="image/*" required><br><br>
      <button type="submit">ì—…ë¡œë“œ</button>
    </form>

    <div id="ocrResult" style="margin-top: 20px;"></div>
  </div>

  <div id="inquiryTab" class="tab-content">
    <h3>ë¬¸ì˜ ë‹µë³€</h3>

    <table id="inquiryTable">
      <thead>
      <tr>
        <th>#</th>
        <th>íšŒì›ë²ˆí˜¸</th>
        <th>ì œëª©</th>
        <th>ì²˜ë¦¬ìƒíƒœ</th>
        <th>ë¬¸ì˜ì¼ì‹œ</th>
      </tr>
      </thead>
      <tbody>
      <!-- JSê°€ ì´ ì˜ì—­ì„ ì±„ì›ë‹ˆë‹¤ -->
      </tbody>
    </table>
  </div>

  <script>


    /**
     * ë¬¸ì˜ ëª©ë¡ì„ ì„œë²„ì—ì„œ ê°€ì ¸ì™€ í‘œì— ì±„ìš´ë‹¤
     */
    function fetchInquiries() {
      fetch('/api/inquiries')
        .then(res => {
          if (!res.ok) throw new Error("ë¬¸ì˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
          return res.json();
        })
        .then(data => {
          const tbody = document.querySelector("#inquiryTable tbody");
          tbody.innerHTML = "";  // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”

          data.forEach((inq, index) => {
            const row = `
              <tr>
                <td>${index + 1}</td>
                <td>${inq.cstmNumber}</td>
                <td>
                 <a href="/admin/inquiry/${inq.inqNumber}">${inq.inqTitle}</a>
                </td>
                <td>${inq.inqStatus}</td>
                <td>${new Date(inq.inqDate).toLocaleString()}</td>
              </tr>
            `;
            tbody.insertAdjacentHTML("beforeend", row);
          });
        })
        .catch(err => {
          console.error(err);
          alert(err.message);
        });
    }
  </script>

</div>

<script>
  // ìƒí’ˆ ê´€ë¦¬ ê´€ë ¨ ë³€ìˆ˜ ë° í•¨ìˆ˜
  let editing = false;
  let editProductId = null;

  function toggleForm(show = null) {
      const form = document.getElementById('productForm');
      form.style.display = (show === true || (show === null && form.style.display === 'none')) ? 'block' : 'none';
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰ë  í•¨ìˆ˜ë“¤
  document.addEventListener('DOMContentLoaded', () => {
      // ìƒí’ˆ ê´€ë¦¬ ì´ˆê¸°í™”
      document.querySelector('select[name="subCtgr"]').addEventListener("change", function () {
          const subCtgr = this.value;
          if (!subCtgr || editing) return;

          fetch(`/api/products/next-id?subCtgr=${encodeURIComponent(subCtgr)}`)
              .then(res => res.text())
              .then(productId => {
                  document.querySelector('#productForm input[name="productId"]').value = productId;
              });
      });
      fetchProducts();

      // ë¬¸ì˜ ê´€ë¦¬ ì´ˆê¸°í™”
      fetchInquiries();

      // ê¸°ë³¸ íƒ­ ì„¤ì • (ì—¬ê¸°ì„œëŠ” ìƒí’ˆ ê´€ë¦¬ íƒ­ì´ ê¸°ë³¸ìœ¼ë¡œ í™œì„±í™”ë¨)
      // ë§Œì•½ ë‹¤ë¥¸ íƒ­ì„ ê¸°ë³¸ìœ¼ë¡œ í•˜ê³  ì‹¶ë‹¤ë©´ ì´ ë¶€ë¶„ì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  });

  function fetchProducts() {
      fetch('/api/products')
          .then(res => res.json())
          .then(data => {
              const tbody = document.querySelector("#productTable tbody");
              tbody.innerHTML = "";
              data.forEach(p => {
                  const row = `<tr>
                      <td>${p.productId}</td>
                      <td><a href="#" onclick="editProduct('${p.productId}')">${p.productName}</a></td>
                      <td>${p.karatCode}</td>
                      <td>${p.ctgrId}</td>
                      <td>${p.basePrice}</td>
                      <td>${p.goldWeight}</td>
                      <td>${p.finalPrice}</td>
                      <td>${p.subCtgr}</td>
                  </tr>`;
                  tbody.insertAdjacentHTML("beforeend", row);
              });
          });
  }

  function editProduct(id) {
    fetch(`/api/products/${id}`)
        .then(res => res.json())
        .then(p => {
            const form = document.querySelector('#productForm form');
            form.productId.value = p.productId;
            form.productName.value = p.productName;
            form.ctgrId.value = p.ctgrId;
            form.subCtgr.value = p.subCtgr;
            form.karatCode.value = p.karatCode;
            form.goldWeight.value = p.goldWeight;
            form.basePrice.value = p.basePrice;
            form.finalPrice.value = p.finalPrice;
            form.description.value = p.description;

            editProductId = id;
            editing = true;
            toggleForm(true);
            form.querySelector("button[type='submit']").innerText = "ìƒí’ˆ ìˆ˜ì •";
            form.querySelector(".delete-btn").style.display = "inline-block";
        });
  }

 function submitProduct(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    // const url = editing ? `/api/products/${editProductId}` : '/api/products';
    const url = '/api/products';

    // fetch ìš”ì²­ì˜ methodëŠ” í•­ìƒ 'POST'ê°€ ë©ë‹ˆë‹¤.
    fetch(url, { method: 'POST', body: formData })
        .then(res => {
            if (res.ok) {
                alert("ìƒí’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
                form.reset();
                toggleForm(false);
                fetchProducts();
            } else {
                // ì„œë²„ì—ì„œ ì˜¤ëŠ” ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ë³´ì—¬ì£¼ë©´ ë” ì¢‹ìŠµë‹ˆë‹¤.
                res.text().then(text => alert("ì €ì¥ ì‹¤íŒ¨: " + text));
            }
        })
        .catch(err => {
            console.error("Fetch Error:", err);
            alert("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
  }

  function deleteProduct() {
      if (!editProductId) return;
      if (!confirm("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

      fetch(`/api/products/${editProductId}`, { method: 'DELETE' })
        .then(res => {
          if (res.ok) {
              alert("ì‚­ì œ ì™„ë£Œ!");
              const form = document.querySelector('#productForm form');
              form.reset();
              toggleForm(false);
              fetchProducts();
              editing = false;
              editProductId = null;
              form.querySelector("button[type='submit']").innerText = "ìƒí’ˆ ì €ì¥";
              form.querySelector(".delete-btn").style.display = "none";
          } else {
              alert("ì‚­ì œ ì‹¤íŒ¨");
          }
      });
  }

  // ë¬¸ì˜ ê´€ë¦¬ í•¨ìˆ˜
  function fetchInquiries() {
      fetch('/api/inquiries')
        .then(res => {
          if (!res.ok) throw new Error("ë¬¸ì˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
          return res.json();
        })
        .then(data => {
          const tbody = document.querySelector("#inquiryTable tbody");
          tbody.innerHTML = "";
          data.forEach((inq, index) => {
            const row = `
              <tr>
                <td>${index + 1}</td>
                <td>${inq.cstmNumber}</td>
                <td><a href="/admin/inquiry/${inq.inqNumber}">${inq.inqTitle}</a></td>
                <td>${inq.inqStatus}</td>
                <td>${new Date(inq.inqDate).toLocaleString()}</td>
              </tr>
            `;
            tbody.insertAdjacentHTML("beforeend", row);
          });
        })
        .catch(err => {
          console.error(err);
          alert(err.message);
        });
  }

  // ì˜ìˆ˜ì¦ ê´€ë¦¬ í•¨ìˆ˜
  function uploadReceipt(event) {
      event.preventDefault();
      const form = document.getElementById("receiptForm");
      const formData = new FormData(form);

      fetch('/api/receipt/upload', { method: 'POST', body: formData })
      .then(res => res.json())
      .then(data => {
          document.getElementById("ocrResult").innerText = "ğŸ“„ OCR ê²°ê³¼:\n" + data.text;
      })
      .catch(err => {
          alert("ì—…ë¡œë“œ ì‹¤íŒ¨");
          console.error(err);
      });
  }

  // --- íƒ­ ë° í†µê³„ ê´€ë ¨ ë¡œì§ ---

  // ê° í†µê³„ íƒ­ì˜ ë°ì´í„° ë¡œë“œ ì—¬ë¶€ë¥¼ ì¶”ì í•˜ëŠ” í”Œë˜ê·¸
  let goldPriceStatsLoaded = false;
  let orderTrendsLoaded = false;
  let categoryProfitLoaded = false;
  let demographicsLoaded = false;

  /**
   * ë©”ì¸ íƒ­ ì „í™˜ í•¨ìˆ˜
   */
  function showTab(tabId, event) {
      // ëª¨ë“  íƒ­ ì»¨í…ì¸ ì™€ ë²„íŠ¼ ë¹„í™œì„±í™”
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

      // í´ë¦­ëœ íƒ­ê³¼ ë²„íŠ¼ í™œì„±í™”
      document.getElementById(tabId).classList.add('active');
      event.currentTarget.classList.add('active');

      // 'í†µê³„' íƒ­ì„ ì²˜ìŒ ì—´ ë•Œ ê¸°ë³¸ í•˜ìœ„ íƒ­ ë¡œì§ ì‹¤í–‰
      if (tabId === 'statsTab') {
          // 'íŒë§¤ë‚ ì§œ ê¸°ë°˜ ì£¼ë¬¸ íŠ¸ë Œë“œ ë¶„ì„'ì„ ê¸°ë³¸ í•˜ìœ„ íƒ­ìœ¼ë¡œ ì„¤ì •
          const defaultSubTabButton = document.querySelector('.stats-subtab-btn[onclick*="orderTrends"]');
          if (defaultSubTabButton && !defaultSubTabButton.classList.contains('active')) {
              showStatsSubTab('orderTrends', { currentTarget: defaultSubTabButton });
          }
      }
  }

  /**
   * í†µê³„ í•˜ìœ„ íƒ­ ì „í™˜ í•¨ìˆ˜ (ëª¨ë“  í•˜ìœ„ íƒ­ì— ëŒ€í•´ í•œ ë²ˆì— í•˜ë‚˜ë§Œ active)
   */
  function showStatsSubTab(subTabId, event) {
      // ëª¨ë“  í•˜ìœ„ íƒ­ ë²„íŠ¼ê³¼ ì»¨í…ì¸  ë¹„í™œì„±í™”
      document.querySelectorAll('.stats-subtab-bar button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.stats-subtab-content').forEach(content => content.classList.remove('active'));

      // null ì²´í¬ ì¶”ê°€
      const subTabDiv = document.getElementById(subTabId);
      if (!subTabDiv) {
          console.error(`[showStatsSubTab] id="${subTabId}"ì¸ divê°€ ì—†ìŠµë‹ˆë‹¤.`);
          return;
      }

      // í´ë¦­ëœ í•˜ìœ„ íƒ­ ë²„íŠ¼ê³¼ ì»¨í…ì¸  í™œì„±í™”
      if (event && event.currentTarget) {
          event.currentTarget.classList.add('active');
      }
      subTabDiv.classList.add('active');

      // ê° í•˜ìœ„ íƒ­ì— ë§ëŠ” ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ë¥¼ *í•„ìš”í•  ë•Œë§Œ* í˜¸ì¶œ
      if (subTabId === 'goldPrice' && !goldPriceStatsLoaded) {
          loadGoldPriceForecast();
          goldPriceStatsLoaded = true;
      } else if (subTabId === 'orderTrends' && !orderTrendsLoaded) {
          loadOrderTrends();
          orderTrendsLoaded = true;
      } else if (subTabId === 'categoryProfit' && !categoryProfitLoaded) {
          loadCategoryProfit();
          categoryProfitLoaded = true;
      } else if (subTabId === 'demographics' && !demographicsLoaded) {
          loadDemographicsChart();
          demographicsLoaded = true;
      }
  }

  // --- ì°¨íŠ¸ ë¡œë“œ í•¨ìˆ˜ë“¤ ---

  /**
   * ê¸ˆ ì‹œì„¸ ì˜ˆì¸¡ ë°ì´í„° ë¡œë“œ ë° ê·¸ë˜í”„ ê·¸ë¦¬ê¸° í•¨ìˆ˜
   */
  function loadGoldPriceForecast() {
      const loadingMsg = document.getElementById('loadingMessage');
      const plotDivs = ['forecastPlot', 'trendPlot', 'weeklyPlot'];

      loadingMsg.style.display = 'block';
      plotDivs.forEach(id => document.getElementById(id).style.display = 'none');

      fetch('/api/statistics/gold-price-forecast')
          .then(response => {
              if (!response.ok) throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ' + response.statusText);
              return response.json();
          })
          .then(data => {
              if (data.error) throw new Error(data.error);

              loadingMsg.style.display = 'none';
              plotDivs.forEach(id => document.getElementById(id).style.display = 'block');

              // ì˜ˆì¸¡ ê·¸ë˜í”„
              const forecast = data.forecast;
              Plotly.newPlot('forecastPlot', [
                { x: forecast.ds, y: forecast.yhat_upper, mode: 'lines', line: { width: 0 }, showlegend: false },
                { x: forecast.ds, y: forecast.yhat_lower, mode: 'lines', line: { width: 0 }, fill: 'tonexty', fillcolor: 'rgba(0, 100, 255, 0.2)', showlegend: false },
                { x: forecast.ds, y: forecast.y, mode: 'markers', type: 'scatter', name: 'ì‹¤ì œ ê°€ê²©' },
                { x: forecast.ds, y: forecast.yhat, mode: 'lines', type: 'scatter', name: 'ì˜ˆì¸¡ ê°€ê²©', line: { color: 'blue' } }
              ], { title: 'í–¥í›„ 30ì¼ ê¸ˆ ì‹œì„¸ ì˜ˆì¸¡', xaxis: { title: 'ë‚ ì§œ' }, yaxis: { title: 'ê°€ê²© (ì›/g)' } });

              // íŠ¸ë Œë“œ ê·¸ë˜í”„
              const trend = data.trend;
              Plotly.newPlot('trendPlot', [{ x: trend.ds, y: trend.y, mode: 'lines', type: 'scatter', name: 'íŠ¸ë Œë“œ' }], { title: 'ì‹œì„¸ íŠ¸ë Œë“œ', xaxis: { title: 'ë‚ ì§œ' }, yaxis: { title: 'íŠ¸ë Œë“œ ê°’' } });

              // ì£¼ê°„ ê³„ì ˆì„± ê·¸ë˜í”„
              const weekly = data.weekly;
              Plotly.newPlot('weeklyPlot', [{ x: weekly.x, y: weekly.y, mode: 'lines', type: 'scatter', name: 'ì£¼ê°„ ê³„ì ˆì„±' }], { title: 'ì£¼ê°„ ê³„ì ˆì„±', xaxis: { title: 'ìš”ì¼' }, yaxis: { title: 'ê³„ì ˆì„± ì˜í–¥' } });
          })
          .catch(error => {
              console.error('Error fetching forecast data:', error);
              loadingMsg.innerText = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. \nì˜¤ë¥˜: ' + error.message;
              loadingMsg.style.color = 'red';
          });
  }

  /**
   * ìš”ì¼, ì›”ë³„ íŠ¸ë Œë“œ ë¶„ì„ ë°ì´í„° ë¡œë“œ ë° ê·¸ë˜í”„ ê·¸ë¦¬ê¸° í•¨ìˆ˜
   */
  function loadOrderTrends() {
      const loadingMsg = document.getElementById('orderTrendsLoading');
      const weeklyPlotDiv = document.getElementById('salesWeeklyPlot');
      const yearlyPlotDiv = document.getElementById('salesYearlyPlot');

      // ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ ë° ì´ì „ ì°¨íŠ¸ ë‚´ìš© ì´ˆê¸°í™”
      loadingMsg.style.display = 'block';
      weeklyPlotDiv.innerHTML = '';
      yearlyPlotDiv.innerHTML = '';

      // Java Controllerì— ì •ì˜ëœ API í˜¸ì¶œ
      fetch('/api/statistics/order-trends')
          .then(response => {
              if (!response.ok) {
                  // ì„œë²„ ì‘ë‹µì´ ì‹¤íŒ¨í•˜ë©´(ì˜ˆ: 500 ì—ëŸ¬) ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚´
                  throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ' + response.statusText);
              }
              return response.json();
          })
          .then(data => {
              // ì„œë²„ì—ì„œ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ë³´ëƒˆëŠ”ì§€ í™•ì¸ (ì»¨íŠ¸ë¡¤ëŸ¬ì˜ Map.of("error", ...))
              if (data.error) {
                  throw new Error(data.error);
              }

              // ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¹€
              loadingMsg.style.display = 'none';

              // 1. ìš”ì¼ë³„ ë§¤ì¶œ íŠ¸ë Œë“œ ê·¸ë˜í”„ (Bar Chart)
              const weeklyData = data.weekly_seasonality; // Python ê²°ê³¼ì˜ key: weekly_seasonality
              Plotly.newPlot('salesWeeklyPlot', [{
                  x: weeklyData.map(d => d.day_name),
                  y: weeklyData.map(d => d.weekly_effect),
                  type: 'bar',
                  name: 'ìš”ì¼ë³„ íš¨ê³¼',
                  marker: { color: weeklyData.map(d => d.weekly_effect > 0 ? 'crimson' : 'royalblue') }
              }], {
                  title: 'ìš”ì¼ë³„ ë§¤ì¶œ íŠ¸ë Œë“œ',
                  xaxis: { title: 'ìš”ì¼' },
                  yaxis: { title: 'ë§¤ì¶œ ì¦ê° íš¨ê³¼', tickformat: ',.0f' }
              });

              // 2. ì›”ë³„ ë§¤ì¶œ íŠ¸ë Œë“œ ê·¸ë˜í”„ (Line Chart)
              const yearlyData = data.yearly_seasonality; // Python ê²°ê³¼ì˜ key: yearly_seasonality
              Plotly.newPlot('salesYearlyPlot', [{
                  x: yearlyData.map(d => d.month_name),
                  y: yearlyData.map(d => d.yearly_effect),
                  mode: 'lines+markers',
                  type: 'scatter',
                  name: 'ì›”ë³„ íš¨ê³¼'
              }], {
                  title: 'ì›”ë³„ ë§¤ì¶œ íŠ¸ë Œë“œ',
                  xaxis: { title: 'ì›”' },
                  yaxis: { title: 'ë§¤ì¶œ ì¦ê° íš¨ê³¼', tickformat: ',.0f' }
              });
          })
          .catch(error => {
              // fetch ìš”ì²­ ì‹¤íŒ¨ ë˜ëŠ” ìœ„ì—ì„œ ë°œìƒì‹œí‚¨ ì—ëŸ¬ ì²˜ë¦¬
              console.error('Error fetching order trends data:', error);
              loadingMsg.innerText = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. \nì˜¤ë¥˜: ' + error.message;
              loadingMsg.style.color = 'red';
          });
  }

  // ... ë‹¤ë¥¸ ìŠ¤í¬ë¦½íŠ¸ í•¨ìˆ˜ë“¤ ...

  // 'í†µê³„' íƒ­ì´ ì²˜ìŒ ì—´ë¦´ ë•Œ ê¸°ë³¸ìœ¼ë¡œ 'íŒë§¤ë‚ ì§œ ê¸°ë°˜ ì£¼ë¬¸ íŠ¸ë Œë“œ ë¶„ì„'ì„ ë¡œë“œí•˜ë„ë¡ ì„¤ì •
  // showTab í•¨ìˆ˜ ë‚´ë¶€ì— ì•„ë˜ì™€ ë¹„ìŠ·í•œ ë¡œì§ì´ ì´ë¯¸ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  if (tabId === 'statsTab' && !orderTrendsLoaded) {
      // orderTrendsLoaded í”Œë˜ê·¸ë¥¼ ì‚¬ìš©í•˜ì—¬ í•œ ë²ˆë§Œ ë¡œë“œí•˜ë„ë¡ í•¨
      showStatsSubTab('orderTrends', { currentTarget: document.querySelector('.stats-subtab-btn[onclick*="orderTrends"]') });
      orderTrendsLoaded = true; // ë¡œë“œë˜ì—ˆìŒì„ í‘œì‹œ
  }

  // ì¹´í…Œê³ ë¦¬ë³„ ì´ìµë¥  ë¶„ì„ ë° ì˜ˆì¸¡ ë°ì´í„° ë¡œë“œ ë° ê·¸ë˜í”„ ê·¸ë¦¬ê¸° í•¨ìˆ˜
  function loadCategoryProfit() {
      const plotDiv = document.getElementById("categoryProfitPlot");
      const loadingDiv = document.getElementById("categoryProfitLoading");
      if (!plotDiv || !loadingDiv) {
          console.error("[categoryProfit] í•„ìš”í•œ divê°€ ì—†ìŠµë‹ˆë‹¤.");
          return;
      }
      plotDiv.style.display = "none";
      loadingDiv.style.display = "block";

      fetch('/api/statistics/category-profit')
          .then(res => res.json())
          .then(data => {
              if (!data || !data.monthly || !data.forecast) {
                  loadingDiv.innerText = "ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
                  return;
              }
              const months = data.monthly.map(item => item.Month);
              const margins = data.monthly.map(item => item.Profit_Margin);
              const forecast = data.forecast;

              loadingDiv.style.display = "none";
              plotDiv.style.display = "block";

              Plotly.newPlot("categoryProfitPlot", [
                  {
                      x: months,
                      y: margins,
                      mode: 'lines+markers',
                      name: 'ì´ìµë¥ ',
                      line: { color: 'green' }
                  },
                  {
                      x: [forecast.month],
                      y: [forecast.predicted_margin],
                      mode: 'markers+text',
                      name: 'ì˜ˆì¸¡ê°’',
                      marker: { size: 10, color: 'red' },
                      text: ['ì˜ˆì¸¡'],
                      textposition: 'top center'
                  }
              ], {
                  title: 'ì¹´í…Œê³ ë¦¬ë³„ ì´ìµë¥  ë¶„ì„ ë° 7ì›” ì˜ˆì¸¡',
                  xaxis: { title: 'ì›”' },
                  yaxis: { title: 'ì´ìµë¥ ' }
              });
          })
          .catch(err => {
              loadingDiv.innerText = "ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
              console.error('ì´ìµë¥  ë¶„ì„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', err);
          });
  }

  // ì„±ë³„/ì—°ë ¹ëŒ€ë³„ ì°¨íŠ¸ (íƒ­ í´ë¦­ ì‹œì—ë§Œ ë¡œë“œ)
  function loadDemographicsChart() {
    const loadingDiv = document.getElementById("sexAgeLoading");
    const plotDivMale = document.getElementById("genderAgeChartPlotMale");
    const plotDivFemale = document.getElementById("genderAgeChartPlotFemale");
    if (!loadingDiv || !plotDivMale || !plotDivFemale) {
      console.error("[ì„±ë³„/ì—°ë ¹ëŒ€] í•„ìš”í•œ divê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    fetch("/temp_output.json")
      .then(response => response.json())
      .then(data => {
        if (!data || !data.male || !data.female) {
          loadingDiv.innerText = "ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
          return;
        }
        const maleData = data.male;
        const femaleData = data.female;

        const ageGroups = [...new Set([...maleData, ...femaleData].map(d => d.Age_Group))];
        const categories = [...new Set([...maleData, ...femaleData].map(d => d.Category))];

        // ğŸ”¹ ë‚¨ì„± ë°ì´í„° ì‹œë¦¬ì¦ˆ ìƒì„±
        const maleSeries = categories.map(category => {
          return {
            x: ageGroups,
            y: ageGroups.map(ageGroup => {
              const item = maleData.find(d => d.Age_Group === ageGroup && d.Category === category);
              return item ? item.Total_Price : 0;
            }),
            name: `${category}`,
            type: 'bar'
          };
        });

        // ğŸ”¹ ì—¬ì„± ë°ì´í„° ì‹œë¦¬ì¦ˆ ìƒì„±
        const femaleSeries = categories.map(category => {
          return {
            x: ageGroups,
            y: ageGroups.map(ageGroup => {
              const item = femaleData.find(d => d.Age_Group === ageGroup && d.Category === category);
              return item ? item.Total_Price : 0;
            }),
            name: `${category}`,
            type: 'bar'
          };
        });

        // ğŸ”¹ ê³µí†µ ë ˆì´ì•„ì›ƒ
        const baseLayout = {
          barmode: 'group',
          xaxis: { title: 'ì—°ë ¹ëŒ€' },
          yaxis: { title: 'ì´ ë§¤ì¶œ (ì›)' },
          legend: { orientation: 'h' },
          height: 450
        };

        // ğŸ”¹ ë‚¨ì„±/ì—¬ì„± ê°ê°ì˜ ì°¨íŠ¸ë¡œ ë‚˜ë€íˆ ì¶œë ¥
        Plotly.newPlot("genderAgeChartPlotMale", maleSeries, {
          ...baseLayout,
          title: 'ğŸ‘¨ ë‚¨ì„± ì—°ë ¹ëŒ€ë³„ Â· ì¹´í…Œê³ ë¦¬ë³„ ë§¤ì¶œ'
        });
        Plotly.newPlot("genderAgeChartPlotFemale", femaleSeries, {
          ...baseLayout,
          title: 'ğŸ‘© ì—¬ì„± ì—°ë ¹ëŒ€ë³„ Â· ì¹´í…Œê³ ë¦¬ë³„ ë§¤ì¶œ'
        });

        // ğŸ”¹ ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
        loadingDiv.style.display = "none";
      })
      .catch(error => {
        loadingDiv.innerText = "ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        console.error("âŒ JSON ë¡œë”© ì˜¤ë¥˜:", error);
      });
  }
</script>

<script>
  // ê¸°ë³¸ ìƒíƒœ
  let currentPeriod = 'month';
  let showForecast = true;


  // ì°¨íŠ¸ ì´ˆê¸°í™”
  function drawSalesAnalysisChart(data) {
    const plotDiv = document.getElementById('salesForecastPlot');
    if (!plotDiv) return;

    if (!data || data.length === 0) {
      plotDiv.style.display = 'none';
      document.getElementById('orderTrendsLoading').innerText = 'ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
      return;
    }

    // ì˜ˆì‹œ ë°ì´í„° í˜•íƒœ ê°€ì •: [{date:'2025-07', sales:1000, forecast:1100}, ...]
    const x = data.map(item => item.date);
    const ySales = data.map(item => item.sales);
    const yForecast = showForecast ? data.map(item => item.forecast) : [];

    const traces = [
      {
        x,
        y: ySales,
        mode: 'lines+markers',
        name: 'ì‹¤ì œ ë§¤ì¶œ',
        line: {color: 'blue'}
      }
    ];

    if(showForecast){
      traces.push({
        x,
        y: yForecast,
        mode: 'lines+markers',
        name: 'ì˜ˆì¸¡ ë§¤ì¶œ',
        line: {color: 'red', dash: 'dot'}
      });
    }

    Plotly.newPlot(plotDiv, traces, {
      title: `ë§¤ì¶œ ë¶„ì„ (${currentPeriod} ë‹¨ìœ„)`,
      xaxis: {title: 'ê¸°ê°„'},
      yaxis: {title: 'ë§¤ì¶œì•¡'},
      margin: { t: 40, b: 50 }
    });

    plotDiv.style.display = 'block';
    document.getElementById('orderTrendsLoading').style.display = 'none';
  }

  // ê¸°ê°„ ë³€ê²½ ì´ë²¤íŠ¸
  document.querySelectorAll('input[name="period"]').forEach(radio => {
    radio.addEventListener('change', e => {
      currentPeriod = e.target.value;
      fetchAndDrawChart();
    });
  });

  // ì˜ˆì¸¡ í‘œì‹œ on/off ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
  document.getElementById('toggleForecast').addEventListener('change', e => {
    showForecast = e.target.checked;
    fetchAndDrawChart();
  });

  // ì„œë²„ì—ì„œ ë°ì´í„° ë°›ì•„ì™€ì„œ ì°¨íŠ¸ ê·¸ë¦¬ê¸° (ì˜ˆ: /api/sales-analysis?period=month)
  function fetchAndDrawChart(){
    const loadingDiv = document.getElementById('orderTrendsLoading');
    const plotDiv = document.getElementById('salesForecastPlot');

    loadingDiv.style.display = 'block';
    loadingDiv.innerText = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...';
    plotDiv.style.display = 'none';

    fetch(`/api/sales-analysis?period=${currentPeriod}`)
      .then(res => res.json())
      .then(data => {
        if(!data || data.length === 0){
          loadingDiv.innerText = 'ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
          plotDiv.style.display = 'none';
          return;
        }
        drawSalesAnalysisChart(data);
      })
      .catch(err => {
        loadingDiv.innerText = 'ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        console.error(err);
      });
  }

  // ì´ˆê¸° ì‹¤í–‰
  fetchAndDrawChart();
</script>


<script> // ì˜ì—…ì´ìµë¥  ì°¨íŠ¸
    let categoryProfitLoaded = false;
>>>>>>> Stashed changes

    // ì°¨íŠ¸ ì´ˆê¸°í™”
    function drawSalesAnalysisChart(data) {
      const plotDiv = document.getElementById('salesForecastPlot');
      if (!plotDiv) return;

      if (!data || data.length === 0) {
        plotDiv.style.display = 'none';
        document.getElementById('orderTrendsLoading').innerText = 'ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
        return;
      }

      // ì˜ˆì‹œ ë°ì´í„° í˜•íƒœ ê°€ì •: [{date:'2025-07', sales:1000, forecast:1100}, ...]
      const x = data.map(item => item.date);
      const ySales = data.map(item => item.sales);
      const yForecast = showForecast ? data.map(item => item.forecast) : [];

      const traces = [
        {
          x,
          y: ySales,
          mode: 'lines+markers',
          name: 'ì‹¤ì œ ë§¤ì¶œ',
          line: {color: 'blue'}
        }
      ];

      if(showForecast){
        traces.push({
          x,
          y: yForecast,
          mode: 'lines+markers',
          name: 'ì˜ˆì¸¡ ë§¤ì¶œ',
          line: {color: 'red', dash: 'dot'}
        });
      }

      Plotly.newPlot(plotDiv, traces, {
        title: `ë§¤ì¶œ ë¶„ì„ (${currentPeriod} ë‹¨ìœ„)`,
        xaxis: {title: 'ê¸°ê°„'},
        yaxis: {title: 'ë§¤ì¶œì•¡'},
        margin: { t: 40, b: 50 }
      });

      plotDiv.style.display = 'block';
      document.getElementById('orderTrendsLoading').style.display = 'none';
    }

    // ê¸°ê°„ ë³€ê²½ ì´ë²¤íŠ¸
    document.querySelectorAll('input[name="period"]').forEach(radio => {
      radio.addEventListener('change', e => {
        currentPeriod = e.target.value;
        fetchAndDrawChart();
      });
    });

    // ì˜ˆì¸¡ í‘œì‹œ on/off ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
    document.getElementById('toggleForecast').addEventListener('change', e => {
      showForecast = e.target.checked;
      fetchAndDrawChart();
    });

    // ì„œë²„ì—ì„œ ë°ì´í„° ë°›ì•„ì™€ì„œ ì°¨íŠ¸ ê·¸ë¦¬ê¸° (ì˜ˆ: /api/sales-analysis?period=month)
    function fetchAndDrawChart(){
      const loadingDiv = document.getElementById('orderTrendsLoading');
      const plotDiv = document.getElementById('salesForecastPlot');

      loadingDiv.style.display = 'block';
      loadingDiv.innerText = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...';
      plotDiv.style.display = 'none';

      fetch(`/api/sales-analysis?period=${currentPeriod}`)
        .then(res => res.json())
        .then(data => {
          if(!data || data.length === 0){
            loadingDiv.innerText = 'ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
            plotDiv.style.display = 'none';
            return;
          }
          drawSalesAnalysisChart(data);
        })
        .catch(err => {
          loadingDiv.innerText = 'ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
          console.error(err);
        });
    }

    // ì´ˆê¸° ì‹¤í–‰
    fetchAndDrawChart();
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  let salesChartInstance = null;

/**
 * ì„œë²„ì—ì„œ ë§¤ì¶œ ë¶„ì„ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ ì°¨íŠ¸ë¥¼ ê·¸ë¦¬ëŠ” ë©”ì¸ í•¨ìˆ˜
 * (HTMLì˜ onchange ì´ë²¤íŠ¸ê°€ ì´ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤)
 */
function loadSalesAnalysis() {
  const unit = document.getElementById('unit').value;
  const showForecast = document.getElementById('toggleForecast').checked;
  const loadingDiv = document.getElementById('salesAnalysisLoading');
  const chartCanvas = document.getElementById('salesChart');

  // [ìˆ˜ì •] 'ì—°' ë‹¨ìœ„ì¼ ë•Œ ì²´í¬ë°•ìŠ¤ë¥¼ ë¹„í™œì„±í™”í•˜ëŠ” ë¡œì§ì„ ì œê±°í•©ë‹ˆë‹¤.
  // ì´ì œ ëª¨ë“  ë‹¨ìœ„ì—ì„œ ì˜ˆì¸¡ ì²´í¬ë°•ìŠ¤ë¥¼ ì‚¬ìš©ìê°€ ì§ì ‘ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  document.getElementById('toggleForecast').disabled = false;

  // [ìˆ˜ì •] API ìš”ì²­ ì‹œ í•­ìƒ ì²´í¬ë°•ìŠ¤ì˜ í˜„ì¬ ìƒíƒœë¥¼ ì¡´ì¤‘í•˜ì—¬ predict íŒŒë¼ë¯¸í„°ë¥¼ ë³´ëƒ…ë‹ˆë‹¤.
  const predictParam = showForecast;

  loadingDiv.style.display = 'block';
  chartCanvas.style.display = 'none';

  // API í˜¸ì¶œ
  fetch(`/api/statistics/sales-analysis?unit=${unit}&predict=${predictParam}`)
    .then(res => {
      if (!res.ok) throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (${res.status})`);
      return res.text().then(text => JSON.parse(text));
    })
    .then(data => {
      if (data.error) throw new Error(data.error);

      loadingDiv.style.display = 'none';
      chartCanvas.style.display = 'block';

      drawSalesChart(data); // ìˆ˜ì‹ ëœ ë°ì´í„°ë¡œ ì°¨íŠ¸ë¥¼ ê·¸ë¦½ë‹ˆë‹¤.
    })
    .catch(err => {
      loadingDiv.style.display = 'block';
      loadingDiv.innerText = `ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ${err.message}`;
      loadingDiv.style.color = 'red';
      console.error('ë§¤ì¶œ ë¶„ì„ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', err);
    });
}

/**
 * ë°ì´í„°ë¥¼ ë°›ì•„ Chart.js ì°¨íŠ¸ë¥¼ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
 * @param {Array} data - ë°±ì—”ë“œì—ì„œ ë°›ì€ ë°ì´í„° ë°°ì—´ (e.g., [{ds, y, yhat}, ...])
 */
function drawSalesChart(data) {
  const showForecast = document.getElementById('toggleForecast').checked;
  const unit = document.getElementById('unit').value;

  // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ ì™„ì „íˆ íŒŒê´´í•˜ì—¬ ì¤‘ì²© ì˜¤ë¥˜ ë°©ì§€
  if (salesChartInstance) {
    salesChartInstance.destroy();
  }

  // 1. ì°¨íŠ¸ì— ë§ê²Œ ë°ì´í„° ê°€ê³µ
  const labels = data.map(d => d.ds);
  const actualData = data.map(d => d.y);
  // ì˜ˆì¸¡ ë°ì´í„°ëŠ” yhat ê°’ì´ ìˆì„ ë•Œë§Œ ê°’ì„ ë„£ê³ , ë‚˜ë¨¸ì§€ëŠ” nullë¡œ ì±„ì›Œ ì„ ì´ ëŠì–´ì§€ê²Œ í•¨
  const forecastData = data.map(d => (d.yhat !== undefined && d.yhat !== null) ? d.yhat : null);

  // 2. ì°¨íŠ¸ ë°ì´í„°ì…‹ êµ¬ì„±
  const datasets = [
    {
      label: "ì‹¤ì œ ë§¤ì¶œ",
      data: actualData,
      borderColor: "rgba(54, 162, 235, 1)",
      backgroundColor: "rgba(54, 162, 235, 0.5)",
      type: 'bar', // ì‹¤ì œ ë§¤ì¶œì€ ë§‰ëŒ€ ê·¸ë˜í”„
      order: 2     // ë§‰ëŒ€ ê·¸ë˜í”„ë¥¼ ë’¤ì— ë°°ì¹˜
    },
  ];

  // 'ì˜ˆì¸¡ê°’ í‘œì‹œ'ê°€ ì¼œì ¸ ìˆê³ , ì˜ˆì¸¡ ë°ì´í„°ê°€ ì‹¤ì œë¡œ ì¡´ì¬í•  ë•Œë§Œ ë°ì´í„°ì…‹ì„ ì¶”ê°€
  if (showForecast && forecastData.some(d => d !== null)) {
    datasets.push({
      label: "ì˜ˆì¸¡ ë§¤ì¶œ",
      data: forecastData,
      borderColor: "rgba(255, 99, 132, 1)",
      backgroundColor: "rgba(255, 99, 132, 0)", // ì„  ê·¸ë˜í”„ì˜ ë°°ê²½ì€ íˆ¬ëª…í•˜ê²Œ
      type: 'line', // ì˜ˆì¸¡ ë§¤ì¶œì€ ì„  ê·¸ë˜í”„
      fill: false,
      tension: 0.1, // ì„ ì„ ì•½ê°„ ë¶€ë“œëŸ½ê²Œ
      order: 1      // ì„  ê·¸ë˜í”„ë¥¼ ì•ì— ë°°ì¹˜
    });
  }

  // 3. ì°¨íŠ¸ ìƒì„±
  const ctx = document.getElementById('salesChart').getContext('2d');
  salesChartInstance = new Chart(ctx, {
    type: 'bar', // ê¸°ë³¸ íƒ€ì…ì€ bar, ë°ì´í„°ì…‹ì—ì„œ ê°œë³„ íƒ€ì… ì§€ì •
    data: {
      labels: labels,
      datasets: datasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            // yì¶• ë‹¨ìœ„ë¥¼ 'ì›'ìœ¼ë¡œ í‘œì‹œ
            callback: function(value) { return value.toLocaleString() + 'ì›'; }
          }
        }
      },
      plugins: {
        tooltip: {
          mode: 'index',
          intersect: false
        },
        title: {
          display: true,
          font: { size: 16 },
          text: `ë§¤ì¶œ ë¶„ì„ ë° ì˜ˆì¸¡ (${{year:'ì—°',month:'ì›”',week:'ì£¼',day:'ì¼'}[unit]} ë‹¨ìœ„)`
        }
      }
    }
  });
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë˜ëŠ” íƒ­ í´ë¦­ ì‹œ ìµœì´ˆ í•œ ë²ˆ ì°¨íŠ¸ë¥¼ ë¡œë“œí•´ì£¼ëŠ” ë¡œì§ì´ í•„ìš”í•©ë‹ˆë‹¤.
// ì˜ˆ: DOMContentLoaded ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë‚´ì—ì„œ loadSalesAnalysis(); í˜¸ì¶œ
document.addEventListener('DOMContentLoaded', () => {
    // ë‹¤ë¥¸ ì´ˆê¸°í™” ë¡œì§...

    // ë§¤ì¶œ ë¶„ì„ íƒ­ì´ í™œì„±í™” ìƒíƒœì¼ ë•Œ ê¸°ë³¸ ì°¨íŠ¸ ë¡œë“œ
    if(document.getElementById('salesAnalysis').classList.contains('active')){
        loadSalesAnalysis();
    }
});
</script>



<script>//ì„±ë³„ ì—°ë ¹ë³„ ë¶„ì„
    document.addEventListener("DOMContentLoaded", function () {
      const loadingDiv = document.getElementById("sexAgeLoading");
      const plotDivMale = document.getElementById("genderAgeChartPlotMale");
      const plotDivFemale = document.getElementById("genderAgeChartPlotFemale");
      if (!loadingDiv || !plotDivMale || !plotDivFemale) {
        console.error("[\uC131\uBCC4/\uC5F0\uB839\uB300] \uD544\uC694\uD55C div\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4.");
        return;
      }
      fetch("/temp_output.json")
        .then(response => response.json())
        .then(data => {
          if (!data || !data.male || !data.female) {
            loadingDiv.innerText = "\uB370\uC774\uD130\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4.";
            return;
          }
          const maleData = data.male;
          const femaleData = data.female;

          const ageGroups = [...new Set([...maleData, ...femaleData].map(d => d.Age_Group))];
          const categories = [...new Set([...maleData, ...femaleData].map(d => d.Category))];

          // íŠ¹ì • div ì—¬ë¶€ í™•ì¸ (ì´ ë¶€ë¶„ í•´ê²° ìˆ˜ì •)
          const plotDiv = document.getElementById("categoryProfitPlot");

          // í˜¸ì¶œ ìœ„í•´ plotDiv ë¹„ì‹œ ë³´ì´ê²Œ
          if (plotDiv) {
            plotDiv.style.display = "block";
          }

          // í• ë‹¹ ë°ì´í„° ì œì¡°
          const maleSeries = categories.map(category => {
            return {
              x: ageGroups,
              y: ageGroups.map(ageGroup => {
                const item = maleData.find(d => d.Age_Group === ageGroup && d.Category === category);
                return item ? item.Total_Price : 0;
              }),
              name: `${category}`,
              type: 'bar'
            };
          });

          const femaleSeries = categories.map(category => {
            return {
              x: ageGroups,
              y: ageGroups.map(ageGroup => {
                const item = femaleData.find(d => d.Age_Group === ageGroup && d.Category === category);
                return item ? item.Total_Price : 0;
              }),
              name: `${category}`,
              type: 'bar'
            };
          });

          const baseLayout = {
            barmode: 'group',
            xaxis: { title: 'ì—°ë ¹ëŒ€' },
            yaxis: { title: 'ì´ ë§¤ì¶œ (ì›)' },
            legend: { orientation: 'h' },
            height: 450
          };

          Plotly.newPlot("genderAgeChartPlotMale", maleSeries, {
            ...baseLayout,
            title: 'ğŸ‘¨ ë‚¨ì„± ì—°ë ¹ëŒ€ë³„ Â· ì¹´í…Œê³ ë¦¬ë³„ ë§¤ì¶œ'
          });
          Plotly.newPlot("genderAgeChartPlotFemale", femaleSeries, {
            ...baseLayout,
            title: 'ğŸ‘© ì—¬ì„± ì—°ë ¹ëŒ€ë³„ Â· ì¹´í…Œê³ ë¦¬ë³„ ë§¤ì¶œ'
          });

          loadingDiv.style.display = "none";
        })
        .catch(error => {
          loadingDiv.innerText = "ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
          console.error("âŒ JSON ë¡œë”© ì˜¤ë¥˜:", error);
        });
    });
</script>



</body>

</html>